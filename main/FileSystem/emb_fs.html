<!-- HTML header for doxygen 1.9.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>File System Component: Embedded File System (EFS)</title>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="tabs.js"></script>
<script type="text/javascript" src="footer.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="URL_keys.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<script type="text/javascript" src="darkmode_toggle.js"></script>
<link href="extra_stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="extra_navtree.css" rel="stylesheet" type="text/css"/>
<link href="extra_search.css" rel="stylesheet" type="text/css"/>
<link href="extra_tabs.css" rel="stylesheet" type="text/css"/>
<link href="version.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../version.js"></script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 55px;">
  <td id="projectlogo" style="padding: 1.5em;"><img alt="Logo" src="armkeil_white_h.png"/></td>
  <td style="padding-left: 1em; padding-bottom: 1em;padding-top: 1em;">
   <div id="projectname">File System Component
   &#160;<span id="projectnumber"><script type="text/javascript">
     <!--
     writeHeader.call(this);
     writeVersionDropdown.call(this, "File System Component");
     //-->
    </script>
   </span>
   </div>
   <div id="projectbrief">MDK Middleware for Devices with Flash File System</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
  <!--END !PROJECT_NAME-->
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<div id="CMSISnav" class="tabs1">
  <ul class="tablist">
    <script type="text/javascript">
      writeComponentTabs.call(this);
    </script>
  </ul>
</div>
<script type="text/javascript">
  writeSubComponentTabs.call(this);
</script>
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('emb_fs.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Embedded File System (EFS) </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The <b>Embedded File System (EFS)</b> is a proprietary file system used on NOR flash devices. Basic features are:</p><ul>
<li><a class="el" href="emb_fs.html#efs_mem_org">Memory Organization</a> of the flash device is optimized for maximum performance.</li>
<li><a class="el" href="emb_fs.html#efs_alloc_info">Allocation Information</a> is reduced to a minimum, allowing small data overhead.</li>
<li><a class="el" href="emb_fs.html#efs_file_content">File Names &amp; Content</a> are stored in fragments of variable size which provide optimal file access times.</li>
</ul>
<h1><a class="anchor" id="efs_mem_org"></a>
Memory Organization</h1>
<p>A NOR flash device memory array is physically divided into <b>sectors</b> or <b>blocks</b>. The File System Component designates them as <b>blocks</b>. Typically, a block's size is 64 kB which is also the smallest erasable unit. Blocks can be further divided, down to memory cells. The memory cell size depends on the device architecture and is 8- (byte), 16- (half word) or 32-bit wide (word). The memory cell architecture also defines smallest programmable unit, which must be maximum 32-bit for use with the Embedded File System.</p>
<p>Embedded File System organizes each block into three regions:</p><ul>
<li><a class="el" href="emb_fs.html#efs_alloc_info">Allocation Information</a>, located on top of the block, grows in descending order and contains file allocation records.</li>
<li><b>Free Space</b></li>
<li><a class="el" href="emb_fs.html#efs_file_content">File Names &amp; Content</a>, located on bottom of the block, grows in ascending order and contains file names and data.</li>
</ul>
<div class="image">
<img src="fs_memoryorg.png" alt=""/>
<div class="caption">
Flash Memory Organization</div></div>
<h1><a class="anchor" id="efs_alloc_info"></a>
Allocation Information</h1>
<p>Allocation information region is located on top of a block and describes the block's content. It consists of block signature and file allocation information records, which are written in descending order. Each file has at least one record associated with it. Multiple records belong to files with content and to fragmented files. A file is fragmented when it is modified or its content size exceeds a single block size and must be stored across several blocks. Several small files are stored into a single block.</p>
<p> <style>div.image img[src="fs_allocinfo.png"]{width:400px;}</style>  </p><div class="image">
<img src="fs_allocinfo.png" alt=""/>
<div class="caption">
Flash Block Allocation</div></div>
<h2><a class="anchor" id="autotoc_md15"></a>
Block Signature</h2>
<p>Each block contains a signature, consisting of 4 bytes and determines if block is:</p><ul>
<li><b>empty</b> i.e. erased</li>
<li><b>used</b> but more data can be written into it</li>
<li><b>used</b> temporarily during defragmentation</li>
<li><b>full</b> and cannot be written anymore (only erased)</li>
</ul>
<h2><a class="anchor" id="autotoc_md16"></a>
Allocation Information Record</h2>
<p>The file allocation information record consists of 8 bytes and has the following components:</p><ul>
<li><b>end</b> is the end address of the file fragment.</li>
<li><b>fileID</b> is the file identification number and is associated with the file name.</li>
<li><b>index</b> is the file fragment ordering number, which starts at 0 for each file.</li>
</ul>
<div class="fragment"><div class="line"><span class="keyword">struct </span>falloc {</div>
<div class="line">  uint32_t end;</div>
<div class="line">  uint16_t fileID;</div>
<div class="line">  uint16_t index;</div>
<div class="line">};</div>
</div><!-- fragment --><p>The file allocation information is written when:</p><ul>
<li>The file is opened for writing.</li>
<li>The file is closed.</li>
<li>The file is flushed and file fragment is not yet defined by the allocation information record.</li>
<li>The block is full and there is no more free space.</li>
</ul>
<h1><a class="anchor" id="efs_file_content"></a>
File Names &amp; Content</h1>
<p>The file names &amp; content region is located at the bottom of a block and is fully defined through the file allocation information records. It consists of file names and file content, which can both be fragmented. The first file fragment always starts at the beginning of a block (at offset 0) and is written in ascending order.</p>
<h2><a class="anchor" id="autotoc_md17"></a>
File Names</h2>
<p>In the Embedded File System, a file name consists of maximum 31 characters. Directories are not supported, therefore any file name which contains a directory separator character, such as slash (/) or backslash(\), is rejected as invalid. Other characters are allowed.</p>
<h2><a class="anchor" id="autotoc_md18"></a>
File Content</h2>
<p>Since file fragments are of variable size, <b>create big file fragments</b> in order to reduce the total number of file fragments and make the best use of a block. Writing or appending small amounts of data to a file is not optimal, since such an approach creates a large number of allocation information records. They consume free space and the required processing time results in a slow file access time.</p>
<p>When the file content is modified, the old file content is invalidated and a new file fragment is allocated. a block is erased when all the data stored within has been invalidated.</p>
<h1><a class="anchor" id="efs_limits"></a>
Limitations</h1>
<p>The following restrictions are applicable to the EFS:</p><ul>
<li>Maximum file name length is limited to 31 characters.</li>
<li>Minimum block size should be 512 bytes or more.</li>
<li>Directories or folders are not supported.</li>
<li>Multiple active file handles per file are allowed only for files opened in read mode.</li>
<li>Seeking (<a class="el" href="group__stdio__routines.html#ga800ee8381f5cce368abe5df835aa107c">fseek</a>) within files works only for files opened in read mode.</li>
<li>File update modes (r+, w+, a+) (<a class="el" href="group__stdio__routines.html#ga76a21223ed39a2692fdfc854aab93b2c">fopen</a>) are not supported.</li>
<li>Timestamp information is not supported for a file.</li>
<li>Drive partitions are not supported.</li>
<li>The EFS is not compatible with the FAT file system and cannot be used with a USB mass storage device. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
      <script type="text/javascript">
        <!--
        writeFooter.call(this);
        //-->
      </script> 
    </li>
  </ul>
</div>
</body>
</html>
