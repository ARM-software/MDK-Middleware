<!-- HTML header for doxygen 1.9.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>USB Component: USB Host</title>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="tabs.js"></script>
<script type="text/javascript" src="footer.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="URL_keys.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<script type="text/javascript" src="darkmode_toggle.js"></script>
<link href="extra_stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="extra_navtree.css" rel="stylesheet" type="text/css"/>
<link href="extra_search.css" rel="stylesheet" type="text/css"/>
<link href="extra_tabs.css" rel="stylesheet" type="text/css"/>
<link href="version.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../version.js"></script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 55px;">
  <td id="projectlogo" style="padding: 1.5em;"><img alt="Logo" src="armkeil_white_h.png"/></td>
  <td style="padding-left: 1em; padding-bottom: 1em;padding-top: 1em;">
   <div id="projectname">USB Component
   &#160;<span id="projectnumber"><script type="text/javascript">
     <!--
     writeHeader.call(this);
     writeVersionDropdown.call(this, "USB Component");
     //-->
    </script>
   </span>
   </div>
   <div id="projectbrief">MDK Middleware for USB Device and Host Communication</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
  <!--END !PROJECT_NAME-->
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<div id="CMSISnav" class="tabs1">
  <ul class="tablist">
    <script type="text/javascript">
      writeComponentTabs.call(this);
    </script>
  </ul>
</div>
<script type="text/javascript">
  writeSubComponentTabs.call(this);
</script>
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('USB_Host.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">USB Host </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_src_usb_host"></a> This chapter describes the software structure of the USB Host Component and explains its use for creating an USB Host application.</p>
<p>The USB Host Component simplifies software development of microcontroller systems that allow to connect USB Devices. The attributes of the USB Host Component are:</p>
<ul>
<li>Complies with the USB 2.0 specification.</li>
<li>Support for <a class="el" href="USB_Classes.html#HID">HID</a>, <a class="el" href="USB_Classes.html#MSC">MSC</a>, <a class="el" href="USB_Classes.html#CDC">CDC</a>, and <a class="el" href="USB_Classes.html#CustomClass">Custom</a> USB Device Classes to be connected to the USB Host.</li>
<li>Support for <a class="el" href="USB_Concepts.html#USB_Control_Transfers">control</a>, <a class="el" href="USB_Concepts.html#USB_Interrupt_Transfers">interrupt</a> and <a class="el" href="USB_Concepts.html#USB_Bulk_Transfers">bulk</a> transfer types.</li>
</ul>
<h1><a class="anchor" id="usbh_rte_components"></a>
RTE Components</h1>
<p>The following picture shows the relationships of the RTE Components with the microcontroller's USB Host peripheral (USB Controller). RTE Components provide configuration files and user code templates. <b>Configuration files</b> configure the RTE Components, hardware interfaces, memory resources and USB Host parameters. <b>User code templates</b> provide the skeleton for implementing support for different USB Device classes.</p>
<div class="image">
<img src="usb_host_blocks_config_files.png" alt=""/>
<div class="caption">
USB Host Structure</div></div>
    <h1><a class="anchor" id="Create_a_USB_Host_Application"></a>
Create an Application</h1>
<p>The steps to create a microcontroller application that functions as an USB Host are:</p>
<ol type="1">
<li>Select <a class="el" href="USB_Host.html#RTE_Software_Component_Selection_USBH">RTE Components</a> that are required for your application.</li>
<li><a class="el" href="USB_Host.html#USB_Driver_Configuration_USBH">Enable and configure the USB Host Driver</a>.</li>
<li>Configure the <a class="el" href="USB_Host.html#USB_Host_Configuration_USBH">USB Host</a> that connects the USB Middleware to the microcontroller USB peripheral.</li>
<li>Configure the <a class="el" href="USB_Host.html#usbh_system_resources">System Resources</a> according to the USB Host component's <a class="el" href="usb_resource_requirements.html#usbh_res_req">Resource Requirements</a>.</li>
<li>Configure the parameters of the attached <a class="el" href="USB_Host.html#USB_Device_Class_Configuration_USBH">USB Devices</a>.</li>
<li>Implement the <a class="el" href="USB_Host.html#USBH_User_Code_Implementation">Application Code</a> using code templates that are provided to support various USB Device Classes.</li>
<li><a class="el" href="USB_Host.html#usbh_debugging">Debug</a> you application using the built-in mechanisms of the USB Component.</li>
</ol>
<h2><a class="anchor" id="RTE_Software_Component_Selection_USBH"></a>
RTE Component Selection</h2>
<p>The RTE Component selection is done in a few steps:</p>
<ol type="1">
<li>From the USB Component:<ul>
<li>Select <b>USB:CORE</b> that provides the basic functionality required for USB communication.</li>
<li>Set <b>USB:Host</b> to '1'. This creates one USB Host for communication with attached USB Devices.</li>
<li>Select the desired support for USB Classes (HID/MSC/CDC/Custom Class). For example, select <b>USB:Host:HID</b> to support HID Class Devices only.</li>
</ul>
</li>
<li>From the Drivers Component:<ul>
<li>Select an appropriate USB Host driver suitable for your application.</li>
</ul>
</li>
<li>From the Device Component:<ul>
<li>Additional device specific drivers may be required according to the validation output.</li>
</ul>
</li>
<li>From the CMSIS Component:<ul>
<li>Select the <b>CMSIS:CORE</b> to provide the core interface to the processor.</li>
<li>Select a suitable <b>CMSIS:RTOS2</b> that is a required for the application.</li>
</ul>
</li>
</ol>
<div class="image">
<img src="USBH_RTE.png" alt=""/>
<div class="caption">
RTE Component Selection</div></div>
    <h2><a class="anchor" id="USB_Driver_Configuration_USBH"></a>
USB Driver and Controller</h2>
<p>The USB Host Driver and the USB Controller of the microcontroller need to be correctly configured. In particular this means:</p>
<ul>
<li>The USB Host Driver selected under the Drivers Component is typically configured with a driver specific configuration header file. Some microcontrollers may require settings that related to a physical layer interface (<b>PHY</b>), the USB <b>VBUS</b> power and <b>Overcurrent</b> protection.</li>
<li>The USB Controller of the microcontroller needs typically specific clock settings. Consult the user's guide of the microcontroller to understand the requirements. Alternatively you may copy the setup of an USB Host example that is provided for various evaluation boards.</li>
</ul>
<h2><a class="anchor" id="USB_Host_Configuration_USBH"></a>
USB Host Configuration</h2>
<p>The <b>USBH_Config_n.h</b> file contains additional settings for the specific USB Host:</p>
<ul>
<li>The <b>Driver_USBH#</b> is set according to the selected USB Controller. For device with single USB Host Controller it will typically be '0'.</li>
<li><b>Power Consumption</b> can be configured according to hardware capability of the USB Host Controller.</li>
<li><b>Maximum Pipes</b> can be specified according to expected USB Device classes that are expected to be used by the USB Host.</li>
<li><b>Memory Pool</b> parameters can be configured that are necessary for USB Host operation. This memory pool can also be located to specific memory via the linker script.</li>
</ul>
<p>Refer to <a class="el" href="group__usbh__coreFunctions__conf.html">Configuration</a> for a detailed list of all available settings.</p>
<h2><a class="anchor" id="usbh_system_resources"></a>
System Resource Configuration</h2>
<p>For proper operation, the USB Host Component requires some system configuration settings. The requirements are:</p>
<ul>
<li>Additional <b>main stack size</b> of <b>512 bytes</b>.</li>
<li>The USB Host Component uses CMSIS-RTOS2 threads. In case <b>RTX v5</b> is used <b>no changes to RTX settings</b> are necessary as all resources are allocated statically.</li>
</ul>
<p>For more information, check the USB Host component's <a class="el" href="usb_resource_requirements.html#usbh_res_req">Resource Requirements</a> section.</p>
<h2><a class="anchor" id="USB_Device_Class_Configuration_USBH"></a>
Configuration of Attachable USB Devices</h2>
<p>In the <code>USBH_Config_HID.h</code>, <code>USBH_Config_MSC.h</code>, <code>USBH_Config_CDC.h</code>, or <code>USBH_Config_CustomClass.h</code> you can specify the number of concurrent USB Devices that the USB Host will support. This has an impact on the amount of memory that will be reserved in your application for the attachment of USB Devices. The <a class="el" href="USB_Host.html#USB_Host_Tutorial">Examples</a> shows how to configure an USB Host to interact with different HID, MSC or CDC peripheral devices.</p>
<h2><a class="anchor" id="USBH_User_Code_Implementation"></a>
User Code Implementation</h2>
<p> <script>link_ext('uv4_ca_sourcefiles');</script> files provide function templates to support various USB Device Classes on the USB Host. The available functions are explained in the <a class="el" href="group__usbh__DevClassFunctions.html">Reference</a> section of the USB Host Component. These routines can be adapted to the needs of the microcontroller application, in case different then default functionality is needed.</p>
<p>The following templates are available for the USB Host component:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Template Name   </th><th class="markdownTableHeadNone">Purpose    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">USBH_MSC.c   </td><td class="markdownTableBodyNone">Required functions to support MSC devices. The template can be found <a class="el" href="group__usbh__mscFunctions.html#USBH_MSC_UCT">here</a>.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">USBH_PL2303.c   </td><td class="markdownTableBodyNone">Required functions to support the <a href="https://www.prolific.com.tw/US/index.aspx">Prolific PL2303</a> USB to serial RS232 adapter. The template can be found <a class="el" href="group__usbh__customFunctions.html#USBH_PL2303_UCT">here</a>.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">USBH_User_CustomClass.c   </td><td class="markdownTableBodyNone">Required functions to support any USB Device class. The template can be found <a class="el" href="group__usbh__customFunctions.html#USBH_Cust_UCT">here</a>.   </td></tr>
</table>
<h2><a class="anchor" id="usbh_debugging"></a>
Debugging</h2>
<p>USB Host Component is distributed in a source form and it allows direct code debug. Also debug events are available (via Event Recorder) which provide non-intrusive debugging during runtime.</p>
<p><code>USB_Debug.h</code> configuration file is used to configure the level of debug events.</p>
<p>The <a class="el" href="group__usbh__evr.html">USB Host:Debug Events</a> describes the events implemented in the USB Device Component.</p>
<h3><a class="anchor" id="usbHostEvrSupport"></a>
Event Recorder Support</h3>
<p> <script>link_ext('Event-Recorder-About');</script> is a powerful tool that provides visibility to the dynamic execution of the program.</p>
<p>The USB Host Component generates <a class="el" href="group__usbh__evr.html">a broad set of Debug Events</a> for the Event Recorder and implements required infrastructure to interface with it.</p>
<p>To use the Event Recorder it is required to create an image with event generation support. The necessary steps are:</p>
<ol type="1">
<li> <script>link_ext('Event-Recorder-Enable');</script>: in the RTE management dialog enable the software component <b>CMSIS-View:Event Recorder</b>.</li>
<li>Ensure that Event Recorder is initialized preferably by  <script>link_ext('RTX5-Event-Recorder-Config');</script> if CMSIS-RTOS2 RTX v5 is used, or alternatively by calling the function  <script>link_ext('Event-Recorder-Initialize-Func');</script> in the application code.</li>
<li><a class="el" href="USB_Host.html#usbHostEvrConfig">Event Recorder Configuration</a>: if necessary, adjust default Event Recorder configuration.</li>
<li>Build the application code, download it to the target hardware and start debug session.</li>
</ol>
<p>Now, when the USB Host generates event information, it can be viewed in the  <script>link_ext('uv4-Event-Recorder');</script>.</p>
<h3><a class="anchor" id="usbHostEvrConfig"></a>
Event Recorder Configuration</h3>
<p>This section describes the configuration settings for the Event Recorder; refer to <a class="el" href="USB_Host.html#usbHostEvrSupport">Event Recorder Support</a> for more information.</p>
<p><b>USB Event Generation Configuration</b></p>
<p>Selecting the <b>USB:CORE</b> will add the file <code>USB_Debug.h</code> to your project. Use this file to set the event generation configuration for USB core, drivers, and device classes separately. The file is common for USB Device and Host components.</p>
<div class="image">
<img src="USBH_USB_Debug_h.png" alt=""/>
<div class="caption">
USB_Debug.h file for event generation configuration</div></div>
    <p>The following settings are available for event generation configuration of each module:</p>
<ul>
<li><b>Off</b> means no events will be generated by the module</li>
<li><b>Errors</b> means only error events will be generated by the module</li>
<li><b>Errors + API</b> means error and API call events will be generated by the module</li>
<li><b>All</b> means all available events will be generated by the module. Besides error and API call events, this contains operation and detailed events.</li>
</ul>
<h3><a class="anchor" id="autotoc_md58"></a>
Event IDs</h3>
<p>The USB Host component uses the following event IDs:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Component   </th><th class="markdownTableHeadNone">Event ID    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">USBH_Core   </td><td class="markdownTableBodyNone">0xB0    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">USBH_Driver   </td><td class="markdownTableBodyNone">0xB1    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">USBH_CC   </td><td class="markdownTableBodyNone">0xB2    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">USBH_CDC   </td><td class="markdownTableBodyNone">0xB3    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">USBH_HID   </td><td class="markdownTableBodyNone">0xB4    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">USBH_MSC   </td><td class="markdownTableBodyNone">0xB5   </td></tr>
</table>
<h1><a class="anchor" id="USB_Host_Tutorial"></a>
Examples</h1>
<p>MDK Professional contains multiple example projects that show how to implement an USB Host. The following examples are available for most of the development boards:</p>
<ul>
<li>The <a class="el" href="USB_Host.html#host_hid_tutorial">USB Host Keyboard</a> example shows how to interact with an USB keyboard from a microcontroller.</li>
<li>The <a class="el" href="USB_Host.html#host_msc_tutorial">USB Host Mass Storage</a> example shows how to access an USB memory stick from a microcontroller.</li>
<li>The <a class="el" href="USB_Host.html#host_cdc_tutorial">USB Host CDC ACM</a> example shows how to communicate with an USB CDC Device from a microcontroller.</li>
<li>The <a class="el" href="USB_Host.html#host_cust_tutorial">USB Host Custom Class</a> example shows how to communicate with any USB Device from a microcontroller. Here, it will be demonstrated using a USB to serial RS232 adapter with <a href="https://www.prolific.com.tw/US/index.aspx">Prolific PL2303</a> UART-to-USB bridge chip.</li>
</ul>
<p>To use these examples, use the  <script>link_ext('uv4_ca_packinstaller');</script>, select the related <b>Board</b> and <b>Copy</b> the example.</p>
<h2><a class="anchor" id="host_hid_tutorial"></a>
USB Host Keyboard</h2>
<p>The following example application shows how to interact with a <b>USB keyboard</b> from a microcontroller. To keep it simple, the graphical LCD on the evaluation board is used to show the keyboard inputs. This is done using the <b>Compiler</b> software component with the appropriate user code templates.</p>
<div class="image">
<img src="usbh_hid_setup.png" alt=""/>
<div class="caption">
USB host keyboard example hardware setup</div></div>
    <p>The <code>Abstract.txt</code> file contained in the <b>Documentation</b> group of the <b>Project</b> window gives you more information on the general setup and the available I/O of the development board.</p>
<h3><a class="anchor" id="autotoc_md59"></a>
Build the "USB Host Keyboard" Project</h3>
<p>Open the example project in MDK ( <script>link_ext('uv4_ca_packinstaller');</script> web page explains this).</p>
<h4><a class="anchor" id="autotoc_md60"></a>
Source Files</h4>
<ul>
<li><code>Keyboard.c</code> contains the main C function that initializes the board hardware and the USB Host Component. It also reads the input from the attached keyboard.</li>
<li>In <code>stdout_display.c</code>, the function <code>stdout_putchar</code> is retargeted to the function <code>GLCD_DrawChar</code> of the graphics display.</li>
</ul>
<p>If you are using RTOS other than CMSIS-RTOS2 RTX5 for your project please make sure to satisfy <a class="el" href="usb_resource_requirements.html#usbh_res_req">USB Host Resource Requirements</a>.</p>
<p>You may now build and download the example project to the evaluation board using the µVision commands:</p>
<ul>
<li><b>Project</b> --&gt; <b>Build target (F7)</b></li>
<li><b>Flash</b> --&gt; <b>Download (F8)</b></li>
<li><b>Debug</b> --&gt; <b>Start/Stop Debug Session (Ctrl + F5)</b></li>
<li><b>Debug</b> --&gt; <b>Run (F5)</b></li>
</ul>
<p>After these steps, the project should start executing on your evaluation kit. In case of errors, refer to the Evaluation Board User's Guide for configuration information.</p>
<h3><a class="anchor" id="autotoc_md61"></a>
Using the "USB Host Keyboard" Project</h3>
<h4><a class="anchor" id="autotoc_md62"></a>
Hardware Setup</h4>
<p>The setup of the Evaluation Board hardware is described in the <code>Abstract.txt</code> file.</p>
<ul>
<li>Verify all jumper settings on the target hardware.</li>
<li>Connect a USB keyboard to one of the development board's USB connectors.</li>
<li>After downloading the code onto the board, you should be able to see something similar on the graphics display:</li>
</ul>
<div class="image">
<img src="usbh_keyboard_glcd.png" alt=""/>
<div class="caption">
USB host keyboard example output</div></div>
    <h2><a class="anchor" id="host_msc_tutorial"></a>
USB Host Mass Storage</h2>
<p>The following example application shows how to access an <b>USB memory stick</b> from a microcontroller. This example will create or overwrite a file called <code>Test.txt</code> on the USB Stick with the content "USB Host Mass Storage!". The following picture shows an exemplary connection of the development board and an USB memory stick.</p>
<div class="image">
<img src="usbh_msc_setup.png" alt=""/>
<div class="caption">
USB host mass storage example hardware setup</div></div>
    <p>The <code>Abstract.txt</code> file contained in the <b>Documentation</b> group of the <b>Project</b> window gives you more information on the general setup and the available I/O of the development board.</p>
<h3><a class="anchor" id="autotoc_md63"></a>
Build the "USB Host Mass Storage" Project</h3>
<p>Open the example project in MDK (the  <script>link_ext('uv4_ca_packinstaller');</script> web page explains this).</p>
<h4><a class="anchor" id="autotoc_md64"></a>
Source Files</h4>
<ul>
<li><code>MassStorage.c</code> contains the main C function that initializes the board hardware, the flash storage device and the USB Host Component. Also, it contains that code that will write a file with a message onto the attached USB stick.</li>
</ul>
<p>If you are using RTOS other than CMSIS-RTOS2 RTX5 for your project please make sure to satisfy <a class="el" href="usb_resource_requirements.html#usbh_res_req">USB Host Resource Requirements</a>.</p>
<p>You may now build and download the example project to the evaluation board using the µVision commands:</p>
<ul>
<li><b>Project</b> --&gt; <b>Build target (F7)</b></li>
<li><b>Flash</b> --&gt; <b>Download (F8)</b></li>
<li><b>Debug</b> --&gt; <b>Start/Stop Debug Session (Ctrl + F5)</b></li>
<li><b>Debug</b> --&gt; <b>Run (F5)</b></li>
</ul>
<p>After these steps, the project should start executing on your evaluation kit. In case of errors, refer to the Evaluation Board User's Guide for configuration information.</p>
<h3><a class="anchor" id="autotoc_md65"></a>
Using the "USB Host Mass Storage" Project</h3>
<h4><a class="anchor" id="autotoc_md66"></a>
Hardware Setup</h4>
<p>The setup of the Evaluation Board hardware is described in the <code>Abstract.txt</code> file.</p>
<ul>
<li>Verify all jumper settings on the target hardware.</li>
<li>Simply connect an USB memory stick to one of the development board's USB connectors and run the program.</li>
<li>Detach the USB memory stick and attach it to a PC to check the availability of the <code>Test.txt</code> file.</li>
</ul>
<h2><a class="anchor" id="host_cust_tutorial"></a>
USB Host Custom Class</h2>
<p>This example application shows how to communicate with serial RS232 adapter with <a href="https://www.prolific.com.tw/US/index.aspx">Prolific PL2303</a> UART-to-USB bridge chip from a microcontroller. It is a simple demonstration on how to send data from the USB Host via the USB to serial RS232 adapter to an attached serial terminal. Here, the USB Host sends "Test!" to the USB to serial RS232 adapter and stores all incoming data from the device into the array <code>receive_buf</code>. This example is using the Custom Class because the PL2303 is not USB CDC ACM compliant.</p>
<p>The following picture shows an exemplary connection of the development board and an PL2303 based Device. The PL2303 Device is connected to a PC via RS232 to check incoming messages.</p>
<div class="image">
<img src="usbh_cust_pl2303_example_setup.png" alt=""/>
<div class="caption">
USB host custom class example hardware setup</div></div>
    <h3><a class="anchor" id="autotoc_md67"></a>
Create the "USB Host Custom Class PL2303" Project</h3>
<p>In this example, we are using the <a href="https://www.keil.arm.com/boards/keil-mcbstm32f400-ver-12-3cd831d/projects/">MCBSTM32F400</a> board with the STM32F407IGHx device. Create a new project in MDK (Select Device <b>STMicroelectronics:STM32F4 Series: STM32F407:STM32F407IG:STM32F407IGHx</b>). In the <b>Manage Run-Time Environment</b> window, select the following components:</p>
<ul>
<li><b>Board Support:LED (API):LED</b> (Variant <b>MCBSTM32F400</b>)</li>
<li><b>CMSIS:Core</b></li>
<li><b>CMSIS:RTOS2 (API):Keil RTX5</b></li>
<li><b>CMSIS Driver:USART (API):PL2303</b></li>
<li><b>CMSIS Driver:USB Host (API):Full-speed</b></li>
<li><b>Device:STM32Cube Framework (API):Classic</b></li>
<li><b>USB</b> (Variant <b>MDK</b>)</li>
<li><b>USB:Host: 1</b></li>
<li><b>USB:Host:Custom Class</b></li>
</ul>
<p>Click the <b>Resolve</b> button and then <b>OK</b>.</p>
<p>Before continuing to add the required source code, you need to add a template file called <code>USBH_PL2303.c</code>:</p>
<ul>
<li>Right-click on <b>Source Group 1</b> and select <b>Add New Item to Group 'Source Group 1'...</b>.</li>
<li>Click on <b>User Code Template</b> and scroll down on the left side, until you see the <b>USB</b> component template files.</li>
<li>Choose <b>USB Host Prolific 2303</b></li>
<li>Click on <b>Add</b>.</li>
</ul>
<h4><a class="anchor" id="autotoc_md68"></a>
Source Files</h4>
<ul>
<li>Click on <b>New (Ctrl + N)</b> to create a new file.</li>
<li>Save it (<b>File -&gt; Save</b>) as <b>main.h</b>.</li>
<li>Copy the following code into the main.h file and save it again:</li>
</ul>
<div class="fragment"><div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment">  ******************************************************************************</span></div>
<div class="line"><span class="comment">  * @file    Templates/Inc/main.h</span></div>
<div class="line"><span class="comment">  * @author  MCD Application Team</span></div>
<div class="line"><span class="comment">  * @brief   Header for main.c module</span></div>
<div class="line"><span class="comment">  ******************************************************************************</span></div>
<div class="line"><span class="comment">  * @attention</span></div>
<div class="line"><span class="comment">  *</span></div>
<div class="line"><span class="comment">  * &lt;h2&gt;&lt;center&gt;&amp;copy; COPYRIGHT(c) 2017-2018 STMicroelectronics&lt;/center&gt;&lt;/h2&gt;</span></div>
<div class="line"><span class="comment">  *</span></div>
<div class="line"><span class="comment">  * Redistribution and use in source and binary forms, with or without modification,</span></div>
<div class="line"><span class="comment">  * are permitted provided that the following conditions are met:</span></div>
<div class="line"><span class="comment">  *   1. Redistributions of source code must retain the above copyright notice,</span></div>
<div class="line"><span class="comment">  *      this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment">  *   2. Redistributions in binary form must reproduce the above copyright notice,</span></div>
<div class="line"><span class="comment">  *      this list of conditions and the following disclaimer in the documentation</span></div>
<div class="line"><span class="comment">  *      and/or other materials provided with the distribution.</span></div>
<div class="line"><span class="comment">  *   3. Neither the name of STMicroelectronics nor the names of its contributors</span></div>
<div class="line"><span class="comment">  *      may be used to endorse or promote products derived from this software</span></div>
<div class="line"><span class="comment">  *      without specific prior written permission.</span></div>
<div class="line"><span class="comment">  *</span></div>
<div class="line"><span class="comment">  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS</span></div>
<div class="line"><span class="comment">  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span></div>
<div class="line"><span class="comment">  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span></div>
<div class="line"><span class="comment">  * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE</span></div>
<div class="line"><span class="comment">  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span></div>
<div class="line"><span class="comment">  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span></div>
<div class="line"><span class="comment">  * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span></div>
<div class="line"><span class="comment">  * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span></div>
<div class="line"><span class="comment">  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></div>
<div class="line"><span class="comment">  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"><span class="comment">  *</span></div>
<div class="line"><span class="comment">  ******************************************************************************</span></div>
<div class="line"><span class="comment">  */</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Define to prevent recursive inclusion -------------------------------------*/</span></div>
<div class="line"><span class="preprocessor">#ifndef __MAIN_H</span></div>
<div class="line"><span class="preprocessor">#define __MAIN_H</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Includes ------------------------------------------------------------------*/</span></div>
<div class="line"><span class="preprocessor">#include &quot;stm32f4xx_hal.h</span></div>
<div class="line"><span class="preprocessor">#include &quot;</span>cmsis_os2.h<span class="stringliteral">&quot;                  // ::CMSIS:RTOS2</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">/* Exported types ------------------------------------------------------------*/</span></div>
<div class="line"><span class="stringliteral">/* Exported constants --------------------------------------------------------*/</span></div>
<div class="line"><span class="stringliteral">extern uint64_t app_main_stk[];</span></div>
<div class="line"><span class="stringliteral">extern const osThreadAttr_t app_main_attr;</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">/* Exported macro ------------------------------------------------------------*/</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">/* Exported functions ------------------------------------------------------- */</span></div>
<div class="line"><span class="stringliteral">extern void app_main (void *arg);</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">#endif /* __MAIN_H */</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">/************************ (C) COPYRIGHT STMicroelectronics *****END OF FILE****/</span></div>
</div><!-- fragment --><ul>
<li>Right-click on <b>Source Group 1</b> and select <b>Add New Item to Group 'Source Group 1'...</b>.</li>
<li>Click on <b>C File (.c)</b> and enter <b>main</b> in the <b>Name</b> box.</li>
<li>Copy the following code into the main.c file:</li>
</ul>
<div class="fragment"><div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment">  ******************************************************************************</span></div>
<div class="line"><span class="comment">  * @file    Templates/Src/main.c</span></div>
<div class="line"><span class="comment">  * @author  MCD Application Team</span></div>
<div class="line"><span class="comment">  * @brief   Main program body</span></div>
<div class="line"><span class="comment">  *</span></div>
<div class="line"><span class="comment">  * @note    modified by ARM</span></div>
<div class="line"><span class="comment">  *          The modifications allow to use this file as User Code Template</span></div>
<div class="line"><span class="comment">  *          within the Device Family Pack.</span></div>
<div class="line"><span class="comment">  ******************************************************************************</span></div>
<div class="line"><span class="comment">  * @attention</span></div>
<div class="line"><span class="comment">  *</span></div>
<div class="line"><span class="comment">  * &lt;h2&gt;&lt;center&gt;&amp;copy; COPYRIGHT(c) 2017-2018 STMicroelectronics&lt;/center&gt;&lt;/h2&gt;</span></div>
<div class="line"><span class="comment">  *</span></div>
<div class="line"><span class="comment">  * Redistribution and use in source and binary forms, with or without modification,</span></div>
<div class="line"><span class="comment">  * are permitted provided that the following conditions are met:</span></div>
<div class="line"><span class="comment">  *   1. Redistributions of source code must retain the above copyright notice,</span></div>
<div class="line"><span class="comment">  *      this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment">  *   2. Redistributions in binary form must reproduce the above copyright notice,</span></div>
<div class="line"><span class="comment">  *      this list of conditions and the following disclaimer in the documentation</span></div>
<div class="line"><span class="comment">  *      and/or other materials provided with the distribution.</span></div>
<div class="line"><span class="comment">  *   3. Neither the name of STMicroelectronics nor the names of its contributors</span></div>
<div class="line"><span class="comment">  *      may be used to endorse or promote products derived from this software</span></div>
<div class="line"><span class="comment">  *      without specific prior written permission.</span></div>
<div class="line"><span class="comment">  *</span></div>
<div class="line"><span class="comment">  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS</span></div>
<div class="line"><span class="comment">  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span></div>
<div class="line"><span class="comment">  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span></div>
<div class="line"><span class="comment">  * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE</span></div>
<div class="line"><span class="comment">  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span></div>
<div class="line"><span class="comment">  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span></div>
<div class="line"><span class="comment">  * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span></div>
<div class="line"><span class="comment">  * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span></div>
<div class="line"><span class="comment">  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></div>
<div class="line"><span class="comment">  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"><span class="comment">  *</span></div>
<div class="line"><span class="comment">  ******************************************************************************</span></div>
<div class="line"><span class="comment">  */</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Includes ------------------------------------------------------------------*/</span></div>
<div class="line"><span class="preprocessor">#include &quot;main.h</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="preprocessor">#ifdef _RTE_</span></div>
<div class="line"><span class="preprocessor">#include &quot;</span>RTE_Components.h<span class="stringliteral">&quot;             // Component selection</span></div>
<div class="line"><span class="stringliteral">#endif</span></div>
<div class="line"><span class="stringliteral">#ifdef RTE_CMSIS_RTOS2                  // when RTE component CMSIS RTOS2 is used</span></div>
<div class="line"><span class="stringliteral">#include &quot;</span>cmsis_os2.h<span class="stringliteral">&quot;                  // ::CMSIS:RTOS2</span></div>
<div class="line"><span class="stringliteral">#endif</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">#ifdef RTE_CMSIS_RTOS2_RTX5</span><span class="comment"></span></div>
<div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment">  * Override default HAL_GetTick function</span></div>
<div class="line"><span class="comment">  */</span></div>
<div class="line">uint32_t HAL_GetTick (void) {</div>
<div class="line">  static uint32_t ticks = 0U;</div>
<div class="line">         uint32_t i;</div>
<div class="line"> </div>
<div class="line">  if (osKernelGetState () == osKernelRunning) {</div>
<div class="line">    return ((uint32_t)osKernelGetTickCount ());</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  /* If Kernel is not running wait approximately 1 ms then increment</div>
<div class="line">     and return auxiliary tick counter value */</div>
<div class="line">  for (i = (SystemCoreClock &gt;&gt; 14U); i &gt; 0U; i--) {</div>
<div class="line">    __NOP(); __NOP(); __NOP(); __NOP(); __NOP(); __NOP();</div>
<div class="line">    __NOP(); __NOP(); __NOP(); __NOP(); __NOP(); __NOP();</div>
<div class="line">  }</div>
<div class="line">  return ++ticks;</div>
<div class="line">}</div>
<div class="line">#endif</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">/** @addtogroup STM32F4xx_HAL_Examples</span></div>
<div class="line"><span class="comment">  * @{</span></div>
<div class="line"><span class="comment">  */</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">/** @addtogroup Templates</span></div>
<div class="line"><span class="comment">  * @{</span></div>
<div class="line"><span class="comment">  */</span></div>
<div class="line"> </div>
<div class="line">/* Private typedef -----------------------------------------------------------*/</div>
<div class="line">/* Private define ------------------------------------------------------------*/</div>
<div class="line">/* Private macro -------------------------------------------------------------*/</div>
<div class="line">/* Private variables ---------------------------------------------------------*/</div>
<div class="line">/* Private function prototypes -----------------------------------------------*/</div>
<div class="line">static void SystemClock_Config(void);</div>
<div class="line">static void Error_Handler(void);</div>
<div class="line"> </div>
<div class="line">/* Private functions ---------------------------------------------------------*/<span class="comment"></span></div>
<div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment">  * @brief  Main program</span></div>
<div class="line"><span class="comment">  * @param  None</span></div>
<div class="line"><span class="comment">  * @retval None</span></div>
<div class="line"><span class="comment">  */</span></div>
<div class="line">int main(void)</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line">  /* STM32F4xx HAL library initialization:</div>
<div class="line">       - Configure the Flash prefetch, Flash preread and Buffer caches</div>
<div class="line">       - Systick timer is configured by default as source of time base, but user</div>
<div class="line">             can eventually implement his proper time base source (a general purpose</div>
<div class="line">             timer for example or other time source), keeping in mind that Time base</div>
<div class="line">             duration should be kept 1ms since PPP_TIMEOUT_VALUEs are defined and</div>
<div class="line">             handled in milliseconds basis.</div>
<div class="line">       - Low Level Initialization</div>
<div class="line">     */</div>
<div class="line">  HAL_Init();</div>
<div class="line"> </div>
<div class="line">  /* Configure the system clock to 168 MHz */</div>
<div class="line">  SystemClock_Config();</div>
<div class="line">  SystemCoreClockUpdate();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  /* Add your application code here</div>
<div class="line">     */</div>
<div class="line"> </div>
<div class="line">#ifdef RTE_CMSIS_RTOS2</div>
<div class="line">  /* Initialize CMSIS-RTOS2 */</div>
<div class="line">  osKernelInitialize ();</div>
<div class="line"> </div>
<div class="line">  /* Create application main thread */</div>
<div class="line">  osThreadNew(app_main, NULL, &amp;app_main_attr);</div>
<div class="line"> </div>
<div class="line">  /* Start thread execution */</div>
<div class="line">  osKernelStart();</div>
<div class="line">#endif</div>
<div class="line"> </div>
<div class="line">  /* Infinite loop */</div>
<div class="line">  while (1)</div>
<div class="line">  {</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment">  * @brief  System Clock Configuration</span></div>
<div class="line"><span class="comment">  *         The system Clock is configured as follow :</span></div>
<div class="line"><span class="comment">  *            System Clock source            = PLL (HSE)</span></div>
<div class="line"><span class="comment">  *            SYSCLK(Hz)                     = 168000000</span></div>
<div class="line"><span class="comment">  *            HCLK(Hz)                       = 168000000</span></div>
<div class="line"><span class="comment">  *            AHB Prescaler                  = 1</span></div>
<div class="line"><span class="comment">  *            APB1 Prescaler                 = 4</span></div>
<div class="line"><span class="comment">  *            APB2 Prescaler                 = 2</span></div>
<div class="line"><span class="comment">  *            HSE Frequency(Hz)              = 8000000</span></div>
<div class="line"><span class="comment">  *            PLL_M                          = 25</span></div>
<div class="line"><span class="comment">  *            PLL_N                          = 336</span></div>
<div class="line"><span class="comment">  *            PLL_P                          = 2</span></div>
<div class="line"><span class="comment">  *            PLL_Q                          = 7</span></div>
<div class="line"><span class="comment">  *            VDD(V)                         = 3.3</span></div>
<div class="line"><span class="comment">  *            Main regulator output voltage  = Scale1 mode</span></div>
<div class="line"><span class="comment">  *            Flash Latency(WS)              = 5</span></div>
<div class="line"><span class="comment">  * @param  None</span></div>
<div class="line"><span class="comment">  * @retval None</span></div>
<div class="line"><span class="comment">  */</span></div>
<div class="line">static void SystemClock_Config(void)</div>
<div class="line">{</div>
<div class="line">  RCC_ClkInitTypeDef RCC_ClkInitStruct;</div>
<div class="line">  RCC_OscInitTypeDef RCC_OscInitStruct;</div>
<div class="line"> </div>
<div class="line">  /* Enable Power Control clock */</div>
<div class="line">  __HAL_RCC_PWR_CLK_ENABLE();</div>
<div class="line"> </div>
<div class="line">  /* The voltage scaling allows optimizing the power consumption when the device is</div>
<div class="line">     clocked below the maximum system frequency, to update the voltage scaling value</div>
<div class="line">     regarding system frequency refer to product datasheet.  */</div>
<div class="line">  __HAL_PWR_VOLTAGESCALING_CONFIG(PWR_REGULATOR_VOLTAGE_SCALE1);</div>
<div class="line"> </div>
<div class="line">  /* Enable HSE Oscillator and activate PLL with HSE as source */</div>
<div class="line">  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_HSE;</div>
<div class="line">  RCC_OscInitStruct.HSEState = RCC_HSE_ON;</div>
<div class="line">  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;</div>
<div class="line">  RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_HSE;</div>
<div class="line">  RCC_OscInitStruct.PLL.PLLM = 25;</div>
<div class="line">  RCC_OscInitStruct.PLL.PLLN = 336;</div>
<div class="line">  RCC_OscInitStruct.PLL.PLLP = RCC_PLLP_DIV2;</div>
<div class="line">  RCC_OscInitStruct.PLL.PLLQ = 7;</div>
<div class="line">  if(HAL_RCC_OscConfig(&amp;RCC_OscInitStruct) != HAL_OK)</div>
<div class="line">  {</div>
<div class="line">    /* Initialization Error */</div>
<div class="line">    Error_Handler();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  /* Select PLL as system clock source and configure the HCLK, PCLK1 and PCLK2</div>
<div class="line">     clocks dividers */</div>
<div class="line">  RCC_ClkInitStruct.ClockType = (RCC_CLOCKTYPE_SYSCLK | RCC_CLOCKTYPE_HCLK | RCC_CLOCKTYPE_PCLK1 | RCC_CLOCKTYPE_PCLK2);</div>
<div class="line">  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;</div>
<div class="line">  RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;</div>
<div class="line">  RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV4;</div>
<div class="line">  RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV2;</div>
<div class="line">  if(HAL_RCC_ClockConfig(&amp;RCC_ClkInitStruct, FLASH_LATENCY_5) != HAL_OK)</div>
<div class="line">  {</div>
<div class="line">    /* Initialization Error */</div>
<div class="line">    Error_Handler();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  /* STM32F405x/407x/415x/417x Revision Z devices: prefetch is supported  */</div>
<div class="line">  if (HAL_GetREVID() == 0x1001)</div>
<div class="line">  {</div>
<div class="line">    /* Enable the Flash prefetch */</div>
<div class="line">    __HAL_FLASH_PREFETCH_BUFFER_ENABLE();</div>
<div class="line">  }</div>
<div class="line">}<span class="comment"></span></div>
<div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment">  * @brief  This function is executed in case of error occurrence.</span></div>
<div class="line"><span class="comment">  * @param  None</span></div>
<div class="line"><span class="comment">  * @retval None</span></div>
<div class="line"><span class="comment">  */</span></div>
<div class="line">static void Error_Handler(void)</div>
<div class="line">{</div>
<div class="line">  /* User may add here some code to deal with this error */</div>
<div class="line">  while(1)</div>
<div class="line">  {</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">#ifdef  USE_FULL_ASSERT</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment">  * @brief  Reports the name of the source file and the source line number</span></div>
<div class="line"><span class="comment">  *         where the assert_param error has occurred.</span></div>
<div class="line"><span class="comment">  * @param  file: pointer to the source file name</span></div>
<div class="line"><span class="comment">  * @param  line: assert_param error line source number</span></div>
<div class="line"><span class="comment">  * @retval None</span></div>
<div class="line"><span class="comment">  */</span></div>
<div class="line">void assert_failed(uint8_t* file, uint32_t line)</div>
<div class="line">{</div>
<div class="line">  /* User can add his own implementation to report the file name and line number,</div>
<div class="line">     ex: printf(&quot;Wrong parameters value: file %s on line %d\r\n<span class="stringliteral">&quot;, file, line) */</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">  /* Infinite loop */</span></div>
<div class="line"><span class="stringliteral">  while (1)</span></div>
<div class="line"><span class="stringliteral">  {</span></div>
<div class="line"><span class="stringliteral">  }</span></div>
<div class="line"><span class="stringliteral">}</span></div>
<div class="line"><span class="stringliteral">#endif</span></div>
<div class="line"><span class="stringliteral"></span><span class="comment"></span> </div>
<div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment">  * @}</span></div>
<div class="line"><span class="comment">  */</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment">  * @}</span></div>
<div class="line"><span class="comment">  */</span></div>
<div class="line"> </div>
<div class="line">/************************ (C) COPYRIGHT STMicroelectronics *****END OF FILE****/</div>
</div><!-- fragment --><ul>
<li>Right-click on <b>Source Group 1</b> and select <b>Add New Item to Group 'Source Group 1'...</b>.</li>
<li>Click on <b>C File (.c)</b> and enter <b>app_main</b> in the <b>Name</b> box.</li>
<li>Copy the following code into the app_main.c file:</li>
</ul>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;main.h</span></div>
<div class="line"><span class="preprocessor">#include &quot;</span>rl_usb.h</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;Board_LED.h</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="preprocessor">#include &quot;</span>Driver_USART.h</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* UART Driver */</span></div>
<div class="line"><span class="keyword">extern</span> ARM_DRIVER_USART       Driver_USART9;</div>
<div class="line"><span class="preprocessor">#define ptrUART_USB         (&amp;Driver_USART9)</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Main stack size must be multiple of 8 Bytes</span></div>
<div class="line"><span class="preprocessor">#define APP_MAIN_STK_SZ (1024U)</span></div>
<div class="line">uint64_t app_main_stk[APP_MAIN_STK_SZ / 8];</div>
<div class="line"><span class="keyword">const</span> osThreadAttr_t app_main_attr = {</div>
<div class="line">  .stack_mem  = &amp;app_main_stk[0],</div>
<div class="line">  .stack_size = <span class="keyword">sizeof</span>(app_main_stk)</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> uint8_t  receive_buf[64];</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*------------------------------------------------------</span></div>
<div class="line"><span class="comment"> *        UART Done Callback</span></div>
<div class="line"><span class="comment"> *----------------------------------------------------------------------------*/</span></div>
<div class="line"><span class="keywordtype">void</span> UART_Done (uint32_t event) {</div>
<div class="line">  <span class="keywordflow">switch</span> (event) {</div>
<div class="line">    <span class="keywordflow">case</span> ARM_USART_EVENT_SEND_COMPLETE:</div>
<div class="line">      <span class="comment">// All requested data was transmitted</span></div>
<div class="line">      LED_On(1);</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> ARM_USART_EVENT_RECEIVE_COMPLETE:</div>
<div class="line">      <span class="comment">// After 64 bytes were received, restart new reception</span></div>
<div class="line">      ptrUART_USB-&gt;Receive (receive_buf, 64);</div>
<div class="line">      LED_On(2);</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*------------------------------------------------------</span></div>
<div class="line"><span class="comment"> *        Application</span></div>
<div class="line"><span class="comment"> *----------------------------------------------------------------------------*/</span></div>
<div class="line">__NO_RETURN <span class="keywordtype">void</span> app_main (<span class="keywordtype">void</span> *arg) {</div>
<div class="line">  <span class="keyword">static</span> <span class="keywordtype">bool</span> con_last = <span class="keyword">false</span>;</div>
<div class="line">         <span class="keywordtype">bool</span> con;</div>
<div class="line"> </div>
<div class="line">  (void)arg;</div>
<div class="line"> </div>
<div class="line">  LED_Initialize    ();</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_function" href="group__usbh__coreFunctions__api.html#ga4420c0add78ae79e8e7ce035227ef4c5" title="Initialize USB Host stack and controller.">USBH_Initialize</a> (0);                        <span class="comment">/* Initialize USB Host 0        */</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">while</span> (1) {</div>
<div class="line">    con = (<a class="code hl_function" href="group__usbh__customFunctions__api.html#ga6cc444113f6641e70d5276ffdea0b842" title="Get status of Custom Class Device.">USBH_CustomClass_GetStatus</a>(0) == <a class="code hl_enumvalue" href="rl__usb_8h.html#ga8196235c97e113f17993c7b4baff5f8facfe6cb72ed8e7b8e95a38cbf95418dbf" title="Function completed with no error.">usbOK</a>);</div>
<div class="line">    <span class="keywordflow">if</span> (con ^ con_last) {</div>
<div class="line">      <span class="keywordflow">if</span> (con) {</div>
<div class="line">        con_last = <span class="keyword">true</span>;</div>
<div class="line">        LED_On(0);</div>
<div class="line">        osDelay(1000);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* Initialize and configure UART &lt;-&gt; USB Bridge */</span></div>
<div class="line">        ptrUART_USB-&gt;Initialize  (UART_Done);</div>
<div class="line">        ptrUART_USB-&gt;PowerControl(ARM_POWER_FULL);</div>
<div class="line">        ptrUART_USB-&gt;Control     (ARM_USART_MODE_ASYNCHRONOUS |</div>
<div class="line">                                  ARM_USART_DATA_BITS_8       |</div>
<div class="line">                                  ARM_USART_PARITY_NONE       |</div>
<div class="line">                                  ARM_USART_STOP_BITS_1       |</div>
<div class="line">                                  ARM_USART_FLOW_CONTROL_NONE ,</div>
<div class="line">                                  115200                      );</div>
<div class="line">        ptrUART_USB-&gt;Control     (ARM_USART_CONTROL_TX, 1);</div>
<div class="line">        ptrUART_USB-&gt;Control     (ARM_USART_CONTROL_RX, 1);</div>
<div class="line">        ptrUART_USB-&gt;Receive     (receive_buf, 64);</div>
<div class="line">        ptrUART_USB-&gt;Send        (<span class="stringliteral">&quot;Test!&quot;</span>,     5);</div>
<div class="line">      } <span class="keywordflow">else</span> {</div>
<div class="line">        con_last = <span class="keyword">false</span>;</div>
<div class="line">        LED_Off(0);</div>
<div class="line">      }</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      <span class="keywordflow">if</span> (con) {</div>
<div class="line">        <span class="comment">// Receive data can be checked by polling as callback will be called</span></div>
<div class="line">        <span class="comment">// only when all requested number of bytes were received</span></div>
<div class="line">        <span class="comment">// (in this case 64 bytes)</span></div>
<div class="line">        <span class="keywordflow">if</span> (ptrUART_USB-&gt;GetRxCount() == 5) {</div>
<div class="line">          <span class="comment">// If 5 bytes were received</span></div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">      osDelay(1000);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p>Before building the project, you need to edit these configuration files (in Configuration Wizard view):</p>
<ul>
<li>Under <b>Device</b>, double-click <b>RTE_Device.h</b> and:<ul>
<li>enable <b>USB OTG Full-speed</b> and under it:<ul>
<li>enable <b>Host [Driver_USBH0]</b></li>
<li>disable <b>Host [Driver_USBH0]:Overcurrent Detection Pin</b></li>
</ul>
</li>
</ul>
</li>
<li>Double-click <b>USB:USBH_Config_0.h</b> and under <b>USB Host 0</b> change:<ul>
<li>set <b>Maximum Pipes in system</b> to <b>4</b></li>
</ul>
</li>
</ul>
<p>Before building and downloading the project to the target, make sure that the correct debugger is set in the <b>Options for Target</b> dialog (ALT + F7). You may then build and download the example project to the evaluation board using the µVision commands:</p>
<ul>
<li><b>Project</b> --&gt; <b>Build target (F7)</b></li>
<li><b>Flash</b> --&gt; <b>Download (F8)</b></li>
<li><b>Debug</b> --&gt; <b>Start/Stop Debug Session (Ctrl + F5)</b></li>
<li><b>Debug</b> --&gt; <b>Run (F5)</b></li>
</ul>
<p>After these steps, the project should start executing on your evaluation kit. In case of errors, refer to the Evaluation Board User's Guide for configuration information.</p>
<h3><a class="anchor" id="autotoc_md69"></a>
Using the "USB Host Custom Class PL2303" Project</h3>
<h4><a class="anchor" id="autotoc_md70"></a>
Hardware Setup</h4>
<ul>
<li>Verify all jumper settings on the target hardware.</li>
<li>Connect an USB to serial RS232 adapter using the Prolific PL2303 to the development board's <b>USBFS</b> connector.</li>
<li>Connect the serial line to a PC and open a terminal using 115200 baud data rate.</li>
<li>You should see the message "Test!" in the terminal window. You can also send messages from the PC to the microcontroller device. For that, please check the <code>receive_buf</code> buffer called by the <code>-&gt;Receive</code> function.</li>
</ul>
<h2><a class="anchor" id="host_cdc_tutorial"></a>
USB Host CDC ACM</h2>
<p>This example application shows how to communicate with an <b>USB CDC ACM Device</b> from a microcontroller. It is a simple demonstration on how to send data from the USB Host to the attached USB CDC ACM Device. Here, the USB Host sends "Test!" to the USB CDC ACM Device and stores all incoming data from the device into the array <code>receive_buf</code>.</p>
<p>The following picture shows an exemplary connection of the development board and an USB CDC ACM Device implemented on another development board. This USB CDC ACM Device is connected to a PC via RS232 to check incoming messages.</p>
<div class="image">
<img src="usbh_cdc_example_setup.png" alt=""/>
<div class="caption">
USB device audio example hardware setup</div></div>
    <h3><a class="anchor" id="autotoc_md71"></a>
Create the "USB Host CDC" Project</h3>
<p>In this example, we are using the <a href="https://www.keil.arm.com/boards/keil-mcbstm32f400-ver-12-3cd831d/projects/">MCBSTM32F400</a>\ board with the STM32F407IGHx device. Create a new project in MDK (Select Device <b>STMicroelectronics:STM32F4 Series: STM32F407:STM32F407IG:STM32F407IGHx</b>). In the <b>Manage Run-Time Environment</b> window, select the following components:</p>
<ul>
<li><b>Board Support:LED (API):LED</b> (Variant <b>MCBSTM32F400</b>)</li>
<li><b>CMSIS:Core</b></li>
<li><b>CMSIS:RTOS2 (API):Keil RTX5</b></li>
<li><b>CMSIS Driver:USART (API):CDC</b></li>
<li><b>CMSIS Driver:USB Host (API):Full-speed</b></li>
<li><b>Device:STM32Cube Framework (API):Classic</b></li>
<li><b>USB</b> (Variant <b>MDK</b>)</li>
<li><b>USB:Host: 1</b></li>
<li><b>USB:Host:CDC</b></li>
</ul>
<p>Click the <b>Resolve</b> button and then <b>OK</b>.</p>
<h4><a class="anchor" id="autotoc_md72"></a>
Source Files</h4>
<ul>
<li>Click on <b>New (Ctrl + N)</b> to create a new file.</li>
<li>Save it (<b>File -&gt; Save</b>) as <b>main.h</b>.</li>
<li>Copy the following code into the main.h file and save it again:</li>
</ul>
<div class="fragment"><div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment">  ******************************************************************************</span></div>
<div class="line"><span class="comment">  * @file    Templates/Inc/main.h</span></div>
<div class="line"><span class="comment">  * @author  MCD Application Team</span></div>
<div class="line"><span class="comment">  * @brief   Header for main.c module</span></div>
<div class="line"><span class="comment">  ******************************************************************************</span></div>
<div class="line"><span class="comment">  * @attention</span></div>
<div class="line"><span class="comment">  *</span></div>
<div class="line"><span class="comment">  * &lt;h2&gt;&lt;center&gt;&amp;copy; COPYRIGHT(c) 2017-2018 STMicroelectronics&lt;/center&gt;&lt;/h2&gt;</span></div>
<div class="line"><span class="comment">  *</span></div>
<div class="line"><span class="comment">  * Redistribution and use in source and binary forms, with or without modification,</span></div>
<div class="line"><span class="comment">  * are permitted provided that the following conditions are met:</span></div>
<div class="line"><span class="comment">  *   1. Redistributions of source code must retain the above copyright notice,</span></div>
<div class="line"><span class="comment">  *      this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment">  *   2. Redistributions in binary form must reproduce the above copyright notice,</span></div>
<div class="line"><span class="comment">  *      this list of conditions and the following disclaimer in the documentation</span></div>
<div class="line"><span class="comment">  *      and/or other materials provided with the distribution.</span></div>
<div class="line"><span class="comment">  *   3. Neither the name of STMicroelectronics nor the names of its contributors</span></div>
<div class="line"><span class="comment">  *      may be used to endorse or promote products derived from this software</span></div>
<div class="line"><span class="comment">  *      without specific prior written permission.</span></div>
<div class="line"><span class="comment">  *</span></div>
<div class="line"><span class="comment">  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS</span></div>
<div class="line"><span class="comment">  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span></div>
<div class="line"><span class="comment">  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span></div>
<div class="line"><span class="comment">  * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE</span></div>
<div class="line"><span class="comment">  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span></div>
<div class="line"><span class="comment">  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span></div>
<div class="line"><span class="comment">  * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span></div>
<div class="line"><span class="comment">  * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span></div>
<div class="line"><span class="comment">  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></div>
<div class="line"><span class="comment">  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"><span class="comment">  *</span></div>
<div class="line"><span class="comment">  ******************************************************************************</span></div>
<div class="line"><span class="comment">  */</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Define to prevent recursive inclusion -------------------------------------*/</span></div>
<div class="line"><span class="preprocessor">#ifndef __MAIN_H</span></div>
<div class="line"><span class="preprocessor">#define __MAIN_H</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Includes ------------------------------------------------------------------*/</span></div>
<div class="line"><span class="preprocessor">#include &quot;stm32f4xx_hal.h</span></div>
<div class="line"><span class="preprocessor">#include &quot;</span>cmsis_os2.h<span class="stringliteral">&quot;                  // ::CMSIS:RTOS2</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">/* Exported types ------------------------------------------------------------*/</span></div>
<div class="line"><span class="stringliteral">/* Exported constants --------------------------------------------------------*/</span></div>
<div class="line"><span class="stringliteral">extern uint64_t app_main_stk[];</span></div>
<div class="line"><span class="stringliteral">extern const osThreadAttr_t app_main_attr;</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">/* Exported macro ------------------------------------------------------------*/</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">/* Exported functions ------------------------------------------------------- */</span></div>
<div class="line"><span class="stringliteral">extern void app_main (void *arg);</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">#endif /* __MAIN_H */</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">/************************ (C) COPYRIGHT STMicroelectronics *****END OF FILE****/</span></div>
</div><!-- fragment --><ul>
<li>Right-click on <b>Source Group 1</b> and select <b>Add New Item to Group 'Source Group 1'...</b>.</li>
<li>Click on <b>C File (.c)</b> and enter <b>main</b> in the <b>Name</b> box.</li>
<li>Copy the following code into the main.c file:</li>
</ul>
<div class="fragment"><div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment">  ******************************************************************************</span></div>
<div class="line"><span class="comment">  * @file    Templates/Src/main.c</span></div>
<div class="line"><span class="comment">  * @author  MCD Application Team</span></div>
<div class="line"><span class="comment">  * @brief   Main program body</span></div>
<div class="line"><span class="comment">  *</span></div>
<div class="line"><span class="comment">  * @note    modified by ARM</span></div>
<div class="line"><span class="comment">  *          The modifications allow to use this file as User Code Template</span></div>
<div class="line"><span class="comment">  *          within the Device Family Pack.</span></div>
<div class="line"><span class="comment">  ******************************************************************************</span></div>
<div class="line"><span class="comment">  * @attention</span></div>
<div class="line"><span class="comment">  *</span></div>
<div class="line"><span class="comment">  * &lt;h2&gt;&lt;center&gt;&amp;copy; COPYRIGHT(c) 2017-2018 STMicroelectronics&lt;/center&gt;&lt;/h2&gt;</span></div>
<div class="line"><span class="comment">  *</span></div>
<div class="line"><span class="comment">  * Redistribution and use in source and binary forms, with or without modification,</span></div>
<div class="line"><span class="comment">  * are permitted provided that the following conditions are met:</span></div>
<div class="line"><span class="comment">  *   1. Redistributions of source code must retain the above copyright notice,</span></div>
<div class="line"><span class="comment">  *      this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment">  *   2. Redistributions in binary form must reproduce the above copyright notice,</span></div>
<div class="line"><span class="comment">  *      this list of conditions and the following disclaimer in the documentation</span></div>
<div class="line"><span class="comment">  *      and/or other materials provided with the distribution.</span></div>
<div class="line"><span class="comment">  *   3. Neither the name of STMicroelectronics nor the names of its contributors</span></div>
<div class="line"><span class="comment">  *      may be used to endorse or promote products derived from this software</span></div>
<div class="line"><span class="comment">  *      without specific prior written permission.</span></div>
<div class="line"><span class="comment">  *</span></div>
<div class="line"><span class="comment">  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS</span></div>
<div class="line"><span class="comment">  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span></div>
<div class="line"><span class="comment">  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span></div>
<div class="line"><span class="comment">  * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE</span></div>
<div class="line"><span class="comment">  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span></div>
<div class="line"><span class="comment">  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span></div>
<div class="line"><span class="comment">  * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span></div>
<div class="line"><span class="comment">  * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span></div>
<div class="line"><span class="comment">  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></div>
<div class="line"><span class="comment">  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"><span class="comment">  *</span></div>
<div class="line"><span class="comment">  ******************************************************************************</span></div>
<div class="line"><span class="comment">  */</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Includes ------------------------------------------------------------------*/</span></div>
<div class="line"><span class="preprocessor">#include &quot;main.h</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="preprocessor">#ifdef _RTE_</span></div>
<div class="line"><span class="preprocessor">#include &quot;</span>RTE_Components.h<span class="stringliteral">&quot;             // Component selection</span></div>
<div class="line"><span class="stringliteral">#endif</span></div>
<div class="line"><span class="stringliteral">#ifdef RTE_CMSIS_RTOS2                  // when RTE component CMSIS RTOS2 is used</span></div>
<div class="line"><span class="stringliteral">#include &quot;</span>cmsis_os2.h<span class="stringliteral">&quot;                  // ::CMSIS:RTOS2</span></div>
<div class="line"><span class="stringliteral">#endif</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">#ifdef RTE_CMSIS_RTOS2_RTX5</span><span class="comment"></span></div>
<div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment">  * Override default HAL_GetTick function</span></div>
<div class="line"><span class="comment">  */</span></div>
<div class="line">uint32_t HAL_GetTick (void) {</div>
<div class="line">  static uint32_t ticks = 0U;</div>
<div class="line">         uint32_t i;</div>
<div class="line"> </div>
<div class="line">  if (osKernelGetState () == osKernelRunning) {</div>
<div class="line">    return ((uint32_t)osKernelGetTickCount ());</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  /* If Kernel is not running wait approximately 1 ms then increment</div>
<div class="line">     and return auxiliary tick counter value */</div>
<div class="line">  for (i = (SystemCoreClock &gt;&gt; 14U); i &gt; 0U; i--) {</div>
<div class="line">    __NOP(); __NOP(); __NOP(); __NOP(); __NOP(); __NOP();</div>
<div class="line">    __NOP(); __NOP(); __NOP(); __NOP(); __NOP(); __NOP();</div>
<div class="line">  }</div>
<div class="line">  return ++ticks;</div>
<div class="line">}</div>
<div class="line">#endif</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">/** @addtogroup STM32F4xx_HAL_Examples</span></div>
<div class="line"><span class="comment">  * @{</span></div>
<div class="line"><span class="comment">  */</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">/** @addtogroup Templates</span></div>
<div class="line"><span class="comment">  * @{</span></div>
<div class="line"><span class="comment">  */</span></div>
<div class="line"> </div>
<div class="line">/* Private typedef -----------------------------------------------------------*/</div>
<div class="line">/* Private define ------------------------------------------------------------*/</div>
<div class="line">/* Private macro -------------------------------------------------------------*/</div>
<div class="line">/* Private variables ---------------------------------------------------------*/</div>
<div class="line">/* Private function prototypes -----------------------------------------------*/</div>
<div class="line">static void SystemClock_Config(void);</div>
<div class="line">static void Error_Handler(void);</div>
<div class="line"> </div>
<div class="line">/* Private functions ---------------------------------------------------------*/<span class="comment"></span></div>
<div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment">  * @brief  Main program</span></div>
<div class="line"><span class="comment">  * @param  None</span></div>
<div class="line"><span class="comment">  * @retval None</span></div>
<div class="line"><span class="comment">  */</span></div>
<div class="line">int main(void)</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line">  /* STM32F4xx HAL library initialization:</div>
<div class="line">       - Configure the Flash prefetch, Flash preread and Buffer caches</div>
<div class="line">       - Systick timer is configured by default as source of time base, but user</div>
<div class="line">             can eventually implement his proper time base source (a general purpose</div>
<div class="line">             timer for example or other time source), keeping in mind that Time base</div>
<div class="line">             duration should be kept 1ms since PPP_TIMEOUT_VALUEs are defined and</div>
<div class="line">             handled in milliseconds basis.</div>
<div class="line">       - Low Level Initialization</div>
<div class="line">     */</div>
<div class="line">  HAL_Init();</div>
<div class="line"> </div>
<div class="line">  /* Configure the system clock to 168 MHz */</div>
<div class="line">  SystemClock_Config();</div>
<div class="line">  SystemCoreClockUpdate();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  /* Add your application code here</div>
<div class="line">     */</div>
<div class="line"> </div>
<div class="line">#ifdef RTE_CMSIS_RTOS2</div>
<div class="line">  /* Initialize CMSIS-RTOS2 */</div>
<div class="line">  osKernelInitialize ();</div>
<div class="line"> </div>
<div class="line">  /* Create application main thread */</div>
<div class="line">  osThreadNew(app_main, NULL, &amp;app_main_attr);</div>
<div class="line"> </div>
<div class="line">  /* Start thread execution */</div>
<div class="line">  osKernelStart();</div>
<div class="line">#endif</div>
<div class="line"> </div>
<div class="line">  /* Infinite loop */</div>
<div class="line">  while (1)</div>
<div class="line">  {</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment">  * @brief  System Clock Configuration</span></div>
<div class="line"><span class="comment">  *         The system Clock is configured as follow :</span></div>
<div class="line"><span class="comment">  *            System Clock source            = PLL (HSE)</span></div>
<div class="line"><span class="comment">  *            SYSCLK(Hz)                     = 168000000</span></div>
<div class="line"><span class="comment">  *            HCLK(Hz)                       = 168000000</span></div>
<div class="line"><span class="comment">  *            AHB Prescaler                  = 1</span></div>
<div class="line"><span class="comment">  *            APB1 Prescaler                 = 4</span></div>
<div class="line"><span class="comment">  *            APB2 Prescaler                 = 2</span></div>
<div class="line"><span class="comment">  *            HSE Frequency(Hz)              = 8000000</span></div>
<div class="line"><span class="comment">  *            PLL_M                          = 25</span></div>
<div class="line"><span class="comment">  *            PLL_N                          = 336</span></div>
<div class="line"><span class="comment">  *            PLL_P                          = 2</span></div>
<div class="line"><span class="comment">  *            PLL_Q                          = 7</span></div>
<div class="line"><span class="comment">  *            VDD(V)                         = 3.3</span></div>
<div class="line"><span class="comment">  *            Main regulator output voltage  = Scale1 mode</span></div>
<div class="line"><span class="comment">  *            Flash Latency(WS)              = 5</span></div>
<div class="line"><span class="comment">  * @param  None</span></div>
<div class="line"><span class="comment">  * @retval None</span></div>
<div class="line"><span class="comment">  */</span></div>
<div class="line">static void SystemClock_Config(void)</div>
<div class="line">{</div>
<div class="line">  RCC_ClkInitTypeDef RCC_ClkInitStruct;</div>
<div class="line">  RCC_OscInitTypeDef RCC_OscInitStruct;</div>
<div class="line"> </div>
<div class="line">  /* Enable Power Control clock */</div>
<div class="line">  __HAL_RCC_PWR_CLK_ENABLE();</div>
<div class="line"> </div>
<div class="line">  /* The voltage scaling allows optimizing the power consumption when the device is</div>
<div class="line">     clocked below the maximum system frequency, to update the voltage scaling value</div>
<div class="line">     regarding system frequency refer to product datasheet.  */</div>
<div class="line">  __HAL_PWR_VOLTAGESCALING_CONFIG(PWR_REGULATOR_VOLTAGE_SCALE1);</div>
<div class="line"> </div>
<div class="line">  /* Enable HSE Oscillator and activate PLL with HSE as source */</div>
<div class="line">  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_HSE;</div>
<div class="line">  RCC_OscInitStruct.HSEState = RCC_HSE_ON;</div>
<div class="line">  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;</div>
<div class="line">  RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_HSE;</div>
<div class="line">  RCC_OscInitStruct.PLL.PLLM = 25;</div>
<div class="line">  RCC_OscInitStruct.PLL.PLLN = 336;</div>
<div class="line">  RCC_OscInitStruct.PLL.PLLP = RCC_PLLP_DIV2;</div>
<div class="line">  RCC_OscInitStruct.PLL.PLLQ = 7;</div>
<div class="line">  if(HAL_RCC_OscConfig(&amp;RCC_OscInitStruct) != HAL_OK)</div>
<div class="line">  {</div>
<div class="line">    /* Initialization Error */</div>
<div class="line">    Error_Handler();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  /* Select PLL as system clock source and configure the HCLK, PCLK1 and PCLK2</div>
<div class="line">     clocks dividers */</div>
<div class="line">  RCC_ClkInitStruct.ClockType = (RCC_CLOCKTYPE_SYSCLK | RCC_CLOCKTYPE_HCLK | RCC_CLOCKTYPE_PCLK1 | RCC_CLOCKTYPE_PCLK2);</div>
<div class="line">  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;</div>
<div class="line">  RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;</div>
<div class="line">  RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV4;</div>
<div class="line">  RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV2;</div>
<div class="line">  if(HAL_RCC_ClockConfig(&amp;RCC_ClkInitStruct, FLASH_LATENCY_5) != HAL_OK)</div>
<div class="line">  {</div>
<div class="line">    /* Initialization Error */</div>
<div class="line">    Error_Handler();</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  /* STM32F405x/407x/415x/417x Revision Z devices: prefetch is supported  */</div>
<div class="line">  if (HAL_GetREVID() == 0x1001)</div>
<div class="line">  {</div>
<div class="line">    /* Enable the Flash prefetch */</div>
<div class="line">    __HAL_FLASH_PREFETCH_BUFFER_ENABLE();</div>
<div class="line">  }</div>
<div class="line">}<span class="comment"></span></div>
<div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment">  * @brief  This function is executed in case of error occurrence.</span></div>
<div class="line"><span class="comment">  * @param  None</span></div>
<div class="line"><span class="comment">  * @retval None</span></div>
<div class="line"><span class="comment">  */</span></div>
<div class="line">static void Error_Handler(void)</div>
<div class="line">{</div>
<div class="line">  /* User may add here some code to deal with this error */</div>
<div class="line">  while(1)</div>
<div class="line">  {</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">#ifdef  USE_FULL_ASSERT</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment">  * @brief  Reports the name of the source file and the source line number</span></div>
<div class="line"><span class="comment">  *         where the assert_param error has occurred.</span></div>
<div class="line"><span class="comment">  * @param  file: pointer to the source file name</span></div>
<div class="line"><span class="comment">  * @param  line: assert_param error line source number</span></div>
<div class="line"><span class="comment">  * @retval None</span></div>
<div class="line"><span class="comment">  */</span></div>
<div class="line">void assert_failed(uint8_t* file, uint32_t line)</div>
<div class="line">{</div>
<div class="line">  /* User can add his own implementation to report the file name and line number,</div>
<div class="line">     ex: printf(&quot;Wrong parameters value: file %s on line %d\r\n<span class="stringliteral">&quot;, file, line) */</span></div>
<div class="line"><span class="stringliteral"></span> </div>
<div class="line"><span class="stringliteral">  /* Infinite loop */</span></div>
<div class="line"><span class="stringliteral">  while (1)</span></div>
<div class="line"><span class="stringliteral">  {</span></div>
<div class="line"><span class="stringliteral">  }</span></div>
<div class="line"><span class="stringliteral">}</span></div>
<div class="line"><span class="stringliteral">#endif</span></div>
<div class="line"><span class="stringliteral"></span><span class="comment"></span> </div>
<div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment">  * @}</span></div>
<div class="line"><span class="comment">  */</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment">  * @}</span></div>
<div class="line"><span class="comment">  */</span></div>
<div class="line"> </div>
<div class="line">/************************ (C) COPYRIGHT STMicroelectronics *****END OF FILE****/</div>
</div><!-- fragment --><ul>
<li>Right-click on <b>Source Group 1</b> and select <b>Add New Item to Group 'Source Group 1'...</b>.</li>
<li>Click on <b>C File (.c)</b> and enter <b>app_main</b> in the <b>Name</b> box.</li>
<li>Copy the following code into the app_main.c file:</li>
</ul>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;main.h</span></div>
<div class="line"><span class="preprocessor">#include &quot;</span>rl_usb.h</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;Board_LED.h</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="preprocessor">#include &quot;</span>Driver_USART.h</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* UART Driver */</span></div>
<div class="line"><span class="keyword">extern</span> ARM_DRIVER_USART       Driver_USART9;</div>
<div class="line"><span class="preprocessor">#define ptrUART_USB         (&amp;Driver_USART9)</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Main stack size must be multiple of 8 Bytes</span></div>
<div class="line"><span class="preprocessor">#define APP_MAIN_STK_SZ (1024U)</span></div>
<div class="line">uint64_t app_main_stk[APP_MAIN_STK_SZ / 8];</div>
<div class="line"><span class="keyword">const</span> osThreadAttr_t app_main_attr = {</div>
<div class="line">  .stack_mem  = &amp;app_main_stk[0],</div>
<div class="line">  .stack_size = <span class="keyword">sizeof</span>(app_main_stk)</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> uint8_t  receive_buf[64];</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*------------------------------------------------------</span></div>
<div class="line"><span class="comment"> *        UART Done Callback</span></div>
<div class="line"><span class="comment"> *----------------------------------------------------------------------------*/</span></div>
<div class="line"><span class="keywordtype">void</span> UART_Done (uint32_t event) {</div>
<div class="line">  <span class="keywordflow">switch</span> (event) {</div>
<div class="line">    <span class="keywordflow">case</span> ARM_USART_EVENT_SEND_COMPLETE:</div>
<div class="line">      <span class="comment">// All requested data was transmitted</span></div>
<div class="line">      LED_On(1);</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> ARM_USART_EVENT_RECEIVE_COMPLETE:</div>
<div class="line">      <span class="comment">// After 64 bytes were received, restart new reception</span></div>
<div class="line">      ptrUART_USB-&gt;Receive (receive_buf, 64);</div>
<div class="line">      LED_On(2);</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*------------------------------------------------------</span></div>
<div class="line"><span class="comment"> *        Application</span></div>
<div class="line"><span class="comment"> *----------------------------------------------------------------------------*/</span></div>
<div class="line">__NO_RETURN <span class="keywordtype">void</span> app_main (<span class="keywordtype">void</span> *arg) {</div>
<div class="line">  <span class="keyword">static</span> <span class="keywordtype">bool</span> con_last = <span class="keyword">false</span>;</div>
<div class="line">         <span class="keywordtype">bool</span> con;</div>
<div class="line"> </div>
<div class="line">  (void)arg;</div>
<div class="line"> </div>
<div class="line">  LED_Initialize    ();</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_function" href="group__usbh__coreFunctions__api.html#ga4420c0add78ae79e8e7ce035227ef4c5" title="Initialize USB Host stack and controller.">USBH_Initialize</a> (0);                        <span class="comment">/* Initialize USB Host 0        */</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">while</span> (1) {</div>
<div class="line">    con = (<a class="code hl_function" href="group__usbh__cdcacmFunctions__api.html#gaca5c244c4966b91db667778da473aded" title="Get status of Communication Device Class device.">USBH_CDC_ACM_GetStatus</a>(0) == <a class="code hl_enumvalue" href="rl__usb_8h.html#ga8196235c97e113f17993c7b4baff5f8facfe6cb72ed8e7b8e95a38cbf95418dbf" title="Function completed with no error.">usbOK</a>);</div>
<div class="line">    <span class="keywordflow">if</span> (con ^ con_last) {</div>
<div class="line">      <span class="keywordflow">if</span> (con) {</div>
<div class="line">        con_last = <span class="keyword">true</span>;</div>
<div class="line">        LED_On(0);</div>
<div class="line">        osDelay(1000);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* Initialize and configure UART &lt;-&gt; USB Bridge */</span></div>
<div class="line">        ptrUART_USB-&gt;Initialize  (UART_Done);</div>
<div class="line">        ptrUART_USB-&gt;PowerControl(ARM_POWER_FULL);</div>
<div class="line">        ptrUART_USB-&gt;Control     (ARM_USART_MODE_ASYNCHRONOUS |</div>
<div class="line">                                  ARM_USART_DATA_BITS_8       |</div>
<div class="line">                                  ARM_USART_PARITY_NONE       |</div>
<div class="line">                                  ARM_USART_STOP_BITS_1       |</div>
<div class="line">                                  ARM_USART_FLOW_CONTROL_NONE ,</div>
<div class="line">                                  115200                      );</div>
<div class="line">        ptrUART_USB-&gt;Control     (ARM_USART_CONTROL_TX, 1);</div>
<div class="line">        ptrUART_USB-&gt;Control     (ARM_USART_CONTROL_RX, 1);</div>
<div class="line">        ptrUART_USB-&gt;Receive     (receive_buf, 64);</div>
<div class="line">        ptrUART_USB-&gt;Send        (<span class="stringliteral">&quot;Test!&quot;</span>,     5);</div>
<div class="line">      } <span class="keywordflow">else</span> {</div>
<div class="line">        con_last = <span class="keyword">false</span>;</div>
<div class="line">        LED_Off(0);</div>
<div class="line">      }</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      <span class="keywordflow">if</span> (con) {</div>
<div class="line">        <span class="comment">// Receive data can be checked by polling as callback will be called</span></div>
<div class="line">        <span class="comment">// only when all requested number of bytes were received</span></div>
<div class="line">        <span class="comment">// (in this case 64 bytes)</span></div>
<div class="line">        <span class="keywordflow">if</span> (ptrUART_USB-&gt;GetRxCount() == 5) {</div>
<div class="line">          <span class="comment">// If 5 bytes were received</span></div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">      osDelay(1000);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p>Before building the project, you need to edit these configuration files (in Configuration Wizard view):</p>
<ul>
<li>Under <b>Device</b>, double-click <b>RTE_Device.h</b> and:<ul>
<li>enable <b>USB OTG Full-speed</b> and under it:<ul>
<li>enable <b>Host [Driver_USBH0]</b></li>
<li>disable <b>Host [Driver_USBH0]:Overcurrent Detection Pin</b></li>
</ul>
</li>
</ul>
</li>
<li>Double-click <b>USB:USBH_Config_0.h</b> and under <b>USB Host 0</b> change:<ul>
<li>set <b>Maximum Pipes in system</b> to <b>4</b></li>
</ul>
</li>
</ul>
<p>Before building and downloading the project to the target, make sure that the correct debugger is set in the <b>Options for Target</b> dialog (ALT + F7). You may then build and download the example project to the evaluation board using the µVision commands:</p>
<ul>
<li><b>Project</b> --&gt; <b>Build target (F7)</b></li>
<li><b>Flash</b> --&gt; <b>Download (F8)</b></li>
<li><b>Debug</b> --&gt; <b>Start/Stop Debug Session (Ctrl + F5)</b></li>
<li><b>Debug</b> --&gt; <b>Run (F5)</b></li>
</ul>
<p>After these steps, the project should start executing on your evaluation kit. In case of errors, refer to the Evaluation Board User's Guide for configuration information.</p>
<h3><a class="anchor" id="autotoc_md73"></a>
Using the "USB Host CDC" Project</h3>
<h4><a class="anchor" id="autotoc_md74"></a>
Hardware Setup</h4>
<ul>
<li>Verify all jumper settings on the target hardware.</li>
<li>Connect an USB CDC ACM Device (for example another development board with this example project: <a class="el" href="USB_Device.html#dev_cdc_tutorial">USB Device Virtual COM Port</a>) to the development board's <b>USBFS</b> connector. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
      <script type="text/javascript">
        <!--
        writeFooter.call(this);
        //-->
      </script> 
    </li>
  </ul>
</div>
</body>
</html>
