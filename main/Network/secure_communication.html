<!-- HTML header for doxygen 1.9.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Network Component: Secure Communication</title>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="tabs.js"></script>
<script type="text/javascript" src="footer.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="URL_keys.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<script type="text/javascript" src="darkmode_toggle.js"></script>
<link href="extra_stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="extra_navtree.css" rel="stylesheet" type="text/css"/>
<link href="extra_search.css" rel="stylesheet" type="text/css"/>
<link href="extra_tabs.css" rel="stylesheet" type="text/css"/>
<link href="version.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../version.js"></script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 55px;">
  <td id="projectlogo" style="padding: 1.5em;"><img alt="Logo" src="armkeil_white_h.png"/></td>
  <td style="padding-left: 1em; padding-bottom: 1em;padding-top: 1em;">
   <div id="projectname">Network Component
   &#160;<span id="projectnumber"><script type="text/javascript">
     <!--
     writeHeader.call(this);
     writeVersionDropdown.call(this, "Network Component");
     //-->
    </script>
   </span>
   </div>
   <div id="projectbrief">MDK Middleware for IPv4 and IPv6 Networking</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
  <!--END !PROJECT_NAME-->
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<div id="CMSISnav" class="tabs1">
  <ul class="tablist">
    <script type="text/javascript">
      writeComponentTabs.call(this);
    </script>
  </ul>
</div>
<script type="text/javascript">
  writeSubComponentTabs.call(this);
</script>
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('secure_communication.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Secure Communication </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_src_securing_communication"></a> In today's world, <b>secure communication</b> is crucial for many applications to protect data transmission between two network nodes. The <a href="https://en.wikipedia.org/wiki/Transport_Layer_Security" target="_blank">Transport Layer Security (TLS)</a> protocol is a standardized technology for establishing a secure, encrypted and authenticated link between two parties over an insecure network. TLS is an industry standard and is used in millions of devices and websites.</p>
<p>The Network component offers two ways to secure communication in an application:</p><ol type="1">
<li><a class="el" href="secure_communication.html#use_mbed_tls">Using Mbed TLS</a></li>
<li><a class="el" href="secure_communication.html#use_secure_components">Using Secure Services</a></li>
</ol>
<h1><a class="anchor" id="use_mbed_tls"></a>
Using Mbed TLS</h1>
<p>Although the Network component does not offer encryption and secure communication on its own, you can use Arm's <a href="https://www.trustedfirmware.org/projects/mbed-tls/" target="_blank">mbed TLS</a> software component to achieve this.</p>
<div class="image">
<img src="secure_com_sw_stack.png" alt=""/>
</div>
<p>From the bottom up:</p>
<ul>
<li>The <b>Cortex-M-based microcontroller</b> provides the processor core, storage, memory and network interface.</li>
<li>The <b>CMSIS-RTOS</b> compliant operating system provides standard services such as scheduling and thread-safety.</li>
<li>The <b>Network Component</b> provides services, sockets (TCP/IP) and the interface for network communication.</li>
<li>Building on top of the Network Component, <b>mbed TLS</b> provides an abstraction layer for secure communication.</li>
<li>The <b>application code</b> uses Mbed TLS to abstract the secure communication from itself.</li>
</ul>
<h2><a class="anchor" id="autotoc_md3"></a>
Why Mbed TLS?</h2>
<p>The Mbed TLS library is designed for ease-of-use. The library is documented and has examples so you can easily understand how to use it. In the Network Component, Mbed TLS is used under the <a href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank">Apache 2.0 license</a>, enabling you to use it in both open source and closed source projects. Mbed TLS is a fully featured and standards compliant SSL library offering server and client functionality in one single package.</p>
<h2><a class="anchor" id="autotoc_md4"></a>
Difference between SSL/TLS</h2>
<p>The TLS protocol is the successor of the SSL protocol. Just like its predecessor, the TLS protocol provides communication security for connections over possibly untrusted networks, like the Internet. The main difference between TLS and SSL is the increased standardization of the workings of the protocol. SSL itself was designed and developed by Netscape. The newer TLS standard is defined in a number of <a class="el" href="group__RFC__list.html#mbed_rfcs">public RFCs</a> and is extended periodically to counter possible weaknesses or add much needed functionality.</p>
<h2><a class="anchor" id="autotoc_md5"></a>
Parts of an SSL/TLS Library</h2>
<p>In order to perform the SSL or TLS protocol, a number of supporting functionality is required. The SSL/TLS library:</p>
<ul>
<li>needs to perform symmetric cryptographic operations, such as <a href="https://en.wikipedia.org/wiki/Advanced_Encryption_Standard" target="_blank">AES</a>, to encrypt the data over the connection.</li>
<li>uses asymmetric cryptographic operations, such as <a href="https://en.wikipedia.org/wiki/RSA_%28cryptosystem%29" target="_blank">RSA</a>, for identifying and authenticating the parties of the connection.</li>
<li>uses message digest operations, such as the <a href="https://en.wikipedia.org/wiki/SHA-2" target="_blank">SHA-256</a> hash algorithm, to protect the integrity of the information sent over the wire.</li>
<li>needs to be able to parse, understand and use <a href="https://en.wikipedia.org/wiki/X.509" target="_blank">X.509</a> certificates.</li>
<li>has to perform network operations to send and receive the protocol packets.</li>
</ul>
<p>All of this is hidden from most users and wrapped inside an SSL library, such as Mbed TLS, which developers can use to implement SSL or TLS in their applications.</p>
<p>For more information on Mbed TLS and how it works, visit the <a href="https://www.trustedfirmware.org/projects/mbed-tls/" target="_blank">high-level design</a> overview page.</p>
<h2><a class="anchor" id="add_mbedtls"></a>
Add the mbed TLS library to a µVision project</h2>
<p>The <a class="el" href="nw_examples.html">Network Examples</a> section carries two examples for secure communication over the IP network: SSL Server and SSL Client. To use the Mbed TLS library in your own projects, follow these steps:</p>
<ol type="1">
<li>Download the <b>ARM:mbedTLS</b> library from  <script>link_ext('SW-Pack');</script> or use  <script>link_ext('uv4_ca_packinstaller');</script></li>
<li>Open or create a project using the <b>Network Component</b>.</li>
<li>Configure the Network Component as required by your application (Ethernet settings, TCP/IP communication, etc.).</li>
<li>In the <b>Manage Run-Time Environment</b> window expand <b>Security</b> and enable <b>Mbed TLS</b>: <div class="image">
<img src="add_mbedTLS.png" alt=""/>
</div>
</li>
<li>Configure Mbed TLS using the <code>mbedTLS_config.h</code> file under <b>Security</b> in the <b>Project</b> window. <div class="image">
<img src="mbedTLS_config_h.png" alt=""/>
</div>
</li>
<li>Use the <b>Mbed TLS</b> API to secure your communication.</li>
</ol>
<dl class="section note"><dt>Note</dt><dd>You can use the Mbed TLS API in parallel to any of the <a class="el" href="secure_communication.html#use_secure_components">secure services</a> that are part of the Network Component.</dd></dl>
<h1><a class="anchor" id="use_secure_components"></a>
Using Secure Services</h1>
<p>The Network Component offers secure software components that are using <a class="el" href="secure_communication.html#use_mbed_tls">Mbed TLS</a>. The user of the Network Component does not see the Mbed TLS API as it is hidden by the standard API of the secure component.</p>
<p>Currently, the following component is available in a secure variant:</p>
<ul>
<li><a class="el" href="secure_communication.html#https_server">HTTPS Server</a></li>
<li><a class="el" href="secure_communication.html#smtps_client">SMTPS Client</a></li>
</ul>
<p>To be able to communicate securely, you will need to generate appropriate certificates for the server. The section <a class="el" href="secure_communication.html#cert_creation">Creating your own certificates and keys</a> explains how to achieve this for the secure components by using additional tools that are part of the Network Component.</p>
<h2><a class="anchor" id="https_server"></a>
HTTPS Server</h2>
<p>The web server and the compact web server have secure variants available. In the <b>Manage Run-Time Environment</b> window simply select the appropriate variant:</p>
<div class="image">
<img src="select_https.png" alt=""/>
</div>
<h3><a class="anchor" id="add_ssl_to_http"></a>
Converting the HTTP server to HTTPS</h3>
<p>It is also possible to convert an already existing (compact) web server to a secure HTTPS web server. A few simple steps are required to achieve this:</p>
<ol type="1">
<li>Download and install the <b>ARM:mbedTLS</b> Software Pack (see <a class="el" href="secure_communication.html#add_mbedtls">Add the mbed TLS library to a µVision project</a>).</li>
<li>Change the following software components in the Manage Run-Time Environment:<ul>
<li>Set <b>Network:Service:Web Server (Compact)</b> variant to <b>HTTPS</b>. This adds the file <code>Net_Security.c</code> to the project which contains test keys/certificates. To change them, follow the steps provided in <a class="el" href="secure_communication.html#cert_creation">Creating your own certificates and keys</a>.</li>
<li>Enable <b>Security:mbed TLS</b> or resolve this dependency automatically.</li>
</ul>
</li>
<li>Update the <code>mbedTLS_Config.h</code> configuration file with the following (a copy named <code>mbedTLS_config_HTTPS.h</code> is available in the <b>Template</b> folder):</li>
</ol>
<div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> *  Copyright The Mbed TLS Contributors</span></div>
<div class="line"><span class="comment"> *  SPDX-License-Identifier: Apache-2.0 OR GPL-2.0-or-later</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define MBEDTLS_CONFIG_VERSION 0x03060000</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* System support */</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* mbed TLS feature support */</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_ENTROPY_HARDWARE_ALT</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_AES_ROM_TABLES</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_CIPHER_MODE_CBC</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_CIPHER_MODE_CFB</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_CIPHER_MODE_CTR</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_CIPHER_PADDING_PKCS7</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_CIPHER_PADDING_ONE_AND_ZEROS</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_CIPHER_PADDING_ZEROS_AND_LEN</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_CIPHER_PADDING_ZEROS</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_KEY_EXCHANGE_PSK_ENABLED</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_KEY_EXCHANGE_DHE_PSK_ENABLED</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_KEY_EXCHANGE_RSA_PSK_ENABLED</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_KEY_EXCHANGE_RSA_ENABLED</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_KEY_EXCHANGE_DHE_RSA_ENABLED</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_GENPRIME</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_NO_PLATFORM_ENTROPY</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_PK_RSA_ALT_SUPPORT</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_PKCS1_V15</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_PKCS1_V21</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_ALL_ALERT_MESSAGES</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_ENCRYPT_THEN_MAC</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_EXTENDED_MASTER_SECRET</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_RENEGOTIATION</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_MAX_FRAGMENT_LENGTH</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_PROTO_TLS1_2</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_ALPN</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_SESSION_TICKETS</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_SERVER_NAME_INDICATION</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_X509_RSASSA_PSS_SUPPORT</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* mbed TLS modules */</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_AES_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_ASN1_PARSE_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_BASE64_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_BIGNUM_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_CAMELLIA_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_CCM_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_CIPHER_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_CTR_DRBG_C</span></div>
<div class="line"><span class="comment">//#define MBEDTLS_DEBUG_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_DES_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_DHM_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_ENTROPY_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_GCM_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_HMAC_DRBG_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_MD_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_MD5_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_OID_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_PEM_PARSE_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_PK_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_PK_PARSE_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_PKCS5_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_PKCS12_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_PLATFORM_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_RIPEMD160_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_RSA_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SHA1_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SHA224_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SHA256_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SHA512_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_CACHE_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_COOKIE_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_TICKET_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_SRV_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_TLS_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_X509_USE_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_X509_CRT_PARSE_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_X509_CSR_PARSE_C</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* SSL options */</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_IN_CONTENT_LEN      4096 </span><span class="comment">/**&lt; Maximum length (in bytes) of incoming plaintext fragments. */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_OUT_CONTENT_LEN     4096 </span><span class="comment">/**&lt; Maximum length (in bytes) of outgoing plaintext fragments. */</span><span class="preprocessor"></span></div>
</div><!-- fragment --><ol type="1">
<li>Set your device's heap to 90KB or more (or increase existing). In the <b>Project</b> window, under <b>Device</b>, open the file <code>startup_xxx.s</code> and set <div class="fragment"><div class="line">Heap_Size = 0x16000</div>
</div><!-- fragment --> or more, depending on your application.</li>
<li>Configure the RTX threads<ul>
<li>If you use <b>RTX v5</b>, you do not need to change the <b>RTX settings</b>, because all resources are statically allocated.</li>
</ul>
</li>
<li>Update the HTTP Server configuration file (<code>Net_Config_HTTP_Server.h</code>):<ul>
<li>Change the <b>Port Number</b> to <code>443</code> or to <code>0</code> (auto-selects 443 for HTTPS or 80 for HTTP)</li>
</ul>
</li>
<li>Build the example and download to Flash. If it fails, please check your "Read/Write Memory Areas" in your target options.</li>
<li>You can test the example from a browser by connecting to "https://board_name" or "https://ip_address" (depending on your settings in <code>Net_Config.h</code> file.</li>
</ol>
<dl class="section note"><dt>Note</dt><dd><ul>
<li>The first connection might take a while (a few seconds up to 10s) and depends on the browser and how many sockets/sessions it initially opens (differs in Edge, Chrome, Firefox, etc.). This delay is normal and due to the time required for asymmetric cryptography calculations on the target. After the initial delay, the HTTPS server works almost as fast the HTTP server.</li>
<li>Your browser will complain during the connection that the certificate has a problem or is not trusted. You will need to add the certificate to your browser's trusted certificate storage manually.</li>
<li>Do not use the test certificate in productive environments as it is not secret. Before shipping your product, make sure that you have added your <a class="el" href="secure_communication.html#cert_creation">own certificates and keys</a>.</li>
</ul>
</dd></dl>
<h3><a class="anchor" id="cert_creation"></a>
Creating your own certificates and keys</h3>
<p>The Network Component's HTTPS service adds the file <code>Net_Security.c</code> to the project. This file contains generic test keys/certificates which enable the application to run out of the box. If you want to adapt the keys/certificates to your needs, you can do this by modifying this file or by executing the batch file <code>Net_Security.bat</code> that is part of the Network Component.</p>
<p><code>Net_Security.bat</code> can be registered in µVision under <b>Tools</b> for general usage:</p>
<ul>
<li>Go to <b>Tools</b> --&gt; <b>Customize Tools Menu</b></li>
<li>Click the <b>New (Insert)</b> button and enter a meaningful name, for example "Net_Security Keys"</li>
<li>In the <b>Command</b> box enter <code>$PRTE\\Network\\Net_Security.bat</code></li>
<li>In the <b>Initial Folder</b> box enter <code>$PRTE\\Network</code></li>
<li>In the <b>Arguments</b> box enter <code>\@K</code></li>
<li>Enable <b>Run Independent</b></li>
</ul>
<div class="image">
<img src="Net_Security_Keys.PNG" alt=""/>
<div class="caption">
Settings required for the Net_Security.bat file</div></div>
<p>This setting is needed only once in µVision and will work for any project since it uses project related folders.</p>
<p>The file <code>Net_Security.bat</code> is copied to the project (.\RTE\Network) folder together with <code>Net_Security.c</code>. As it is project specific, the batch file can be customized to reflect your specific values for the certificates:</p>
<ul>
<li>CA and Server Private Keys: type (default: RSA) and key_size (default: 2048)</li>
<li>CA certificate: issuer_name (default:CN="Test CA",O="Unknown",C=US), serial (default: 0), not_before (default: 20200101000000), not_after (20301231235959)</li>
<li>Server certificate: subject_name (default: CN="localhost",O="MyOrganization",C=US), serial (default: 1), not_before (default: 20200101000000), not_after (20301231235959)</li>
</ul>
<dl class="section note"><dt>Note</dt><dd><ul>
<li>Replace CN="localhost" with your hostname so that you can add the server's root CA certificate to your "Trusted
  Root Certification Authorities". Then the browser will not complain that the website is not trusted.</li>
</ul>
</dd></dl>
<p>The beginning of the file contains some environment settings that can also be changed:</p>
<ul>
<li>RTEPATH: specifies the path to Software Packs. This is required if the batch file is executed directly from Windows. When it is executed from µVision, it is set automatically.</li>
<li>Pack Versions (MDK-MW and mbedTLS): only required if you want to select a specific Pack version. By default, the latest available Pack is used.</li>
</ul>
<p>As soon as you run the batch file from the <b>Tools</b> menu, it will create the keys/certificates and change the <code>Net_Security.c</code> automatically to reflect the changes. You can then continue building the project.</p>
<dl class="section note"><dt>Note</dt><dd><ul>
<li>The Net_Security.bat file calls the pem2mw.exe utility. This utility does not support all kinds of certificates.</li>
<li>If you are using an unsupported certificate, you can bypass pem2mw easily by manually creating the output Net_Security.c file:<ul>
<li>Adapt Net_Security.bat to skip calling pem2mw (optional)</li>
<li>Copy the contents of ca.crt into NetSecurity_ServerCA structure in Net_Security.c and add leading " and trailing \n" to each line</li>
<li>Copy the contents of server.crt into NetSecurity_ServerCert structure in Net_Security.c and add leading " and trailing \n" to each line</li>
<li>Copy the contents of server.key into NetSecurity_ServerKey structure in Net_Security.c and add leading " and trailing \n" to each line</li>
</ul>
</li>
</ul>
</dd></dl>
<p><b>Code Example</b></p>
<p><em>Server.key</em></p>
<div class="fragment"><div class="line">-----BEGIN PUBLIC KEY-----</div>
<div class="line">MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEd3Jlb4FLOZJ51eHxeB+sbwmaPFyh</div>
<div class="line">sONTUYNLCLZeC1clkM2vj3aTYbzzSs/BHl4HToQmvd4Evm5lOUVElhfeRQ==</div>
<div class="line">-----END PUBLIC KEY-----</div>
</div><!-- fragment --><p><em>Net_Security.c</em></p>
<div class="fragment"><div class="line"><span class="keyword">const</span> uint8_t NetSecurity_ServerKey[] =</div>
<div class="line"><span class="stringliteral">&quot;-----BEGIN PUBLIC KEY-----\n&quot;</span></div>
<div class="line"><span class="stringliteral">&quot;MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEd3Jlb4FLOZJ51eHxeB+sbwmaPFyh\n&quot;</span></div>
<div class="line"><span class="stringliteral">&quot;sONTUYNLCLZeC1clkM2vj3aTYbzzSs/BHl4HToQmvd4Evm5lOUVElhfeRQ==\n&quot;</span></div>
<div class="line"><span class="stringliteral">&quot;-----END PUBLIC KEY-----\n&quot;</span></div>
<div class="line">;</div>
</div><!-- fragment --><h2><a class="anchor" id="smtps_client"></a>
SMTPS Client</h2>
<p>The e-mail client is available in a secure variant. In the <b>Manage Run-Time Environment</b> window, simply select the appropriate variant:</p>
<div class="image">
<img src="select_smtps.png" alt=""/>
</div>
<h3><a class="anchor" id="add_ssl_to_smtp"></a>
Converting the SMTP client to SMTPS</h3>
<p>It is also possible to convert an already existing e-mail client to a secure SMTPS e-mail client. A few simple steps are required to achieve this:</p>
<ol type="1">
<li>Download and install the <b>ARM:mbedTLS</b> Software Pack (see <a class="el" href="secure_communication.html#add_mbedtls">Add the mbed TLS library to a µVision project</a>).</li>
<li>Change the following software components in the Manage Run-Time Environment:<ul>
<li>Set <b>Network:Service:SMTP Client</b> variant to SMTPS. This adds the file <code>Net_Security.c</code> to the project which contains an empty CA certificate. To define it, follow the steps provided in <a class="el" href="secure_communication.html#cert_adding">Adding server root CA certificate</a>.</li>
<li>Enable <b>Security:mbed TLS</b> or resolve this dependency automatically.</li>
</ul>
</li>
<li><p class="startli">Update the <code>mbedTLS_Config.h</code> configuration file with the following (a copy named <code>mbedTLS_config_SMTPS.h</code> is available in the <b>Template</b> folder):</p>
<div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> *  Copyright The Mbed TLS Contributors</span></div>
<div class="line"><span class="comment"> *  SPDX-License-Identifier: Apache-2.0 OR GPL-2.0-or-later</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define MBEDTLS_CONFIG_VERSION 0x03060000</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* System support */</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* mbed TLS feature support */</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_ENTROPY_HARDWARE_ALT</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_AES_ROM_TABLES</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_CIPHER_MODE_CBC</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_CIPHER_PADDING_PKCS7</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_ECP_DP_SECP256R1_ENABLED</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_ECP_DP_SECP384R1_ENABLED</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_ECP_NIST_OPTIM</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_ECDSA_DETERMINISTIC</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_KEY_EXCHANGE_PSK_ENABLED</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_KEY_EXCHANGE_ECDHE_PSK_ENABLED</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_KEY_EXCHANGE_RSA_PSK_ENABLED</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_KEY_EXCHANGE_ECDHE_RSA_ENABLED</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_KEY_EXCHANGE_ECDHE_ECDSA_ENABLED</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_ERROR_STRERROR_DUMMY</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_NO_PLATFORM_ENTROPY</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_PK_RSA_ALT_SUPPORT</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_PKCS1_V15</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_PKCS1_V21</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_ALL_ALERT_MESSAGES</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_ENCRYPT_THEN_MAC</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_EXTENDED_MASTER_SECRET</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_RENEGOTIATION</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_MAX_FRAGMENT_LENGTH</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_PROTO_TLS1_2</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_ALPN</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_SESSION_TICKETS</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_SERVER_NAME_INDICATION</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* mbed TLS modules */</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_AES_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_ASN1_PARSE_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_ASN1_WRITE_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_BASE64_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_BIGNUM_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_CCM_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_CIPHER_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_CTR_DRBG_C</span></div>
<div class="line"><span class="comment">//#define MBEDTLS_DEBUG_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_ECDH_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_ECDSA_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_ECP_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_ENTROPY_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_GCM_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_HMAC_DRBG_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_MD_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_OID_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_PEM_PARSE_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_PK_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_PK_PARSE_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_PLATFORM_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_RSA_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SHA1_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SHA224_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SHA256_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SHA512_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_CACHE_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_COOKIE_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_TICKET_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_CLI_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_TLS_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_X509_USE_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_X509_CRT_PARSE_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_X509_CRL_PARSE_C</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* SSL options */</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_IN_CONTENT_LEN      4096 </span><span class="comment">/**&lt; Maximum length (in bytes) of incoming plaintext fragments. */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_OUT_CONTENT_LEN     4096 </span><span class="comment">/**&lt; Maximum length (in bytes) of outgoing plaintext fragments. */</span><span class="preprocessor"></span></div>
</div><!-- fragment --></li>
<li>Set your device's heap to at least 49 KB or increase appropriately. In the <b>Project</b> window, under <b>Device</b>, open the file <code>startup_xxx.s</code> and set <div class="fragment"><div class="line">Heap_Size = 0xC000</div>
</div><!-- fragment --> or more, depending on your application.</li>
<li>Configure the RTX threads<ul>
<li>If you use <b>RTX v5</b>, you do not need to change the <b>RTX settings</b>, because all recources are statically allocated.</li>
</ul>
</li>
<li>Build the example and download to Flash. If it fails, please check your "Read/Write Memory Areas" in your target options.</li>
<li>You can test the example by sending an e-mail to your e-mail account, for example to Gmail or Yahoo.</li>
</ol>
<h3><a class="anchor" id="cert_adding"></a>
Adding server root CA certificate</h3>
<p>The SMTPS service of the Network Component adds the <code>Net_Security.c</code> file to the project. This file contains an empty section for the e-mail server root CA certificate, so you cannot initially build the application. You must provide a valid root CA certificate for the server that you use to send e-mail. The certificate must be provided in PEM-encoding. Copy the contents of the certificate into the NetSecurity_EmailServerCA structure in <code>Net_Security.c</code> and add a leading " and a trailing \n" to each line.</p>
<div class="fragment"><div class="line"><span class="comment">// Email Server root CA certificate</span></div>
<div class="line"><span class="keyword">const</span> uint8_t NetSecurity_EmailServerCA[] =</div>
<div class="line"><span class="stringliteral">&quot;-----BEGIN CERTIFICATE-----\n&quot;</span></div>
<div class="line"><span class="stringliteral">&quot;... base64 data ...\n&quot;</span></div>
<div class="line"><span class="stringliteral">&quot;-----END CERTIFICATE-----\n&quot;</span>;</div>
</div><!-- fragment --><p>Verifying the e-mail server is required by default to increase e-mail security. If you do not want to verify the server, you can disable server verification by defining the <b>SMTPS_SERVER_VERIFY_NONE</b> in your project (Options for Component Class Network - SMTP_Client - C/C++ Preprocessor Symbols - Define).</p>
<dl class="section note"><dt>Note</dt><dd>It is not necessary to create your own certificates or keys to send secure e-mail using SMTPS. </dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
      <script type="text/javascript">
        <!--
        writeFooter.call(this);
        //-->
      </script> 
    </li>
  </ul>
</div>
</body>
</html>
