<!-- HTML header for doxygen 1.9.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>USB Component: CDC: Communication Device Class (NCM)</title>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="tabs.js"></script>
<script type="text/javascript" src="footer.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="URL_keys.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<script type="text/javascript" src="darkmode_toggle.js"></script>
<link href="extra_stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="extra_navtree.css" rel="stylesheet" type="text/css"/>
<link href="extra_search.css" rel="stylesheet" type="text/css"/>
<link href="extra_tabs.css" rel="stylesheet" type="text/css"/>
<link href="version.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../version.js"></script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 55px;">
  <td id="projectlogo" style="padding: 1.5em;"><img alt="Logo" src="armkeil_white_h.png"/></td>
  <td style="padding-left: 1em; padding-bottom: 1em;padding-top: 1em;">
   <div id="projectname">USB Component
   &#160;<span id="projectnumber"><script type="text/javascript">
     <!--
     writeHeader.call(this);
     writeVersionDropdown.call(this, "USB Component");
     //-->
    </script>
   </span>
   </div>
   <div id="projectbrief">MDK Middleware for USB Device and Host Communication</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
  <!--END !PROJECT_NAME-->
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<div id="CMSISnav" class="tabs1">
  <ul class="tablist">
    <script type="text/javascript">
      writeComponentTabs.call(this);
    </script>
  </ul>
</div>
<script type="text/javascript">
  writeSubComponentTabs.call(this);
</script>
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('group__usbd__cdcFunctions__ncm.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="summary">
<a href="#groups">Content</a>  </div>
  <div class="headertitle"><div class="title">CDC: Communication Device Class (NCM)<div class="ingroups"><a class="el" href="group__usbd.html">USB Device</a> &raquo; <a class="el" href="group__usbd__DevClassFunctions.html">Device Class</a></div></div></div>
</div><!--header-->
<div class="contents">

<p>Implement application specific behavior of a Communication Device Class (CDC) USB Device using the sub-class Network Control Model (NCM) for <a href="https://en.wikipedia.org/wiki/Ethernet_over_USB" target="_blank">Ethernet-over-USB</a> applications.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="groups" name="groups"></a>
Content</h2></td></tr>
<tr class="memitem:group__usbd__cdcFunctions__ncm__api"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__usbd__cdcFunctions__ncm__api.html">User API</a></td></tr>
<tr class="memdesc:group__usbd__cdcFunctions__ncm__api"><td class="mdescLeft">&#160;</td><td class="mdescRight">User API reference of the Communication Device Class (NCM). <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:group__usbd__cdcFunctions__ncm__conf"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__usbd__cdcFunctions__ncm__conf.html">Configuration</a></td></tr>
<tr class="memdesc:group__usbd__cdcFunctions__ncm__conf"><td class="mdescLeft">&#160;</td><td class="mdescRight">Configuration of the USB Device CDC (NCM) Class. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Description</h2>
<p>Implement application specific behavior of a Communication Device Class (CDC) USB Device using the sub-class Network Control Model (NCM) for <a href="https://en.wikipedia.org/wiki/Ethernet_over_USB" target="_blank">Ethernet-over-USB</a> applications. </p>
<p>The ability to connect Ethernet devices via USB ports is known as <b>Ethernet-over-USB</b>. Various industry protocols are available to achieve this. One of the most advanced protocols is the CDC (NCM) class which is supported by the USB Component.</p>
<p>The <a href="http://www.linux-usb.org/usbnet/" target="_blank">usbnet</a> Kernel module in Linux hosts enables you to attach a USB Device to the host to emulate an Ethernet device. There is no native Ethernet-over-USB support in Windows.</p>
<p>Refer to:</p><ul>
<li><a class="el" href="USB_Classes.html#CDC">CDC: Communication Device Class</a> for an overview of the CDC class. </li>
</ul>
<p>The USB Component allows multiple instances of the CDC class. This feature is used to create USB Composite Devices. Each CDC class instance has a separate files and interface functions:</p><ul>
<li>A CDC configuration file <a class="el" href="group__usbd__cdcFunctions__ncm__conf.html">USBD_Config_CDC_n.h</a>.</li>
<li>An application-specific user source code file, which can be implemented with the  <script>link_ext('uv4_ca_sourcefiles');</script> <a class="el" href="group__usbd__cdcFunctions__ncm.html#USBD_User_CDC_NCM_UCT">USBD_User_CDC_NCM_n.c</a>, or <a class="el" href="group__usbd__cdcFunctions__ncm.html#USBD_User_CDC_NCM_ETH_UCT">USBD_User_CDC_NCM_ETH_n.c</a>.</li>
<li>Functions that start with the prefix <b>USBD_CDCn_NCM</b> are available for each instance of a CDC NCM class.</li>
</ul>
<p>This documentation uses <em>n</em> as a placeholder for the instance number <em>0</em> - <em>7</em>. Most applications only require one instance of a CDC NCM class. For the first CDC NCM class instance the instance number is 0:</p><ul>
<li><b>USBD_Config_CDC_0.h</b></li>
<li><b>USBD_User_CDC_NCM_0.c</b></li>
<li>The function prefix is <b>USBD_CDC0_NCM</b></li>
</ul>
<p><b>Descriptor</b> <b>Requirements</b> The following descriptors are required in an USB CDC NCM Device:</p><ul>
<li>Standard Device Descriptor</li>
<li>Standard Configuration Descriptor</li>
<li>Interface Association Descriptor</li>
<li>CDC Header Functional Descriptor</li>
<li>CDC Union Functional Descriptor</li>
<li>CDC Ethernet Networking Functional Descriptor</li>
<li>NCM Functional Descriptor</li>
<li>Standard Interface Descriptor for the CDC Class communication interface</li>
<li>Standard Endpoint Descriptor for Interrupt IN endpoint</li>
<li>Standard Interface Descriptor for the CDC Class data interface</li>
<li>Standard Endpoint Descriptors for Bulk IN and Bulk OUT endpoints</li>
</ul>
<p>The necessary descriptors are automatically generated by the USB Middleware Component. The page <a class="el" href="USB_Concepts.html#USB_Descriptors">USB Descriptors</a> provides more information on the topic.</p>
<p><b>Software Structure</b></p>
<p>The handling for the CDC class endpoint events is implemented in <b>USBD_CDCn_Int_Thread</b> and <b>USBD_CDCn_Bulk_Thread</b> which are started by <a class="el" href="group__usbd__coreFunctions__api.html#ga65ba44a47e3fa46a15f70bab9917c8ca">USBD_Initialize</a>. Each instance of a CDC class runs an instance of <b>USBD_CDCn_Int_Thread</b> and <b>USBD_CDCn_Bulk_Thread</b>.</p>
<p>The thread USBD_CDCn_Int_Thread handles Interrupt IN Endpoint whereas the USBD_CDCn_Bulk_Thread handles the Bulk IN and Bulk OUT Endpoints.</p>
<div class="mscgraph">
<img src="msc_inline_mscgraph_4.png" alt="msc_inline_mscgraph_4" border="0" usemap="#msc_inline_mscgraph_4.map"/>
<map name="msc_inline_mscgraph_4.map" id="msc_inline_mscgraph_4.map"><area href="group__usbd__coreFunctions__api.html#ga65ba44a47e3fa46a15f70bab9917c8ca" shape="rect" coords="16,104,105,117" alt=""/>
<area href="group__usbd__coreFunctions__api.html#gad97153303fc0a6f51c1c20ac050b238f" shape="rect" coords="25,155,96,168" alt=""/>
<area href="group__usbd__cdcFunctions__ncm__api.html#ga6966c46d11f2592edf7dde71f4220e3f" shape="rect" coords="16,250,105,263" alt=""/>
<area href="group__usbd__cdcFunctions__ncm__api.html#ga6966c46d11f2592edf7dde71f4220e3f" shape="rect" coords="16,263,105,276" alt=""/>
<area href="group__usbd__cdcFunctions__ncm__api.html#ga6966c46d11f2592edf7dde71f4220e3f" shape="rect" coords="34,276,87,289" alt=""/>
<area href="group__usbd__cdcFunctions__ncm__api.html#ga5888e54f798b2bf2d20bdc41b1e8af55" shape="rect" coords="16,314,105,327" alt=""/>
<area href="group__usbd__cdcFunctions__ncm__api.html#ga5888e54f798b2bf2d20bdc41b1e8af55" shape="rect" coords="16,327,105,340" alt=""/>
<area href="group__usbd__cdcFunctions__ncm__api.html#ga5888e54f798b2bf2d20bdc41b1e8af55" shape="rect" coords="22,340,99,353" alt=""/>
<area href="group__usbd__cdcFunctions__ncm__api.html#gae9c578e2dbb6b54b8963adee536aea11" shape="rect" coords="16,378,105,391" alt=""/>
<area href="group__usbd__cdcFunctions__ncm__api.html#gae9c578e2dbb6b54b8963adee536aea11" shape="rect" coords="13,391,108,404" alt=""/>
<area href="group__usbd__cdcFunctions__ncm__api.html#gae9fa4907d191f9e78483d588eef7081f" shape="rect" coords="16,410,105,423" alt=""/>
<area href="group__usbd__cdcFunctions__ncm__api.html#gae9fa4907d191f9e78483d588eef7081f" shape="rect" coords="16,423,105,436" alt=""/>
<area href="group__usbd__cdcFunctions__ncm__api.html#gae55b3d343bccc5829fc5987a86cbe25d" shape="rect" coords="16,442,105,455" alt=""/>
<area href="group__usbd__cdcFunctions__ncm__api.html#gae55b3d343bccc5829fc5987a86cbe25d" shape="rect" coords="16,455,105,468" alt=""/>
<area href="group__usbd__cdcFunctions__ncm__api.html#gae55b3d343bccc5829fc5987a86cbe25d" shape="rect" coords="46,468,75,481" alt=""/>
<area href="group__usbd__cdcFunctions__ncm__api.html#gaf2b9c281b2f5ba8d26ea598633d5c9ad" shape="rect" coords="16,487,105,500" alt=""/>
<area href="group__usbd__cdcFunctions__ncm__api.html#gaf2b9c281b2f5ba8d26ea598633d5c9ad" shape="rect" coords="31,500,90,513" alt=""/>
<area href="group__usbd__cdcFunctions__ncm__api.html#ga0731cb012344bc03b7132941e630a426" shape="rect" coords="16,519,105,532" alt=""/>
<area href="group__usbd__cdcFunctions__ncm__api.html#ga0731cb012344bc03b7132941e630a426" shape="rect" coords="28,532,93,545" alt=""/>
<area href="group__usbd__cdcFunctions__ncm__api.html#gae000e324025458f142e5b1d6d2750060" shape="rect" coords="16,570,105,583" alt=""/>
<area href="group__usbd__cdcFunctions__ncm__api.html#gae000e324025458f142e5b1d6d2750060" shape="rect" coords="13,583,108,596" alt=""/>
<area href="group__usbd__cdcFunctions__ncm__api.html#ga0a24001aff5d9af6e8b040dc0cde6445" shape="rect" coords="16,602,105,615" alt=""/>
<area href="group__usbd__cdcFunctions__ncm__api.html#ga0a24001aff5d9af6e8b040dc0cde6445" shape="rect" coords="16,615,105,628" alt=""/>
<area href="group__usbd__cdcFunctions__ncm__api.html#ga0a24001aff5d9af6e8b040dc0cde6445" shape="rect" coords="52,628,69,641" alt=""/>
<area href="group__usbd__cdcFunctions__ncm__api.html#ga74f401a77a548941e2c5ec998f4bf7f5" shape="rect" coords="16,647,105,660" alt=""/>
<area href="group__usbd__cdcFunctions__ncm__api.html#ga74f401a77a548941e2c5ec998f4bf7f5" shape="rect" coords="16,660,105,673" alt=""/>
<area href="group__usbd__cdcFunctions__ncm__api.html#ga74f401a77a548941e2c5ec998f4bf7f5" shape="rect" coords="46,673,75,686" alt=""/>
<area href="group__usbd__cdcFunctions__ncm__api.html#ga7ce93a9770eb6360bdd9d9c79be4f1b6" shape="rect" coords="16,692,105,705" alt=""/>
<area href="group__usbd__cdcFunctions__ncm__api.html#ga7ce93a9770eb6360bdd9d9c79be4f1b6" shape="rect" coords="19,705,102,718" alt=""/>
<area href="group__usbd__coreFunctions__api.html#ga9440f139618900f2011034e70cd7a528" shape="rect" coords="16,756,105,769" alt=""/>
<area href="group__usbd__coreFunctions__api.html#gabefe6dae72a49806a96b981c286d0aeb" shape="rect" coords="16,807,105,820" alt=""/>
<area href="group__usbd__coreFunctions__api.html#gabefe6dae72a49806a96b981c286d0aeb" shape="rect" coords="52,820,69,833" alt=""/>
</map>
</div>
<h2><a class="anchor" id="autotoc_md43"></a>
Implementation</h2>
<p>To <a class="el" href="usbd_create_app.html">create an USB Device</a> with a CDC NCM class:</p><ul>
<li>Set the required number for USB:Device:CDC class instances during the <a class="el" href="usbd_create_app.html#RTE_Software_Component_Selection">RTE Component Selection</a>.</li>
<li>Set the parameters in the configuration file <a class="el" href="group__usbd__cdcFunctions__ncm__conf.html">USBD_Config_CDC_n.h</a>.</li>
<li>Implement the application specific behavior using this <a class="el" href="group__usbd__cdcFunctions__ncm.html#USBD_User_CDC_NCM_UCT">template</a> <em>or</em> </li>
<li>Use the pre-built <a class="el" href="group__usbd__cdcFunctions__ncm.html#USBD_User_CDC_NCM_ETH_UCT">template file for Ethernet-over-USB</a>.</li>
</ul>
<p><a class="anchor" id="USBD_User_CDC_NCM_UCT"></a><b>User Code Template USBD_User_CDC_NCM.c</b></p>
<p>The following source code contains all the required callback functions and can be used to implement the application specific behavior of a USB CDC (NCM) Device.</p>
<div class="fragment"><div class="line"><span class="comment">/*------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * MDK Middleware - Component ::USB:Device:CDC</span></div>
<div class="line"><span class="comment"> * Copyright (c) 2004-2024 Arm Limited (or its affiliates). All rights reserved.</span></div>
<div class="line"><span class="comment"> *------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * Name:    USBD_User_CDC_NCM_%Instance%.c</span></div>
<div class="line"><span class="comment"> * Purpose: USB Device Communication Device Class (CDC)</span></div>
<div class="line"><span class="comment"> *          Network Control Model (NCM) User module</span></div>
<div class="line"><span class="comment"> * Rev.:    V1.0.7</span></div>
<div class="line"><span class="comment"> *----------------------------------------------------------------------------*/</span><span class="comment"></span></div>
<div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment"> * \addtogroup usbd_cdcFunctions</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * USBD_User_CDC_NCM_%Instance%.c implements the application specific functionality</span></div>
<div class="line"><span class="comment"> * of the CDC NCM class and is used to respond to control endpoint requests</span></div>
<div class="line"><span class="comment"> * as well as receive and send data to the USB Host.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * The implementation depends on the configuration file USBD_Config_CDC_%Instance%.h.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"> <span class="comment"></span></div>
<div class="line"><span class="comment">//! [code_USBD_User_CDC_NCM]</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="rl__usb_8h.html">rl_usb.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;USBD_Config_CDC_%Instance%.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifndef  RTE_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor">#error   This user template requires CMSIS-RTOS2!</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define USB_CDC_NUM             %Instance%       </span><span class="comment">/* USB CDC Instance number */</span><span class="preprocessor"></span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define MAX_IN_DATAGRAMS        10</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef  USBD_CDC%Instance%_NCM_MAC_ADDRESS_RAW</span></div>
<div class="line"><span class="preprocessor">#define MAC_ADDR_RAW            1</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef MAC_ADDR_RAW</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span>    *strMacAddress = USBD_CDC%Instance%_NCM_MAC_ADDRESS_RAW;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">wchar_t</span> *strMacAddress = USBD_CDC%Instance%_NCM_MAC_ADDRESS;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="keyword">static</span> uint8_t  MacAddress[6];</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> uint16_t LinkState;</div>
<div class="line"><span class="keyword">static</span> uint32_t LinkSpeed;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>{</div>
<div class="line">  uint32_t ntb_input_size;</div>
<div class="line">  uint16_t ntb_format;</div>
<div class="line">  uint16_t max_datagram_size;</div>
<div class="line">  uint16_t crc_mode;</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDC%Instance%_NCM_BM_NETWORK_CAPABILITIES &amp; 0x02) != 0)</span></div>
<div class="line">  uint8_t  net_address[6];</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor">#if (USBD_CDC%Instance%_NCM_W_NUMBER_MC_FILTERS != 0)</span></div>
<div class="line">  uint8_t  mc_filters[6*(USBD_CDC%Instance%_NCM_W_NUMBER_MC_FILTERS &amp; 0x7FFF)];</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor">#if (USBD_CDC%Instance%_NCM_B_NUMBER_POWER_FILTERS != 0)</span></div>
<div class="line">  uint8_t  power_filter_active[(USBD_CDC%Instance%_NCM_B_NUMBER_POWER_FILTERS + 7)/8];</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  uint16_t packet_filter_bitmap;</div>
<div class="line"><span class="preprocessor">#if (USBD_CDC%Instance%_NCM_BM_ETHERNET_STATISTICS != 0)</span></div>
<div class="line">  uint32_t eth_statistics[29];</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">} NCM_State;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> uint32_t FrameIN_Size;</div>
<div class="line"><span class="keyword">static</span> uint8_t  FrameIN [USBD_CDC%Instance%_NCM_W_MAX_SEGMENT_SIZE];</div>
<div class="line"><span class="keyword">static</span> uint8_t  FrameOUT[USBD_CDC%Instance%_NCM_W_MAX_SEGMENT_SIZE];</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> Connection_Thread (<span class="keywordtype">void</span> *arg);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> DataIN_Thread     (<span class="keywordtype">void</span> *arg);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> DataOUT_Thread    (<span class="keywordtype">void</span> *arg);</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef RTE_CMSIS_RTOS2_RTX5</span></div>
<div class="line"><span class="keyword">static</span> osRtxThread_t        connection_thread_cb_mem           __attribute__((section(<span class="stringliteral">&quot;.bss.os.thread.cb&quot;</span>)));</div>
<div class="line"><span class="keyword">static</span> uint64_t             connection_thread_stack_mem[512/8] __attribute__((section(<span class="stringliteral">&quot;.bss.os.thread.stack&quot;</span>)));</div>
<div class="line"><span class="keyword">static</span> osRtxThread_t        data_in_thread_cb_mem              __attribute__((section(<span class="stringliteral">&quot;.bss.os.thread.cb&quot;</span>)));</div>
<div class="line"><span class="keyword">static</span> uint64_t             data_in_thread_stack_mem   [512/8] __attribute__((section(<span class="stringliteral">&quot;.bss.os.thread.stack&quot;</span>)));</div>
<div class="line"><span class="keyword">static</span> osRtxThread_t        data_out_thread_cb_mem             __attribute__((section(<span class="stringliteral">&quot;.bss.os.thread.cb&quot;</span>)));</div>
<div class="line"><span class="keyword">static</span> uint64_t             data_out_thread_stack_mem  [512/8] __attribute__((section(<span class="stringliteral">&quot;.bss.os.thread.stack&quot;</span>)));</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> osThreadAttr_t connection_thread_attr = {</div>
<div class="line">  <span class="stringliteral">&quot;Connection_Thread&quot;</span>,</div>
<div class="line">  0U,</div>
<div class="line"><span class="preprocessor">#ifdef RTE_CMSIS_RTOS2_RTX5</span></div>
<div class="line"> &amp;connection_thread_cb_mem,</div>
<div class="line">  <span class="keyword">sizeof</span>(osRtxThread_t),</div>
<div class="line"> &amp;connection_thread_stack_mem[0],</div>
<div class="line">#<span class="keywordflow">else</span></div>
<div class="line">  NULL,</div>
<div class="line">  0U,</div>
<div class="line">  NULL,</div>
<div class="line">#endif</div>
<div class="line">  512U,</div>
<div class="line">  osPriorityNormal,</div>
<div class="line">  0U,</div>
<div class="line">  0U</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> osThreadAttr_t data_in_thread_attr = {</div>
<div class="line">  <span class="stringliteral">&quot;DataIN_Thread&quot;</span>,</div>
<div class="line">  0U,</div>
<div class="line"><span class="preprocessor">#ifdef RTE_CMSIS_RTOS2_RTX5</span></div>
<div class="line"> &amp;data_in_thread_cb_mem,</div>
<div class="line">  <span class="keyword">sizeof</span>(osRtxThread_t),</div>
<div class="line"> &amp;data_in_thread_stack_mem[0],</div>
<div class="line">#<span class="keywordflow">else</span></div>
<div class="line">  NULL,</div>
<div class="line">  0U,</div>
<div class="line">  NULL,</div>
<div class="line">#endif</div>
<div class="line">  512U,</div>
<div class="line">  osPriorityNormal,</div>
<div class="line">  0U,</div>
<div class="line">  0U</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> osThreadAttr_t data_out_thread_attr = {</div>
<div class="line">  <span class="stringliteral">&quot;DataOUT_Thread&quot;</span>,</div>
<div class="line">  0U,</div>
<div class="line"><span class="preprocessor">#ifdef RTE_CMSIS_RTOS2_RTX5</span></div>
<div class="line"> &amp;data_out_thread_cb_mem,</div>
<div class="line">  <span class="keyword">sizeof</span>(osRtxThread_t),</div>
<div class="line"> &amp;data_out_thread_stack_mem[0],</div>
<div class="line">#<span class="keywordflow">else</span></div>
<div class="line">  NULL,</div>
<div class="line">  0U,</div>
<div class="line">  NULL,</div>
<div class="line">#endif</div>
<div class="line">  512U,</div>
<div class="line">  osPriorityNormal,</div>
<div class="line">  0U,</div>
<div class="line">  0U</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> *Connection_ThreadId;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> *DataIN_ThreadId;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> *DataOUT_ThreadId;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef MAC_ADDR_RAW</span></div>
<div class="line"><span class="comment">// MAC Address conversion from ASCII string</span></div>
<div class="line"><span class="comment">// \param[in]   str     Pointer to ASCII string.</span></div>
<div class="line"><span class="comment">// \param[out]  addr    Pointer to address.</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> MAC_str_to_addr (<span class="keyword">const</span> <span class="keywordtype">char</span>    *str, uint8_t *addr) {</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="comment">// MAC Address conversion from wide string</span></div>
<div class="line"><span class="comment">// \param[in]   str     Pointer to wide string.</span></div>
<div class="line"><span class="comment">// \param[out]  addr    Pointer to address.</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> MAC_str_to_addr (<span class="keyword">const</span> <span class="keywordtype">wchar_t</span> *str, uint8_t *addr) {</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  uint8_t  c;</div>
<div class="line">  uint8_t  n;</div>
<div class="line">  uint32_t i;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (i = 0U; i &lt; 12U; i++) {</div>
<div class="line">    c = (uint8_t)str[i];</div>
<div class="line">    <span class="keywordflow">if</span>        ((c &gt;= <span class="charliteral">&#39;0&#39;</span>) &amp;&amp; (c &lt;= <span class="charliteral">&#39;9&#39;</span>)) {</div>
<div class="line">      n = c - <span class="charliteral">&#39;0&#39;</span>;</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((c &gt;= <span class="charliteral">&#39;A&#39;</span>) &amp;&amp; (c &lt;= <span class="charliteral">&#39;F&#39;</span>)) {</div>
<div class="line">      n = c - (<span class="charliteral">&#39;A&#39;</span> + 10U);</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((c &gt;= <span class="charliteral">&#39;a&#39;</span>) &amp;&amp; (c &lt;= <span class="charliteral">&#39;f&#39;</span>)) {</div>
<div class="line">      n = c - (<span class="charliteral">&#39;a&#39;</span> + 10U);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      n = 0U;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> ((i &amp; 1U) != 0U) {</div>
<div class="line">      addr[i&gt;&gt;1] |= n;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      addr[i&gt;&gt;1]  = (uint8_t)((uint32_t)n &lt;&lt; 4);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called during USBD_Initialize to initialize the USB CDC class instance (NCM).</span></div>
<div class="line"><span class="keywordtype">void</span> USBD_CDC%Instance%_NCM_Initialize (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for initialization</span></div>
<div class="line"> </div>
<div class="line">  MAC_str_to_addr(strMacAddress, MacAddress);</div>
<div class="line"> </div>
<div class="line">  memset(&amp;NCM_State, 0, <span class="keyword">sizeof</span>(NCM_State));</div>
<div class="line">  NCM_State.ntb_input_size = USBD_CDC%Instance%_NCM_DW_NTB_IN_MAX_SIZE;</div>
<div class="line">  NCM_State.max_datagram_size = USBD_CDC%Instance%_NCM_W_MAX_SEGMENT_SIZE;</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDC%Instance%_NCM_BM_NETWORK_CAPABILITIES &amp; 0x02) != 0)</span></div>
<div class="line">  memcpy(NCM_State.net_address, MacAddress, 6);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  NCM_State.packet_filter_bitmap = 0x0CU;</div>
<div class="line"> </div>
<div class="line">  LinkState = 0U;</div>
<div class="line">  LinkSpeed = 0U;</div>
<div class="line"> </div>
<div class="line">  FrameIN_Size = 0U;</div>
<div class="line">  memset(FrameIN, 0, <span class="keyword">sizeof</span>(FrameIN));</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Create Threads</span></div>
<div class="line">  Connection_ThreadId = osThreadNew(Connection_Thread, NULL, &amp;connection_thread_attr);</div>
<div class="line">  DataIN_ThreadId     = osThreadNew(DataIN_Thread,     NULL, &amp;data_in_thread_attr);</div>
<div class="line">  DataOUT_ThreadId    = osThreadNew(DataOUT_Thread,    NULL, &amp;data_out_thread_attr);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called during USBD_Uninitialize to de-initialize the USB CDC class instance (NCM).</span></div>
<div class="line"><span class="keywordtype">void</span> USBD_CDC%Instance%_NCM_Uninitialize (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for de-initialization</span></div>
<div class="line">  (void)osThreadTerminate(Connection_ThreadId);</div>
<div class="line">  (void)osThreadTerminate(DataIN_ThreadId);</div>
<div class="line">  (void)osThreadTerminate(DataOUT_ThreadId);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Bus Reset Event.</span></div>
<div class="line"><span class="keywordtype">void</span> USBD_CDC%Instance%_NCM_Reset (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for reset</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called when USB Host changes data interface from alternate 0 to alternate 1 (activates data interface).</span></div>
<div class="line"><span class="keywordtype">void</span> USBD_CDC%Instance%_NCM_Start (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for data interface activation</span></div>
<div class="line">  (void)osThreadFlagsSet(Connection_ThreadId, 1U);</div>
<div class="line">  (void)osThreadFlagsSet(DataIN_ThreadId,     1U);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called when USB Host changes data interface from alternate 1 to alternate 0 (de-activates data interface).</span></div>
<div class="line"><span class="keywordtype">void</span> USBD_CDC%Instance%_NCM_Stop (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for data interface de-activation</span></div>
<div class="line">  <span class="comment">// Explained in ncm10.pdf document from www.usb.org in paragraph 7.2</span></div>
<div class="line"> </div>
<div class="line">  FrameIN_Size = 0U;</div>
<div class="line"> </div>
<div class="line">  memset(&amp;NCM_State, 0, <span class="keyword">sizeof</span>(NCM_State));</div>
<div class="line">  NCM_State.ntb_input_size = USBD_CDC%Instance%_NCM_DW_NTB_IN_MAX_SIZE;</div>
<div class="line">  NCM_State.max_datagram_size = USBD_CDC%Instance%_NCM_W_MAX_SEGMENT_SIZE;</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDC%Instance%_NCM_BM_NETWORK_CAPABILITIES &amp; 0x02) != 0)</span></div>
<div class="line">  memcpy(NCM_State.net_address, MacAddress, 6);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  NCM_State.packet_filter_bitmap = 0x0CU;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to set the Ethernet device multicast filters.</span></div>
<div class="line"><span class="comment">// \param[in]   addr_list            Pointer to list of 48-bit Multicast addresses.</span></div>
<div class="line"><span class="comment">// \param[in]   num_of_filters       Number of filters.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_SetEthernetMulticastFilters (<span class="keyword">const</span> uint8_t *addr_list, uint16_t num_of_filters) {</div>
<div class="line"><span class="preprocessor">#if (USBD_CDC%Instance%_NCM_W_NUMBER_MC_FILTERS != 0)</span></div>
<div class="line">  <span class="keywordflow">if</span> (num_of_filters &gt; (USBD_CDC%Instance%_NCM_W_NUMBER_MC_FILTERS &amp; 0x7FFF)) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Add code for handling request</span></div>
<div class="line"> </div>
<div class="line">  memcpy(NCM_State.mc_filters, addr_list, num_of_filters * 6);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  (void)addr_list;</div>
<div class="line">  (void)num_of_filters;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to set up the specified Ethernet power management pattern filter.</span></div>
<div class="line"><span class="comment">// \param[in]   filter_number        Filter number.</span></div>
<div class="line"><span class="comment">// \param[in]   pattern_filter       Power management pattern filter structure.</span></div>
<div class="line"><span class="comment">// \param[in]   pattern_filter_size  Size of pattern filter structure.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_SetEthernetPowerManagementPatternFilter (uint16_t filter_number, <span class="keyword">const</span> uint8_t *pattern_filter, uint16_t pattern_filter_size) {</div>
<div class="line"><span class="preprocessor">#if (USBD_CDC%Instance%_NCM_B_NUMBER_POWER_FILTERS != 0)</span></div>
<div class="line">  <span class="keywordflow">if</span> (filter_number &gt;= USBD_CDC%Instance%_NCM_B_NUMBER_POWER_FILTERS) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Add code for handling request</span></div>
<div class="line"> </div>
<div class="line">  NCM_State.power_filter_active[filter_number / 8] |= 1U &lt;&lt; (filter_number % 8);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  (void)filter_number;</div>
<div class="line">  (void)pattern_filter;</div>
<div class="line">  (void)pattern_filter_size;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to retrieve the status of the specified Ethernet power management pattern filter.</span></div>
<div class="line"><span class="comment">// \param[in]   filter_number        Filter number.</span></div>
<div class="line"><span class="comment">// \param[out]  pattern_active       Pointer to pattern active boolean.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_GetEthernetPowerManagementPatternFilter (uint16_t filter_number, uint16_t *pattern_active) {</div>
<div class="line"><span class="preprocessor">#if (USBD_CDC%Instance%_NCM_B_NUMBER_POWER_FILTERS != 0)</span></div>
<div class="line">  *pattern_active = (NCM_State.power_filter_active[filter_number / 8] &amp; (1U &lt;&lt; (filter_number % 8))) ? 1 : 0;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  (void)filter_number;</div>
<div class="line">  (void)pattern_active;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to configure device Ethernet packet filter settings.</span></div>
<div class="line"><span class="comment">// \param[in]   packet_filter_bitmap Packet Filter Bitmap.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_SetEthernetPacketFilter (uint16_t packet_filter_bitmap) {</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDC%Instance%_NCM_BM_NETWORK_CAPABILITIES &amp; 0x01) != 0)</span></div>
<div class="line">  <span class="comment">// Add code for handling request</span></div>
<div class="line"> </div>
<div class="line">  NCM_State.packet_filter_bitmap = packet_filter_bitmap;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  (void)packet_filter_bitmap;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to retrieve a statistic based on the feature selector.</span></div>
<div class="line"><span class="comment">// \param[in]   feature_selector     Feature Selector.</span></div>
<div class="line"><span class="comment">// \param[out]  data                 Pointer to Statistics Value.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_GetEthernetStatistic (uint16_t feature_selector, uint32_t *data) {</div>
<div class="line"><span class="preprocessor">#if (USBD_CDC%Instance%_NCM_BM_ETHERNET_STATISTICS != 0)</span></div>
<div class="line">  <span class="keywordflow">if</span> (feature_selector == 0x00U) { <span class="keywordflow">return</span> <span class="keyword">true</span>;  }</div>
<div class="line">  <span class="keywordflow">if</span> (feature_selector &gt;  0x1DU) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">  *data = NCM_State.eth_statistics[feature_selector - 1];</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  (void)feature_selector;</div>
<div class="line">  (void)data;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to retrieve the parameters that describe NTBs for each direction.</span></div>
<div class="line"><span class="comment">// \param[out]  ntb_params           Pointer to NTB Parameter Structure.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_GetNtbParameters (<a class="code hl_struct" href="group__usbd__data__types.html#structCDC__NCM__NTB__PARAM" title="CDC NCM NTB Parameters structure.">CDC_NCM_NTB_PARAM</a> *ntb_params) {</div>
<div class="line"> </div>
<div class="line">  ntb_params-&gt;<a class="code hl_variable" href="group__usbd__data__types.html#a496c03443b177fd2e6c93616064d2934" title="Size of this structure, in bytes = 1Ch.">wLength</a>                 = <span class="keyword">sizeof</span>(<a class="code hl_struct" href="group__usbd__data__types.html#structCDC__NCM__NTB__PARAM" title="CDC NCM NTB Parameters structure.">CDC_NCM_NTB_PARAM</a>);</div>
<div class="line">  ntb_params-&gt;<a class="code hl_variable" href="group__usbd__data__types.html#a1ce4a9cf3b4f51a4fd8b7de2bb1f9a5e" title="Bit 0: 16-bit NTB supported (set to 1), Bit 1: 32-bit NTB supported, Bits 2 .. 15: reserved.">bmNtbFormatsSupported</a>   = USBD_CDC%Instance%_NCM_BM_NTB_FORMATS_SUPPORTED;</div>
<div class="line">  ntb_params-&gt;<a class="code hl_variable" href="group__usbd__data__types.html#abc0be89264a968b7b4bb6c1a993b2779" title="IN NTB Maximum Size in bytes.">dwNtbInMaxSize</a>          = USBD_CDC%Instance%_NCM_DW_NTB_IN_MAX_SIZE;</div>
<div class="line">  ntb_params-&gt;<a class="code hl_variable" href="group__usbd__data__types.html#a0348c36e85e6f15ee36f30ddd8ff54b4" title="Divisor used for IN NTB Datagram payload alignment.">wNdpInDivisor</a>           = USBD_CDC%Instance%_NCM_W_NDP_IN_DIVISOR;</div>
<div class="line">  ntb_params-&gt;<a class="code hl_variable" href="group__usbd__data__types.html#a96076135198c47285864480592a5a880" title="Remainder used to align input datagram payload within the NTB.">wNdpInPayloadRemainder</a>  = USBD_CDC%Instance%_NCM_W_NDP_IN_PAYLOAD_REMINDER;</div>
<div class="line">  ntb_params-&gt;<a class="code hl_variable" href="group__usbd__data__types.html#a97c11096da5456a5237b50259ceeb076" title="NDP alignment modulus for NTBs on the IN pipe. Shall be a power of 2, and shall be at least 4.">wNdpInAlignment</a>         = USBD_CDC%Instance%_NCM_W_NDP_IN_ALIGNMENT;</div>
<div class="line">  ntb_params-&gt;Reserved0               = 0U;</div>
<div class="line">  ntb_params-&gt;<a class="code hl_variable" href="group__usbd__data__types.html#a1b181550906a4c767bdf49fffbffd658" title="OUT NTB Maximum Size.">dwNtbOutMaxSize</a>         = USBD_CDC%Instance%_NCM_DW_NTB_OUT_MAX_SIZE;</div>
<div class="line">  ntb_params-&gt;<a class="code hl_variable" href="group__usbd__data__types.html#a31fa5ac48896ae0b9ca2bef90f8518cf" title="OUT NTB Datagram alignment modulus.">wNdpOutDivisor</a>          = USBD_CDC%Instance%_NCM_W_NDP_OUT_DIVISOR;</div>
<div class="line">  ntb_params-&gt;<a class="code hl_variable" href="group__usbd__data__types.html#aa51d53d073e3dc1c07b990978fe53e3e" title="Remainder used to align output datagram payload offsets within the NTB.">wNdpOutPayloadRemainder</a> = USBD_CDC%Instance%_NCM_W_NDP_OUT_PAYLOAD_REMINDER;</div>
<div class="line">  ntb_params-&gt;<a class="code hl_variable" href="group__usbd__data__types.html#ac2a2b6d7af310f000747a88f6b4b697f" title="NDP alignment modulus for use in NTBs on the OUT pipe. Shall be a power of 2, and shall be at least 4...">wNdpOutAlignment</a>        = USBD_CDC%Instance%_NCM_W_NDP_OUT_ALIGNMENT;</div>
<div class="line">  ntb_params-&gt;Reserved1               = 0U;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to return the USB Device’s current EUI-48 station address.</span></div>
<div class="line"><span class="comment">// \param[out]  net_addr             Pointer to EUI-48 current address, in network byte order.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_GetNetAddress (uint8_t *net_addr) {</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDC%Instance%_NCM_BM_NETWORK_CAPABILITIES &amp; 0x02) != 0)</span></div>
<div class="line">  memcpy(net_addr, NCM_State.net_address, 6);</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  (void)net_addr;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to set the USB Device’s current EUI-48 station address.</span></div>
<div class="line"><span class="comment">// \param[in]   net_addr             Pointer to EUI-48 address, in network byte order.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_SetNetAddress (<span class="keyword">const</span> uint8_t *net_addr) {</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDC%Instance%_NCM_BM_NETWORK_CAPABILITIES &amp; 0x02) != 0)</span></div>
<div class="line">  <span class="comment">// Add code for handling request</span></div>
<div class="line"> </div>
<div class="line">  memcpy(NCM_State.net_address, net_addr, 6);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  (void)net_addr;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to return the NTB data format currently being used.</span></div>
<div class="line"><span class="comment">// \param[out]  ntb_format           Pointer to NTB format code.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_GetNtbFormat (uint16_t *ntb_format) {</div>
<div class="line">  *ntb_format = NCM_State.ntb_format;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to select the format of NTB to be used for NTBs transmitted to the USB Host.</span></div>
<div class="line"><span class="comment">// \param[in]   ntb_format           NTB format selection:</span></div>
<div class="line"><span class="comment">//                - value 0 :        NTB-16</span></div>
<div class="line"><span class="comment">//                - value 1 :        NTB-32</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_SetNtbFormat (uint16_t ntb_format) {</div>
<div class="line"><span class="preprocessor">#if (USBD_CDC%Instance%_NCM_BM_NTB_FORMATS_SUPPORTED &gt; 1)</span></div>
<div class="line">  <span class="keywordflow">if</span> (ntb_format &gt; 1) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  <span class="keywordflow">if</span> (ntb_format &gt; 0) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  NCM_State.ntb_format = ntb_format;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to return NTB input size currently being used.</span></div>
<div class="line"><span class="comment">// \param[out]  ntb_input_size       Pointer to NTB input size.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_GetNtbInputSize (uint32_t *ntb_input_size) {</div>
<div class="line">  *ntb_input_size = NCM_State.ntb_input_size;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to select the maximum size of NTB that is permitted to be sent to the USB Host.</span></div>
<div class="line"><span class="comment">// \param[in]   ntb_input_size       Maximum NTB size.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_SetNtbInputSize (uint32_t ntb_input_size) {</div>
<div class="line">  <span class="keywordflow">if</span> (ntb_input_size &gt; USBD_CDC%Instance%_NCM_DW_NTB_IN_MAX_SIZE) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">  NCM_State.ntb_input_size = ntb_input_size;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to return the currently effective maximum datagram size.</span></div>
<div class="line"><span class="comment">// \param[out]  max_datagram_size    Pointer to current maximum datagram size.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_GetMaxDatagramSize (uint16_t *max_datagram_size) {</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDC%Instance%_NCM_BM_NETWORK_CAPABILITIES &amp; 0x08) != 0)</span></div>
<div class="line">  *max_datagram_size = NCM_State.max_datagram_size;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  (void)max_datagram_size;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to select the maximum datagram size that can be sent in an NTB.</span></div>
<div class="line"><span class="comment">// \param[in]   max_datagram_size    Maximum datagram size.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_SetMaxDatagramSize (uint16_t max_datagram_size) {</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDC%Instance%_NCM_BM_NETWORK_CAPABILITIES &amp; 0x08) != 0)</span></div>
<div class="line">  <span class="keywordflow">if</span> (max_datagram_size &gt; USBD_CDC%Instance%_NCM_W_MAX_SEGMENT_SIZE) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">  NCM_State.max_datagram_size = max_datagram_size;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  (void)max_datagram_size;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to return the currently selected CRC mode.</span></div>
<div class="line"><span class="comment">// \param[out]  crc_mode             Pointer to current CRC mode.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_GetCrcMode (uint16_t *crc_mode) {</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDC%Instance%_NCM_BM_NETWORK_CAPABILITIES &amp; 0x10) != 0)</span></div>
<div class="line">  *crc_mode = NCM_State.crc_mode;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  (void)crc_mode;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to control CRC mode.</span></div>
<div class="line"><span class="comment">// \param[in]   crc_mode             CRC mode:</span></div>
<div class="line"><span class="comment">//                - value 0 :        CRCs shall not be appended</span></div>
<div class="line"><span class="comment">//                - value 1 :        CRCs shall be appended</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_SetCrcMode (uint16_t crc_mode) {</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDC%Instance%_NCM_BM_NETWORK_CAPABILITIES &amp; 0x10) != 0)</span></div>
<div class="line">  <span class="keywordflow">if</span> (crc_mode &gt; 1) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">  NCM_State.crc_mode = crc_mode;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  (void)crc_mode;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called when NTB was successfully sent.</span></div>
<div class="line"><span class="keywordtype">void</span> USBD_CDC%Instance%_NCM_NTB_IN_Sent (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for handling request</span></div>
<div class="line">  (void)osThreadFlagsSet(DataIN_ThreadId, 1U);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called when NTB was successfully received.</span></div>
<div class="line"><span class="keywordtype">void</span> USBD_CDC%Instance%_NCM_NTB_OUT_Received (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for handling request</span></div>
<div class="line">  (void)osThreadFlagsSet(DataOUT_ThreadId, 1U);</div>
<div class="line">}</div>
<div class="line"> <span class="comment"></span></div>
<div class="line"><span class="comment">//! [code_USBD_User_CDC_NCM]</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Thread handling ETH Connection</span></div>
<div class="line">__NO_RETURN <span class="keyword">static</span> <span class="keywordtype">void</span> Connection_Thread (<span class="keywordtype">void</span> *arg) {</div>
<div class="line">  uint32_t           event;</div>
<div class="line">  uint32_t           speed;</div>
<div class="line">  uint16_t           state;</div>
<div class="line">  int32_t            status;</div>
<div class="line"> </div>
<div class="line">  (void)(arg);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (;;) {</div>
<div class="line">    <span class="keyword">event</span> = osThreadFlagsWait(1U, osFlagsWaitAll, 500U);</div>
<div class="line"><span class="comment">//  state = GetConnectionState();   // 0 = Disconnected, 1 = Connected</span></div>
<div class="line">    state = 1U;                     <span class="comment">// Emulate always connected</span></div>
<div class="line"><span class="comment">//  if (state == 1U) {</span></div>
<div class="line"><span class="comment">//    speed = GetConnectionSpeed();</span></div>
<div class="line">      speed = 100000000U;           <span class="comment">// Emulate 100M bsp link speed</span></div>
<div class="line"><span class="comment">//  } else {</span></div>
<div class="line"><span class="comment">//    speed = 0U;</span></div>
<div class="line"><span class="comment">//  }</span></div>
<div class="line">    <span class="keywordflow">if</span> (speed != LinkSpeed) {</div>
<div class="line">      LinkSpeed = speed;</div>
<div class="line"><span class="comment">//    if (state == 1U) {</span></div>
<div class="line">        <span class="keywordflow">do</span> {</div>
<div class="line">          status = <a class="code hl_function" href="group__usbd__cdcFunctions__ncm__api.html#ga5888e54f798b2bf2d20bdc41b1e8af55" title="Report a change in upstream or downstream speed of the networking connection to the USB Host.">USBD_CDC_NCM_Notify_ConnectionSpeedChange</a>(USB_CDC_NUM, speed, speed);</div>
<div class="line">        } <span class="keywordflow">while</span> (status == -(int32_t)<a class="code hl_enumvalue" href="rl__usb_8h.html#ga8196235c97e113f17993c7b4baff5f8fa5dfd259ecc4bbe016eaffb65838da4cb" title="Driver function is busy.">usbDriverBusy</a>);</div>
<div class="line"><span class="comment">//    }</span></div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (state != LinkState) {</div>
<div class="line">      LinkState = state;</div>
<div class="line">      <span class="keywordflow">do</span> {</div>
<div class="line">        status = <a class="code hl_function" href="group__usbd__cdcFunctions__ncm__api.html#ga6966c46d11f2592edf7dde71f4220e3f" title="Report whether or not the physical layer (modem, Ethernet PHY, etc.) link is up to the USB Host.">USBD_CDC_NCM_Notify_NetworkConnection</a>(USB_CDC_NUM, state);</div>
<div class="line">      } <span class="keywordflow">while</span> (status == -(int32_t)<a class="code hl_enumvalue" href="rl__usb_8h.html#ga8196235c97e113f17993c7b4baff5f8fa5dfd259ecc4bbe016eaffb65838da4cb" title="Driver function is busy.">usbDriverBusy</a>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> ((event &amp; 0x80000000U) == 0U) {</div>
<div class="line">      <span class="keywordflow">if</span> (LinkState == 1U) {</div>
<div class="line">        <span class="keywordflow">do</span> {</div>
<div class="line">          status = <a class="code hl_function" href="group__usbd__cdcFunctions__ncm__api.html#ga5888e54f798b2bf2d20bdc41b1e8af55" title="Report a change in upstream or downstream speed of the networking connection to the USB Host.">USBD_CDC_NCM_Notify_ConnectionSpeedChange</a>(USB_CDC_NUM, LinkSpeed, LinkSpeed);</div>
<div class="line">        } <span class="keywordflow">while</span> (status == -(int32_t)<a class="code hl_enumvalue" href="rl__usb_8h.html#ga8196235c97e113f17993c7b4baff5f8fa5dfd259ecc4bbe016eaffb65838da4cb" title="Driver function is busy.">usbDriverBusy</a>);</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">do</span> {</div>
<div class="line">        status = <a class="code hl_function" href="group__usbd__cdcFunctions__ncm__api.html#ga6966c46d11f2592edf7dde71f4220e3f" title="Report whether or not the physical layer (modem, Ethernet PHY, etc.) link is up to the USB Host.">USBD_CDC_NCM_Notify_NetworkConnection</a>(USB_CDC_NUM, LinkState);</div>
<div class="line">      } <span class="keywordflow">while</span> (status == -(int32_t)<a class="code hl_enumvalue" href="rl__usb_8h.html#ga8196235c97e113f17993c7b4baff5f8fa5dfd259ecc4bbe016eaffb65838da4cb" title="Driver function is busy.">usbDriverBusy</a>);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Thread handling Data IN (ETH -&gt; USB)</span></div>
<div class="line">__NO_RETURN <span class="keyword">static</span> <span class="keywordtype">void</span> DataIN_Thread (<span class="keywordtype">void</span> *arg) {</div>
<div class="line">  uint32_t size;</div>
<div class="line">  uint32_t len;</div>
<div class="line">   int32_t status;</div>
<div class="line"> </div>
<div class="line">  (void)arg;</div>
<div class="line"> </div>
<div class="line">  size = 0U;</div>
<div class="line">  len  = 0U;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (;;) {</div>
<div class="line">    (void)osThreadFlagsWait(3U, osFlagsWaitAll, osWaitForever);</div>
<div class="line">    status = <a class="code hl_function" href="group__usbd__cdcFunctions__ncm__api.html#gae9c578e2dbb6b54b8963adee536aea11" title="Clear the active NTB (prepared for sending)">USBD_CDC_NCM_NTB_IN_Initialize</a>(USB_CDC_NUM);</div>
<div class="line">    <span class="keywordflow">if</span> (status != (int32_t)<a class="code hl_enumvalue" href="rl__usb_8h.html#ga8196235c97e113f17993c7b4baff5f8facfe6cb72ed8e7b8e95a38cbf95418dbf" title="Function completed with no error.">usbOK</a>) { <span class="keywordflow">continue</span>; }</div>
<div class="line">    status = <a class="code hl_function" href="group__usbd__cdcFunctions__ncm__api.html#gae9fa4907d191f9e78483d588eef7081f" title="Create a new NDP in the NTB (datagrams can be added to it)">USBD_CDC_NCM_NTB_IN_CreateNDP</a>(USB_CDC_NUM, MAX_IN_DATAGRAMS);</div>
<div class="line">    <span class="keywordflow">if</span> (status != (int32_t)<a class="code hl_enumvalue" href="rl__usb_8h.html#ga8196235c97e113f17993c7b4baff5f8facfe6cb72ed8e7b8e95a38cbf95418dbf" title="Function completed with no error.">usbOK</a>) { <span class="keywordflow">continue</span>; }</div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">      <span class="keywordflow">if</span> (FrameIN_Size != 0) {</div>
<div class="line">        (void)<a class="code hl_function" href="group__usbd__cdcFunctions__ncm__api.html#gae55b3d343bccc5829fc5987a86cbe25d" title="Add a datagram into the active NDP of the NTB to be sent.">USBD_CDC_NCM_NTB_IN_WriteDatagram</a>(USB_CDC_NUM, FrameIN, FrameIN_Size);</div>
<div class="line">        FrameIN_Size = 0;</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">      (void)size;       <span class="comment">// Emulate No Data</span></div>
<div class="line">      (void)len;</div>
<div class="line"><span class="comment">//    size = GetDatagramSize();</span></div>
<div class="line"><span class="comment">//    if (size == 0U) {</span></div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line"><span class="comment">//    }</span></div>
<div class="line"><span class="comment">//    if ((size &lt; 14U) || (size &gt; NCM_State.max_datagram_size)) {</span></div>
<div class="line"><span class="comment">//      ReadDatagram(NULL);  // Discard datagram</span></div>
<div class="line"><span class="comment">//      continue;</span></div>
<div class="line"><span class="comment">//    }</span></div>
<div class="line"><span class="comment">//    len = ReadDatagram(FrameIN);</span></div>
<div class="line"><span class="comment">//    if (len &gt; 0) {</span></div>
<div class="line"><span class="comment">//      status = USBD_CDC_NCM_NTB_IN_WriteDatagram(USB_CDC_NUM, FrameIN, len);</span></div>
<div class="line"><span class="comment">//      if (status != (int32_t)usbOK) {</span></div>
<div class="line"><span class="comment">//        FrameIN_Size = len;</span></div>
<div class="line"><span class="comment">//        (void)osThreadFlagsSet(DataIN_ThreadId, 2U);</span></div>
<div class="line"><span class="comment">//        break;</span></div>
<div class="line"><span class="comment">//      }</span></div>
<div class="line"><span class="comment">//    }</span></div>
<div class="line">    }</div>
<div class="line">    (void)<a class="code hl_function" href="group__usbd__cdcFunctions__ncm__api.html#gaf2b9c281b2f5ba8d26ea598633d5c9ad" title="Send the active NTB.">USBD_CDC_NCM_NTB_IN_Send</a>(USB_CDC_NUM);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Thread handling Data OUT (USB -&gt; ETH)</span></div>
<div class="line">__NO_RETURN <span class="keyword">static</span> <span class="keywordtype">void</span> DataOUT_Thread (<span class="keywordtype">void</span> *arg) {</div>
<div class="line">  uint32_t size;</div>
<div class="line">  int32_t  len, status;</div>
<div class="line"> </div>
<div class="line">  (void)(arg);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (;;) {</div>
<div class="line">    (void)osThreadFlagsWait(1U, osFlagsWaitAll, osWaitForever);</div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">      status = <a class="code hl_function" href="group__usbd__cdcFunctions__ncm__api.html#ga0a24001aff5d9af6e8b040dc0cde6445" title="Process the next NDP in the received NTB.">USBD_CDC_NCM_NTB_OUT_ProcessNDP</a>(USB_CDC_NUM);</div>
<div class="line">      <span class="keywordflow">if</span> (status != (int32_t)<a class="code hl_enumvalue" href="rl__usb_8h.html#ga8196235c97e113f17993c7b4baff5f8facfe6cb72ed8e7b8e95a38cbf95418dbf" title="Function completed with no error.">usbOK</a>) { <span class="keywordflow">break</span>; }</div>
<div class="line">      <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        size = <a class="code hl_function" href="group__usbd__cdcFunctions__ncm__api.html#ga07e08df67e7fbc5a81f8ae9efabfc486" title="Get size of a datagram from the active NDP of the received NTB.">USBD_CDC_NCM_NTB_OUT_GetDatagramSize</a>(USB_CDC_NUM);</div>
<div class="line">        <span class="keywordflow">if</span> (size == 0U) { <span class="keywordflow">break</span>; }</div>
<div class="line">        <span class="keywordflow">if</span> ((size &lt; 14U) || (size &gt; NCM_State.max_datagram_size)) {</div>
<div class="line">          (void)<a class="code hl_function" href="group__usbd__cdcFunctions__ncm__api.html#ga74f401a77a548941e2c5ec998f4bf7f5" title="Read a datagram from the active NDP of the received NTB.">USBD_CDC_NCM_NTB_OUT_ReadDatagram</a>(USB_CDC_NUM, NULL, 0U);</div>
<div class="line">          <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        len = <a class="code hl_function" href="group__usbd__cdcFunctions__ncm__api.html#ga74f401a77a548941e2c5ec998f4bf7f5" title="Read a datagram from the active NDP of the received NTB.">USBD_CDC_NCM_NTB_OUT_ReadDatagram</a>(USB_CDC_NUM, FrameOUT, size);</div>
<div class="line">        <span class="keywordflow">if</span> (len &gt; 0) {</div>
<div class="line"><span class="comment">//        WriteDatagram(FrameOUT, len);</span></div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">    (void)<a class="code hl_function" href="group__usbd__cdcFunctions__ncm__api.html#ga7ce93a9770eb6360bdd9d9c79be4f1b6" title="Flush the received NTB and release memory for reception of a new NTB.">USBD_CDC_NCM_NTB_OUT_Release</a>(USB_CDC_NUM);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">// RTE_CMSIS_RTOS2</span></div>
</div><!-- fragment --><p><a class="anchor" id="USBD_User_CDC_NCM_ETH_UCT"></a><b>User Code Template USBD_User_CDC_NCM_ETH_n.c</b></p>
<p>The following source code contains all the required callback functions and can be used to implement the application specific behavior of a USB CDC (NCM) Device with Ethernet-over-USB functionality.</p>
<div class="fragment"><div class="line"><span class="comment">/*------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * MDK Middleware - Component ::USB:Device:CDC</span></div>
<div class="line"><span class="comment"> * Copyright (c) 2004-2024 Arm Limited (or its affiliates). All rights reserved.</span></div>
<div class="line"><span class="comment"> *------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * Name:    USBD_User_CDC_NCM_ETH_%Instance%.c</span></div>
<div class="line"><span class="comment"> * Purpose: USB Device Communication Device Class (CDC)</span></div>
<div class="line"><span class="comment"> *          Network Control Model (NCM) User module for an USB Ethernet Bridge</span></div>
<div class="line"><span class="comment"> * Rev.:    V1.0.9</span></div>
<div class="line"><span class="comment"> *----------------------------------------------------------------------------*/</span><span class="comment"></span></div>
<div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment"> * \addtogroup usbd_cdcFunctions</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * USBD_User_CDC_NCM_ETH_%Instance%.c implements the application specific functionality</span></div>
<div class="line"><span class="comment"> * of the CDC NCM class and is used to respond to control endpoint requests</span></div>
<div class="line"><span class="comment"> * as well as receive and send data to the USB Host.</span></div>
<div class="line"><span class="comment"> * It implements an USB Ethernet Bridge.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * The implementation depends on the configuration file USBD_Config_CDC_%Instance%.h.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"> <span class="comment"></span></div>
<div class="line"><span class="comment">//! [code_USBD_User_CDC_NCM_ETH]</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="rl__usb_8h.html">rl_usb.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;Driver_ETH_MAC.h&quot;</span>             <span class="comment">// ::CMSIS Driver:Ethernet MAC</span></div>
<div class="line"><span class="preprocessor">#include &quot;Driver_ETH_PHY.h&quot;</span>             <span class="comment">// ::CMSIS Driver:Ethernet PHY</span></div>
<div class="line"><span class="preprocessor">#include &quot;USBD_Config_CDC_%Instance%.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifndef  RTE_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor">#error   This user template requires CMSIS-RTOS2!</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define ETH_MAC_NUM             0       </span><span class="comment">/* ETH MAC Driver number */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define ETH_PHY_NUM             0       </span><span class="comment">/* ETH PHY Driver number */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define USB_CDC_NUM             %Instance%       </span><span class="comment">/* USB CDC Instance number */</span><span class="preprocessor"></span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define MAX_IN_DATAGRAMS        10</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef  USBD_CDC%Instance%_NCM_MAC_ADDRESS_RAW</span></div>
<div class="line"><span class="preprocessor">#define MAC_ADDR_RAW            1</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">extern</span> ARM_DRIVER_ETH_MAC ARM_Driver_ETH_MAC_(ETH_MAC_NUM);</div>
<div class="line"><span class="keyword">extern</span> ARM_DRIVER_ETH_PHY ARM_Driver_ETH_PHY_(ETH_PHY_NUM);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> ARM_DRIVER_ETH_MAC *EthMac = &amp;ARM_Driver_ETH_MAC_(ETH_MAC_NUM);</div>
<div class="line"><span class="keyword">static</span> ARM_DRIVER_ETH_PHY *EthPhy = &amp;ARM_Driver_ETH_PHY_(ETH_PHY_NUM);</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef MAC_ADDR_RAW</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span>    *strMacAddress = USBD_CDC%Instance%_NCM_MAC_ADDRESS_RAW;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">wchar_t</span> *strMacAddress = USBD_CDC%Instance%_NCM_MAC_ADDRESS;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="keyword">static</span> ARM_ETH_MAC_ADDR   MacAddress;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> ARM_ETH_LINK_STATE LinkState;</div>
<div class="line"><span class="keyword">static</span> ARM_ETH_LINK_INFO  LinkInfo;</div>
<div class="line"><span class="keyword">static</span> uint32_t           LinkSpeed;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> uint32_t           PacketFilter;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>{</div>
<div class="line">  uint32_t ntb_input_size;</div>
<div class="line">  uint16_t ntb_format;</div>
<div class="line">  uint16_t max_datagram_size;</div>
<div class="line">  uint16_t crc_mode;</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDC%Instance%_NCM_BM_NETWORK_CAPABILITIES &amp; 0x02) != 0)</span></div>
<div class="line">  uint8_t  net_address[6];</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor">#if (USBD_CDC%Instance%_NCM_W_NUMBER_MC_FILTERS != 0)</span></div>
<div class="line">  uint8_t  mc_filters[6*(USBD_CDC%Instance%_NCM_W_NUMBER_MC_FILTERS &amp; 0x7FFF)];</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor">#if (USBD_CDC%Instance%_NCM_B_NUMBER_POWER_FILTERS != 0)</span></div>
<div class="line">  uint8_t  power_filter_active[(USBD_CDC%Instance%_NCM_B_NUMBER_POWER_FILTERS + 7)/8];</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  uint16_t packet_filter_bitmap;</div>
<div class="line"><span class="preprocessor">#if (USBD_CDC%Instance%_NCM_BM_ETHERNET_STATISTICS != 0)</span></div>
<div class="line">  uint32_t eth_statistics[29];</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">} NCM_State;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> uint32_t FrameIN_Size;</div>
<div class="line"><span class="keyword">static</span> uint8_t  FrameIN [USBD_CDC%Instance%_NCM_W_MAX_SEGMENT_SIZE];</div>
<div class="line"><span class="keyword">static</span> uint8_t  FrameOUT[USBD_CDC%Instance%_NCM_W_MAX_SEGMENT_SIZE];</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> EthMac_Notify (uint32_t event);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> Connection_Thread (<span class="keywordtype">void</span> *arg);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> DataIN_Thread     (<span class="keywordtype">void</span> *arg);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> DataOUT_Thread    (<span class="keywordtype">void</span> *arg);</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef RTE_CMSIS_RTOS2_RTX5</span></div>
<div class="line"><span class="keyword">static</span> osRtxThread_t        connection_thread_cb_mem           __attribute__((section(<span class="stringliteral">&quot;.bss.os.thread.cb&quot;</span>)));</div>
<div class="line"><span class="keyword">static</span> uint64_t             connection_thread_stack_mem[512/8] __attribute__((section(<span class="stringliteral">&quot;.bss.os.thread.stack&quot;</span>)));</div>
<div class="line"><span class="keyword">static</span> osRtxThread_t        data_in_thread_cb_mem              __attribute__((section(<span class="stringliteral">&quot;.bss.os.thread.cb&quot;</span>)));</div>
<div class="line"><span class="keyword">static</span> uint64_t             data_in_thread_stack_mem   [512/8] __attribute__((section(<span class="stringliteral">&quot;.bss.os.thread.stack&quot;</span>)));</div>
<div class="line"><span class="keyword">static</span> osRtxThread_t        data_out_thread_cb_mem             __attribute__((section(<span class="stringliteral">&quot;.bss.os.thread.cb&quot;</span>)));</div>
<div class="line"><span class="keyword">static</span> uint64_t             data_out_thread_stack_mem  [512/8] __attribute__((section(<span class="stringliteral">&quot;.bss.os.thread.stack&quot;</span>)));</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> osThreadAttr_t connection_thread_attr = {</div>
<div class="line">  <span class="stringliteral">&quot;Connection_Thread&quot;</span>,</div>
<div class="line">  0U,</div>
<div class="line"><span class="preprocessor">#ifdef RTE_CMSIS_RTOS2_RTX5</span></div>
<div class="line"> &amp;connection_thread_cb_mem,</div>
<div class="line">  <span class="keyword">sizeof</span>(osRtxThread_t),</div>
<div class="line"> &amp;connection_thread_stack_mem[0],</div>
<div class="line">#<span class="keywordflow">else</span></div>
<div class="line">  NULL,</div>
<div class="line">  0U,</div>
<div class="line">  NULL,</div>
<div class="line">#endif</div>
<div class="line">  512U,</div>
<div class="line">  osPriorityNormal,</div>
<div class="line">  0U,</div>
<div class="line">  0U</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> osThreadAttr_t data_in_thread_attr = {</div>
<div class="line">  <span class="stringliteral">&quot;DataIN_Thread&quot;</span>,</div>
<div class="line">  0U,</div>
<div class="line"><span class="preprocessor">#ifdef RTE_CMSIS_RTOS2_RTX5</span></div>
<div class="line"> &amp;data_in_thread_cb_mem,</div>
<div class="line">  <span class="keyword">sizeof</span>(osRtxThread_t),</div>
<div class="line"> &amp;data_in_thread_stack_mem[0],</div>
<div class="line">#<span class="keywordflow">else</span></div>
<div class="line">  NULL,</div>
<div class="line">  0U,</div>
<div class="line">  NULL,</div>
<div class="line">#endif</div>
<div class="line">  512U,</div>
<div class="line">  osPriorityNormal,</div>
<div class="line">  0U,</div>
<div class="line">  0U</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> osThreadAttr_t data_out_thread_attr = {</div>
<div class="line">  <span class="stringliteral">&quot;DataOUT_Thread&quot;</span>,</div>
<div class="line">  0U,</div>
<div class="line"><span class="preprocessor">#ifdef RTE_CMSIS_RTOS2_RTX5</span></div>
<div class="line"> &amp;data_out_thread_cb_mem,</div>
<div class="line">  <span class="keyword">sizeof</span>(osRtxThread_t),</div>
<div class="line"> &amp;data_out_thread_stack_mem[0],</div>
<div class="line">#<span class="keywordflow">else</span></div>
<div class="line">  NULL,</div>
<div class="line">  0U,</div>
<div class="line">  NULL,</div>
<div class="line">#endif</div>
<div class="line">  512U,</div>
<div class="line">  osPriorityNormal,</div>
<div class="line">  0U,</div>
<div class="line">  0U</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> *Connection_ThreadId;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> *DataIN_ThreadId;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> *DataOUT_ThreadId;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef MAC_ADDR_RAW</span></div>
<div class="line"><span class="comment">// MAC Address conversion from ASCII string</span></div>
<div class="line"><span class="comment">// \param[in]   str     Pointer to ASCII string.</span></div>
<div class="line"><span class="comment">// \param[out]  addr    Pointer to address.</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> MAC_str_to_addr (<span class="keyword">const</span> <span class="keywordtype">char</span>    *str, uint8_t *addr) {</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="comment">// MAC Address conversion from wide string</span></div>
<div class="line"><span class="comment">// \param[in]   str     Pointer to wide string.</span></div>
<div class="line"><span class="comment">// \param[out]  addr    Pointer to address.</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> MAC_str_to_addr (<span class="keyword">const</span> <span class="keywordtype">wchar_t</span> *str, uint8_t *addr) {</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  uint8_t  c;</div>
<div class="line">  uint8_t  n;</div>
<div class="line">  uint32_t i;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (i = 0U; i &lt; 12U; i++) {</div>
<div class="line">    c = (uint8_t)str[i];</div>
<div class="line">    <span class="keywordflow">if</span>        ((c &gt;= <span class="charliteral">&#39;0&#39;</span>) &amp;&amp; (c &lt;= <span class="charliteral">&#39;9&#39;</span>)) {</div>
<div class="line">      n = c - <span class="charliteral">&#39;0&#39;</span>;</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((c &gt;= <span class="charliteral">&#39;A&#39;</span>) &amp;&amp; (c &lt;= <span class="charliteral">&#39;F&#39;</span>)) {</div>
<div class="line">      n = c - (<span class="charliteral">&#39;A&#39;</span> + 10U);</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((c &gt;= <span class="charliteral">&#39;a&#39;</span>) &amp;&amp; (c &lt;= <span class="charliteral">&#39;f&#39;</span>)) {</div>
<div class="line">      n = c - (<span class="charliteral">&#39;a&#39;</span> + 10U);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      n = 0U;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> ((i &amp; 1U) != 0U) {</div>
<div class="line">      addr[i&gt;&gt;1] |= n;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      addr[i&gt;&gt;1]  = (uint8_t)((uint32_t)n &lt;&lt; 4);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called during USBD_Initialize to initialize the USB CDC class instance (NCM).</span></div>
<div class="line"><span class="keywordtype">void</span> USBD_CDC%Instance%_NCM_Initialize (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for initialization</span></div>
<div class="line">  ARM_ETH_MAC_CAPABILITIES capabilities;</div>
<div class="line">  int32_t                  status;</div>
<div class="line"> </div>
<div class="line">  MAC_str_to_addr(strMacAddress, (uint8_t *)&amp;MacAddress);</div>
<div class="line"> </div>
<div class="line">  memset(&amp;NCM_State, 0, <span class="keyword">sizeof</span>(NCM_State));</div>
<div class="line">  NCM_State.ntb_input_size = USBD_CDC%Instance%_NCM_DW_NTB_IN_MAX_SIZE;</div>
<div class="line">  NCM_State.max_datagram_size = USBD_CDC%Instance%_NCM_W_MAX_SEGMENT_SIZE;</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDC%Instance%_NCM_BM_NETWORK_CAPABILITIES &amp; 0x02) != 0)</span></div>
<div class="line">  memcpy(NCM_State.net_address, &amp;MacAddress, 6);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  NCM_State.packet_filter_bitmap = 0x0CU;</div>
<div class="line"> </div>
<div class="line">  LinkState = ARM_ETH_LINK_DOWN;</div>
<div class="line">  LinkInfo.speed  = 0U;</div>
<div class="line">  LinkInfo.duplex = 0U;</div>
<div class="line">  LinkSpeed = 0U;</div>
<div class="line"> </div>
<div class="line">  PacketFilter = ARM_ETH_MAC_ADDRESS_BROADCAST;</div>
<div class="line"> </div>
<div class="line">  FrameIN_Size = 0U;</div>
<div class="line">  memset(FrameIN, 0, <span class="keyword">sizeof</span>(FrameIN));</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Initialize Media Access Controller</span></div>
<div class="line">  capabilities = EthMac-&gt;GetCapabilities();</div>
<div class="line"> </div>
<div class="line">  status = EthMac-&gt;Initialize(EthMac_Notify);</div>
<div class="line">  <span class="keywordflow">if</span> (status != ARM_DRIVER_OK) { <span class="keywordflow">return</span>; }</div>
<div class="line">  status = EthMac-&gt;PowerControl(ARM_POWER_FULL);</div>
<div class="line">  <span class="keywordflow">if</span> (status != ARM_DRIVER_OK) { <span class="keywordflow">return</span>; }</div>
<div class="line"> </div>
<div class="line">  status = EthMac-&gt;SetMacAddress(&amp;MacAddress);</div>
<div class="line">  <span class="keywordflow">if</span> (status != ARM_DRIVER_OK) { <span class="keywordflow">return</span>; }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Initialize Physical Media Interface</span></div>
<div class="line">  status = EthPhy-&gt;Initialize(EthMac-&gt;PHY_Read, EthMac-&gt;PHY_Write);</div>
<div class="line">  <span class="keywordflow">if</span> (status != ARM_DRIVER_OK) { <span class="keywordflow">return</span>; }</div>
<div class="line">  status = EthPhy-&gt;PowerControl(ARM_POWER_FULL);</div>
<div class="line">  <span class="keywordflow">if</span> (status != ARM_DRIVER_OK) { <span class="keywordflow">return</span>; }</div>
<div class="line">  status = EthPhy-&gt;SetInterface(capabilities.media_interface);</div>
<div class="line">  <span class="keywordflow">if</span> (status != ARM_DRIVER_OK) { <span class="keywordflow">return</span>; }</div>
<div class="line">  status = EthPhy-&gt;SetMode(ARM_ETH_PHY_AUTO_NEGOTIATE);</div>
<div class="line">  <span class="keywordflow">if</span> (status != ARM_DRIVER_OK) { <span class="keywordflow">return</span>; }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Create Threads</span></div>
<div class="line">  Connection_ThreadId = osThreadNew(Connection_Thread, NULL, &amp;connection_thread_attr);</div>
<div class="line">  DataIN_ThreadId     = osThreadNew(DataIN_Thread,     NULL, &amp;data_in_thread_attr);</div>
<div class="line">  DataOUT_ThreadId    = osThreadNew(DataOUT_Thread,    NULL, &amp;data_out_thread_attr);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called during USBD_Uninitialize to de-initialize the USB CDC class instance (NCM).</span></div>
<div class="line"><span class="keywordtype">void</span> USBD_CDC%Instance%_NCM_Uninitialize (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for de-initialization</span></div>
<div class="line">  (void)osThreadTerminate(Connection_ThreadId);</div>
<div class="line">  (void)osThreadTerminate(DataIN_ThreadId);</div>
<div class="line">  (void)osThreadTerminate(DataOUT_ThreadId);</div>
<div class="line"> </div>
<div class="line">  (void)EthPhy-&gt;PowerControl(ARM_POWER_OFF);</div>
<div class="line">  (void)EthPhy-&gt;Uninitialize();</div>
<div class="line"> </div>
<div class="line">  (void)EthMac-&gt;PowerControl(ARM_POWER_OFF);</div>
<div class="line">  (void)EthMac-&gt;Uninitialize();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Bus Reset Event.</span></div>
<div class="line"><span class="keywordtype">void</span> USBD_CDC%Instance%_NCM_Reset (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for reset</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called when USB Host changes data interface from alternate 0 to alternate 1 (activates data interface).</span></div>
<div class="line"><span class="keywordtype">void</span> USBD_CDC%Instance%_NCM_Start (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for data interface activation</span></div>
<div class="line">  (void)osThreadFlagsSet(Connection_ThreadId, 1U);</div>
<div class="line">  (void)osThreadFlagsSet(DataIN_ThreadId,     1U);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called when USB Host changes data interface from alternate 1 to alternate 0 (de-activates data interface).</span></div>
<div class="line"><span class="keywordtype">void</span> USBD_CDC%Instance%_NCM_Stop (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for data interface de-activation</span></div>
<div class="line">  <span class="comment">// Explained in ncm10.pdf document from www.usb.org in paragraph 7.2</span></div>
<div class="line"> </div>
<div class="line">  FrameIN_Size = 0U;</div>
<div class="line"> </div>
<div class="line">  memset(&amp;NCM_State, 0, <span class="keyword">sizeof</span>(NCM_State));</div>
<div class="line">  NCM_State.ntb_input_size = USBD_CDC%Instance%_NCM_DW_NTB_IN_MAX_SIZE;</div>
<div class="line">  NCM_State.max_datagram_size = USBD_CDC%Instance%_NCM_W_MAX_SEGMENT_SIZE;</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDC%Instance%_NCM_BM_NETWORK_CAPABILITIES &amp; 0x02) != 0)</span></div>
<div class="line">  memcpy(NCM_State.net_address, &amp;MacAddress, 6);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  NCM_State.packet_filter_bitmap = 0x0CU;</div>
<div class="line"> </div>
<div class="line">  PacketFilter = ARM_ETH_MAC_ADDRESS_BROADCAST;</div>
<div class="line"> </div>
<div class="line">  (void)EthMac-&gt;SetMacAddress(&amp;MacAddress);</div>
<div class="line">  (void)EthMac-&gt;SetAddressFilter(NULL, 0);</div>
<div class="line">  (void)EthMac-&gt;Control(ARM_ETH_MAC_CONFIGURE,</div>
<div class="line">                       (uint32_t)(LinkInfo.speed                           ) |</div>
<div class="line">                       (uint32_t)(LinkInfo.duplex &lt;&lt; ARM_ETH_MAC_DUPLEX_Pos) |</div>
<div class="line">                        PacketFilter);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to set the Ethernet device multicast filters.</span></div>
<div class="line"><span class="comment">// \param[in]   addr_list            Pointer to list of 48-bit Multicast addresses.</span></div>
<div class="line"><span class="comment">// \param[in]   num_of_filters       Number of filters.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_SetEthernetMulticastFilters (<span class="keyword">const</span> uint8_t *addr_list, uint16_t num_of_filters) {</div>
<div class="line"><span class="preprocessor">#if (USBD_CDC%Instance%_NCM_W_NUMBER_MC_FILTERS != 0)</span></div>
<div class="line">  int32_t status;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (num_of_filters &gt; (USBD_CDC%Instance%_NCM_W_NUMBER_MC_FILTERS &amp; 0x7FFF)) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Add code for handling request</span></div>
<div class="line">  status = EthMac-&gt;SetAddressFilter((ARM_ETH_MAC_ADDR *)((uint32_t)addr_list), num_of_filters);</div>
<div class="line">  <span class="keywordflow">if</span> (status != ARM_DRIVER_OK) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"> </div>
<div class="line">  memcpy(NCM_State.mc_filters, addr_list, num_of_filters * 6);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  (void)addr_list;</div>
<div class="line">  (void)num_of_filters;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to set up the specified Ethernet power management pattern filter.</span></div>
<div class="line"><span class="comment">// \param[in]   filter_number        Filter number.</span></div>
<div class="line"><span class="comment">// \param[in]   pattern_filter       Power management pattern filter structure.</span></div>
<div class="line"><span class="comment">// \param[in]   pattern_filter_size  Size of pattern filter structure.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_SetEthernetPowerManagementPatternFilter (uint16_t filter_number, <span class="keyword">const</span> uint8_t *pattern_filter, uint16_t pattern_filter_size) {</div>
<div class="line"><span class="preprocessor">#if (USBD_CDC%Instance%_NCM_B_NUMBER_POWER_FILTERS != 0)</span></div>
<div class="line">  <span class="keywordflow">if</span> (filter_number &gt;= USBD_CDC%Instance%_NCM_B_NUMBER_POWER_FILTERS) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Add code for handling request</span></div>
<div class="line"> </div>
<div class="line">  NCM_State.power_filter_active[filter_number / 8] |= 1U &lt;&lt; (filter_number % 8);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  (void)filter_number;</div>
<div class="line">  (void)pattern_filter;</div>
<div class="line">  (void)pattern_filter_size;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to retrieve the status of the specified Ethernet power management pattern filter.</span></div>
<div class="line"><span class="comment">// \param[in]   filter_number        Filter number.</span></div>
<div class="line"><span class="comment">// \param[out]  pattern_active       Pointer to pattern active boolean.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_GetEthernetPowerManagementPatternFilter (uint16_t filter_number, uint16_t *pattern_active) {</div>
<div class="line"><span class="preprocessor">#if (USBD_CDC%Instance%_NCM_B_NUMBER_POWER_FILTERS != 0)</span></div>
<div class="line">  *pattern_active = (NCM_State.power_filter_active[filter_number / 8] &amp; (1U &lt;&lt; (filter_number % 8))) ? 1 : 0;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  (void)filter_number;</div>
<div class="line">  (void)pattern_active;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to configure device Ethernet packet filter settings.</span></div>
<div class="line"><span class="comment">// \param[in]   packet_filter_bitmap Packet Filter Bitmap.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_SetEthernetPacketFilter (uint16_t packet_filter_bitmap) {</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDC%Instance%_NCM_BM_NETWORK_CAPABILITIES &amp; 0x01) != 0)</span></div>
<div class="line">  int32_t status;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Add code for handling request</span></div>
<div class="line">  PacketFilter = ((packet_filter_bitmap &amp; 0x01U) ? ARM_ETH_MAC_ADDRESS_ALL       : 0) |</div>
<div class="line">                 ((packet_filter_bitmap &amp; 0x02U) ? ARM_ETH_MAC_ADDRESS_MULTICAST : 0) |</div>
<div class="line">                 ((packet_filter_bitmap &amp; 0x08U) ? ARM_ETH_MAC_ADDRESS_BROADCAST : 0);</div>
<div class="line"> </div>
<div class="line">  status = EthMac-&gt;Control(ARM_ETH_MAC_CONFIGURE,</div>
<div class="line">                          (uint32_t)(LinkInfo.speed                           ) |</div>
<div class="line">                          (uint32_t)(LinkInfo.duplex &lt;&lt; ARM_ETH_MAC_DUPLEX_Pos) |</div>
<div class="line">                           PacketFilter);</div>
<div class="line">  <span class="keywordflow">if</span> (status != ARM_DRIVER_OK) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"> </div>
<div class="line">  NCM_State.packet_filter_bitmap = packet_filter_bitmap;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  (void)packet_filter_bitmap;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to retrieve a statistic based on the feature selector.</span></div>
<div class="line"><span class="comment">// \param[in]   feature_selector     Feature Selector.</span></div>
<div class="line"><span class="comment">// \param[out]  data                 Pointer to Statistics Value.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_GetEthernetStatistic (uint16_t feature_selector, uint32_t *data) {</div>
<div class="line"><span class="preprocessor">#if (USBD_CDC%Instance%_NCM_BM_ETHERNET_STATISTICS != 0)</span></div>
<div class="line">  <span class="keywordflow">if</span> (feature_selector == 0x00U) { <span class="keywordflow">return</span> <span class="keyword">true</span>;  }</div>
<div class="line">  <span class="keywordflow">if</span> (feature_selector &gt;  0x1DU) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">  *data = NCM_State.eth_statistics[feature_selector - 1];</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  (void)feature_selector;</div>
<div class="line">  (void)data;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to retrieve the parameters that describe NTBs for each direction.</span></div>
<div class="line"><span class="comment">// \param[out]  ntb_params           Pointer to NTB Parameter Structure.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_GetNtbParameters (<a class="code hl_struct" href="group__usbd__data__types.html#structCDC__NCM__NTB__PARAM" title="CDC NCM NTB Parameters structure.">CDC_NCM_NTB_PARAM</a> *ntb_params) {</div>
<div class="line"> </div>
<div class="line">  ntb_params-&gt;<a class="code hl_variable" href="group__usbd__data__types.html#a496c03443b177fd2e6c93616064d2934" title="Size of this structure, in bytes = 1Ch.">wLength</a>                 = <span class="keyword">sizeof</span>(<a class="code hl_struct" href="group__usbd__data__types.html#structCDC__NCM__NTB__PARAM" title="CDC NCM NTB Parameters structure.">CDC_NCM_NTB_PARAM</a>);</div>
<div class="line">  ntb_params-&gt;<a class="code hl_variable" href="group__usbd__data__types.html#a1ce4a9cf3b4f51a4fd8b7de2bb1f9a5e" title="Bit 0: 16-bit NTB supported (set to 1), Bit 1: 32-bit NTB supported, Bits 2 .. 15: reserved.">bmNtbFormatsSupported</a>   = USBD_CDC%Instance%_NCM_BM_NTB_FORMATS_SUPPORTED;</div>
<div class="line">  ntb_params-&gt;<a class="code hl_variable" href="group__usbd__data__types.html#abc0be89264a968b7b4bb6c1a993b2779" title="IN NTB Maximum Size in bytes.">dwNtbInMaxSize</a>          = USBD_CDC%Instance%_NCM_DW_NTB_IN_MAX_SIZE;</div>
<div class="line">  ntb_params-&gt;<a class="code hl_variable" href="group__usbd__data__types.html#a0348c36e85e6f15ee36f30ddd8ff54b4" title="Divisor used for IN NTB Datagram payload alignment.">wNdpInDivisor</a>           = USBD_CDC%Instance%_NCM_W_NDP_IN_DIVISOR;</div>
<div class="line">  ntb_params-&gt;<a class="code hl_variable" href="group__usbd__data__types.html#a96076135198c47285864480592a5a880" title="Remainder used to align input datagram payload within the NTB.">wNdpInPayloadRemainder</a>  = USBD_CDC%Instance%_NCM_W_NDP_IN_PAYLOAD_REMINDER;</div>
<div class="line">  ntb_params-&gt;<a class="code hl_variable" href="group__usbd__data__types.html#a97c11096da5456a5237b50259ceeb076" title="NDP alignment modulus for NTBs on the IN pipe. Shall be a power of 2, and shall be at least 4.">wNdpInAlignment</a>         = USBD_CDC%Instance%_NCM_W_NDP_IN_ALIGNMENT;</div>
<div class="line">  ntb_params-&gt;Reserved0               = 0U;</div>
<div class="line">  ntb_params-&gt;<a class="code hl_variable" href="group__usbd__data__types.html#a1b181550906a4c767bdf49fffbffd658" title="OUT NTB Maximum Size.">dwNtbOutMaxSize</a>         = USBD_CDC%Instance%_NCM_DW_NTB_OUT_MAX_SIZE;</div>
<div class="line">  ntb_params-&gt;<a class="code hl_variable" href="group__usbd__data__types.html#a31fa5ac48896ae0b9ca2bef90f8518cf" title="OUT NTB Datagram alignment modulus.">wNdpOutDivisor</a>          = USBD_CDC%Instance%_NCM_W_NDP_OUT_DIVISOR;</div>
<div class="line">  ntb_params-&gt;<a class="code hl_variable" href="group__usbd__data__types.html#aa51d53d073e3dc1c07b990978fe53e3e" title="Remainder used to align output datagram payload offsets within the NTB.">wNdpOutPayloadRemainder</a> = USBD_CDC%Instance%_NCM_W_NDP_OUT_PAYLOAD_REMINDER;</div>
<div class="line">  ntb_params-&gt;<a class="code hl_variable" href="group__usbd__data__types.html#ac2a2b6d7af310f000747a88f6b4b697f" title="NDP alignment modulus for use in NTBs on the OUT pipe. Shall be a power of 2, and shall be at least 4...">wNdpOutAlignment</a>        = USBD_CDC%Instance%_NCM_W_NDP_OUT_ALIGNMENT;</div>
<div class="line">  ntb_params-&gt;Reserved1               = 0U;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to return the USB Device&#39;s current EUI-48 station address.</span></div>
<div class="line"><span class="comment">// \param[out]  net_addr             Pointer to EUI-48 current address, in network byte order.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_GetNetAddress (uint8_t *net_addr) {</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDC%Instance%_NCM_BM_NETWORK_CAPABILITIES &amp; 0x02) != 0)</span></div>
<div class="line">  memcpy(net_addr, NCM_State.net_address, 6);</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  (void)net_addr;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to set the USB Device&#39;s current EUI-48 station address.</span></div>
<div class="line"><span class="comment">// \param[in]   net_addr             Pointer to EUI-48 address, in network byte order.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_SetNetAddress (<span class="keyword">const</span> uint8_t *net_addr) {</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDC%Instance%_NCM_BM_NETWORK_CAPABILITIES &amp; 0x02) != 0)</span></div>
<div class="line">  int32_t status;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Add code for handling request</span></div>
<div class="line">  status = EthMac-&gt;SetMacAddress((ARM_ETH_MAC_ADDR *)((uint32_t)net_addr));</div>
<div class="line">  <span class="keywordflow">if</span> (status != ARM_DRIVER_OK) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"> </div>
<div class="line">  memcpy(NCM_State.net_address, net_addr, 6);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  (void)net_addr;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to return the NTB data format currently being used.</span></div>
<div class="line"><span class="comment">// \param[out]  ntb_format           Pointer to NTB format code.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_GetNtbFormat (uint16_t *ntb_format) {</div>
<div class="line">  *ntb_format = NCM_State.ntb_format;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to select the format of NTB to be used for NTBs transmitted to the USB Host.</span></div>
<div class="line"><span class="comment">// \param[in]   ntb_format           NTB format selection:</span></div>
<div class="line"><span class="comment">//                - value 0 :        NTB-16</span></div>
<div class="line"><span class="comment">//                - value 1 :        NTB-32</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_SetNtbFormat (uint16_t ntb_format) {</div>
<div class="line"><span class="preprocessor">#if (USBD_CDC%Instance%_NCM_BM_NTB_FORMATS_SUPPORTED &gt; 1)</span></div>
<div class="line">  <span class="keywordflow">if</span> (ntb_format &gt; 1) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  <span class="keywordflow">if</span> (ntb_format &gt; 0) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">  NCM_State.ntb_format = ntb_format;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to return NTB input size currently being used.</span></div>
<div class="line"><span class="comment">// \param[out]  ntb_input_size       Pointer to NTB input size.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_GetNtbInputSize (uint32_t *ntb_input_size) {</div>
<div class="line">  *ntb_input_size = NCM_State.ntb_input_size;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to select the maximum size of NTB that is permitted to be sent to the USB Host.</span></div>
<div class="line"><span class="comment">// \param[in]   ntb_input_size       Maximum NTB size.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_SetNtbInputSize (uint32_t ntb_input_size) {</div>
<div class="line">  <span class="keywordflow">if</span> (ntb_input_size &gt; USBD_CDC%Instance%_NCM_DW_NTB_IN_MAX_SIZE) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">  NCM_State.ntb_input_size = ntb_input_size;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to return the currently effective maximum datagram size.</span></div>
<div class="line"><span class="comment">// \param[out]  max_datagram_size    Pointer to current maximum datagram size.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_GetMaxDatagramSize (uint16_t *max_datagram_size) {</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDC%Instance%_NCM_BM_NETWORK_CAPABILITIES &amp; 0x08) != 0)</span></div>
<div class="line">  *max_datagram_size = NCM_State.max_datagram_size;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  (void)max_datagram_size;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to select the maximum datagram size that can be sent in an NTB.</span></div>
<div class="line"><span class="comment">// \param[in]   max_datagram_size    Maximum datagram size.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_SetMaxDatagramSize (uint16_t max_datagram_size) {</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDC%Instance%_NCM_BM_NETWORK_CAPABILITIES &amp; 0x08) != 0)</span></div>
<div class="line">  <span class="keywordflow">if</span> (max_datagram_size &gt; USBD_CDC%Instance%_NCM_W_MAX_SEGMENT_SIZE) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">  NCM_State.max_datagram_size = max_datagram_size;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  (void)max_datagram_size;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to return the currently selected CRC mode.</span></div>
<div class="line"><span class="comment">// \param[out]  crc_mode             Pointer to current CRC mode.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_GetCrcMode (uint16_t *crc_mode) {</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDC%Instance%_NCM_BM_NETWORK_CAPABILITIES &amp; 0x10) != 0)</span></div>
<div class="line">  *crc_mode = NCM_State.crc_mode;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  (void)crc_mode;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to control CRC mode.</span></div>
<div class="line"><span class="comment">// \param[in]   crc_mode             CRC mode:</span></div>
<div class="line"><span class="comment">//                - value 0 :        CRCs shall not be appended</span></div>
<div class="line"><span class="comment">//                - value 1 :        CRCs shall be appended</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_CDC%Instance%_NCM_SetCrcMode (uint16_t crc_mode) {</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDC%Instance%_NCM_BM_NETWORK_CAPABILITIES &amp; 0x10) != 0)</span></div>
<div class="line">  <span class="keywordflow">if</span> (crc_mode &gt; 1) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">  NCM_State.crc_mode = crc_mode;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  (void)crc_mode;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called when NTB was successfully sent.</span></div>
<div class="line"><span class="keywordtype">void</span> USBD_CDC%Instance%_NCM_NTB_IN_Sent (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for handling request</span></div>
<div class="line">  (void)osThreadFlagsSet(DataIN_ThreadId, 1U);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called when NTB was successfully received.</span></div>
<div class="line"><span class="keywordtype">void</span> USBD_CDC%Instance%_NCM_NTB_OUT_Received (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for handling request</span></div>
<div class="line">  (void)osThreadFlagsSet(DataOUT_ThreadId, 1U);</div>
<div class="line">}</div>
<div class="line"> <span class="comment"></span></div>
<div class="line"><span class="comment">//! [code_USBD_User_CDC_NCM_ETH]</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon Ethernet MAC Event</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> EthMac_Notify (uint32_t event) {</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">switch</span> (event) {</div>
<div class="line">    <span class="keywordflow">case</span> ARM_ETH_MAC_EVENT_RX_FRAME:</div>
<div class="line">      (void)osThreadFlagsSet(DataIN_ThreadId, 2U);</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Thread handling ETH Connection</span></div>
<div class="line">__NO_RETURN <span class="keyword">static</span> <span class="keywordtype">void</span> Connection_Thread (<span class="keywordtype">void</span> *arg) {</div>
<div class="line">  ARM_ETH_LINK_STATE link_state;</div>
<div class="line">  uint32_t           event;</div>
<div class="line">  uint32_t           speed;</div>
<div class="line">  uint16_t           state;</div>
<div class="line">  int32_t            status;</div>
<div class="line"> </div>
<div class="line">  (void)(arg);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (;;) {</div>
<div class="line">    <span class="keyword">event</span> = osThreadFlagsWait(1U, osFlagsWaitAll, 500U);</div>
<div class="line">    link_state = EthPhy-&gt;GetLinkState();</div>
<div class="line">    <span class="keywordflow">if</span> (link_state == ARM_ETH_LINK_UP) {</div>
<div class="line">      LinkInfo = EthPhy-&gt;GetLinkInfo();</div>
<div class="line">      <span class="keywordflow">switch</span> (LinkInfo.speed) {</div>
<div class="line">        <span class="keywordflow">case</span> 0:  speed =   10000000U; <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 1:  speed =  100000000U; <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 2:  speed = 1000000000U; <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>: speed = 0U;</div>
<div class="line">      }</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      speed = 0U;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (speed != LinkSpeed) {</div>
<div class="line">      LinkSpeed = speed;</div>
<div class="line">      <span class="keywordflow">if</span> (link_state == ARM_ETH_LINK_UP) {</div>
<div class="line">        <span class="keywordflow">do</span> {</div>
<div class="line">          status = <a class="code hl_function" href="group__usbd__cdcFunctions__ncm__api.html#ga5888e54f798b2bf2d20bdc41b1e8af55" title="Report a change in upstream or downstream speed of the networking connection to the USB Host.">USBD_CDC_NCM_Notify_ConnectionSpeedChange</a>(USB_CDC_NUM, speed, speed);</div>
<div class="line">        } <span class="keywordflow">while</span> (status == -(int32_t)<a class="code hl_enumvalue" href="rl__usb_8h.html#ga8196235c97e113f17993c7b4baff5f8fa5dfd259ecc4bbe016eaffb65838da4cb" title="Driver function is busy.">usbDriverBusy</a>);</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (link_state != LinkState) {</div>
<div class="line">      LinkState = link_state;</div>
<div class="line">      <span class="keywordflow">if</span> (link_state == ARM_ETH_LINK_UP) {</div>
<div class="line">        (void)EthMac-&gt;Control(ARM_ETH_MAC_CONFIGURE,</div>
<div class="line">                             (uint32_t)(LinkInfo.speed                           ) |</div>
<div class="line">                             (uint32_t)(LinkInfo.duplex &lt;&lt; ARM_ETH_MAC_DUPLEX_Pos) |</div>
<div class="line">                              PacketFilter);</div>
<div class="line">        (void)EthMac-&gt;Control(ARM_ETH_MAC_CONTROL_TX, 1U);</div>
<div class="line">        (void)EthMac-&gt;Control(ARM_ETH_MAC_CONTROL_RX, 1U);</div>
<div class="line">      } <span class="keywordflow">else</span> {</div>
<div class="line">        (void)EthMac-&gt;Control(ARM_ETH_MAC_FLUSH,</div>
<div class="line">                              ARM_ETH_MAC_FLUSH_TX |</div>
<div class="line">                              ARM_ETH_MAC_FLUSH_RX);</div>
<div class="line">        (void)EthMac-&gt;Control(ARM_ETH_MAC_CONTROL_TX, 0U);</div>
<div class="line">        (void)EthMac-&gt;Control(ARM_ETH_MAC_CONTROL_RX, 0U);</div>
<div class="line">      }</div>
<div class="line">      state = (link_state == ARM_ETH_LINK_UP) ? 1U : 0U;</div>
<div class="line">      <span class="keywordflow">do</span> {</div>
<div class="line">        status = <a class="code hl_function" href="group__usbd__cdcFunctions__ncm__api.html#ga6966c46d11f2592edf7dde71f4220e3f" title="Report whether or not the physical layer (modem, Ethernet PHY, etc.) link is up to the USB Host.">USBD_CDC_NCM_Notify_NetworkConnection</a>(USB_CDC_NUM, state);</div>
<div class="line">      } <span class="keywordflow">while</span> (status == -(int32_t)<a class="code hl_enumvalue" href="rl__usb_8h.html#ga8196235c97e113f17993c7b4baff5f8fa5dfd259ecc4bbe016eaffb65838da4cb" title="Driver function is busy.">usbDriverBusy</a>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> ((event &amp; 0x80000000U) == 0U) {</div>
<div class="line">      <span class="keywordflow">if</span> (LinkState == ARM_ETH_LINK_UP) {</div>
<div class="line">        <span class="keywordflow">do</span> {</div>
<div class="line">          status = <a class="code hl_function" href="group__usbd__cdcFunctions__ncm__api.html#ga5888e54f798b2bf2d20bdc41b1e8af55" title="Report a change in upstream or downstream speed of the networking connection to the USB Host.">USBD_CDC_NCM_Notify_ConnectionSpeedChange</a>(USB_CDC_NUM, LinkSpeed, LinkSpeed);</div>
<div class="line">        } <span class="keywordflow">while</span> (status == -(int32_t)<a class="code hl_enumvalue" href="rl__usb_8h.html#ga8196235c97e113f17993c7b4baff5f8fa5dfd259ecc4bbe016eaffb65838da4cb" title="Driver function is busy.">usbDriverBusy</a>);</div>
<div class="line">      }</div>
<div class="line">      state = (LinkState == ARM_ETH_LINK_UP) ? 1U : 0U;</div>
<div class="line">      <span class="keywordflow">do</span> {</div>
<div class="line">        status = <a class="code hl_function" href="group__usbd__cdcFunctions__ncm__api.html#ga6966c46d11f2592edf7dde71f4220e3f" title="Report whether or not the physical layer (modem, Ethernet PHY, etc.) link is up to the USB Host.">USBD_CDC_NCM_Notify_NetworkConnection</a>(USB_CDC_NUM, state);</div>
<div class="line">      } <span class="keywordflow">while</span> (status == -(int32_t)<a class="code hl_enumvalue" href="rl__usb_8h.html#ga8196235c97e113f17993c7b4baff5f8fa5dfd259ecc4bbe016eaffb65838da4cb" title="Driver function is busy.">usbDriverBusy</a>);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Thread handling Data IN (ETH -&gt; USB)</span></div>
<div class="line">__NO_RETURN <span class="keyword">static</span> <span class="keywordtype">void</span> DataIN_Thread (<span class="keywordtype">void</span> *arg) {</div>
<div class="line">  uint32_t size;</div>
<div class="line">   int32_t status;</div>
<div class="line"> </div>
<div class="line">  (void)arg;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (;;) {</div>
<div class="line">    (void)osThreadFlagsWait(3U, osFlagsWaitAll, osWaitForever);</div>
<div class="line">    <span class="keywordflow">do</span> {</div>
<div class="line">      status = <a class="code hl_function" href="group__usbd__cdcFunctions__ncm__api.html#gae9c578e2dbb6b54b8963adee536aea11" title="Clear the active NTB (prepared for sending)">USBD_CDC_NCM_NTB_IN_Initialize</a>(USB_CDC_NUM);</div>
<div class="line">      <span class="keywordflow">if</span> (status != (int32_t)<a class="code hl_enumvalue" href="rl__usb_8h.html#ga8196235c97e113f17993c7b4baff5f8facfe6cb72ed8e7b8e95a38cbf95418dbf" title="Function completed with no error.">usbOK</a>) { <span class="keywordflow">continue</span>; }</div>
<div class="line">      status = <a class="code hl_function" href="group__usbd__cdcFunctions__ncm__api.html#gae9fa4907d191f9e78483d588eef7081f" title="Create a new NDP in the NTB (datagrams can be added to it)">USBD_CDC_NCM_NTB_IN_CreateNDP</a>(USB_CDC_NUM, MAX_IN_DATAGRAMS);</div>
<div class="line">      <span class="keywordflow">if</span> (status != (int32_t)<a class="code hl_enumvalue" href="rl__usb_8h.html#ga8196235c97e113f17993c7b4baff5f8facfe6cb72ed8e7b8e95a38cbf95418dbf" title="Function completed with no error.">usbOK</a>) { <span class="keywordflow">continue</span>; }</div>
<div class="line">      <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        <span class="keywordflow">if</span> (FrameIN_Size != 0) {</div>
<div class="line">          (void)<a class="code hl_function" href="group__usbd__cdcFunctions__ncm__api.html#gae55b3d343bccc5829fc5987a86cbe25d" title="Add a datagram into the active NDP of the NTB to be sent.">USBD_CDC_NCM_NTB_IN_WriteDatagram</a>(USB_CDC_NUM, FrameIN, FrameIN_Size);</div>
<div class="line">          FrameIN_Size = 0;</div>
<div class="line">        }</div>
<div class="line">        size = EthMac-&gt;GetRxFrameSize();</div>
<div class="line">        <span class="keywordflow">if</span> (size == 0U) {</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> ((size &lt; 14U) || (size &gt; NCM_State.max_datagram_size)) {</div>
<div class="line">          (void)EthMac-&gt;ReadFrame(NULL, 0U);</div>
<div class="line">          <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        (void)EthMac-&gt;ReadFrame(FrameIN, size);</div>
<div class="line">        <span class="keywordflow">if</span> (size &gt; 0) {</div>
<div class="line"><span class="preprocessor">          #if ((USBD_CDC%Instance%_NCM_BM_ETHERNET_STATISTICS &amp; 0x00000002) != 0)</span></div>
<div class="line">            NCM_State.eth_statistics[1]++;</div>
<div class="line"><span class="preprocessor">          #endif</span></div>
<div class="line">          status = <a class="code hl_function" href="group__usbd__cdcFunctions__ncm__api.html#gae55b3d343bccc5829fc5987a86cbe25d" title="Add a datagram into the active NDP of the NTB to be sent.">USBD_CDC_NCM_NTB_IN_WriteDatagram</a>(USB_CDC_NUM, FrameIN, size);</div>
<div class="line">          <span class="keywordflow">if</span> (status != (int32_t)<a class="code hl_enumvalue" href="rl__usb_8h.html#ga8196235c97e113f17993c7b4baff5f8facfe6cb72ed8e7b8e95a38cbf95418dbf" title="Function completed with no error.">usbOK</a>) {</div>
<div class="line">            FrameIN_Size = size;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">          }</div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">      (void)<a class="code hl_function" href="group__usbd__cdcFunctions__ncm__api.html#gaf2b9c281b2f5ba8d26ea598633d5c9ad" title="Send the active NTB.">USBD_CDC_NCM_NTB_IN_Send</a>(USB_CDC_NUM);</div>
<div class="line">    } <span class="keywordflow">while</span> (FrameIN_Size);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Thread handling Data OUT (USB -&gt; ETH)</span></div>
<div class="line">__NO_RETURN <span class="keyword">static</span> <span class="keywordtype">void</span> DataOUT_Thread (<span class="keywordtype">void</span> *arg) {</div>
<div class="line">  uint32_t size;</div>
<div class="line">  int32_t  len, status;</div>
<div class="line"> </div>
<div class="line">  (void)(arg);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (;;) {</div>
<div class="line">    (void)osThreadFlagsWait(1U, osFlagsWaitAll, osWaitForever);</div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">      status = <a class="code hl_function" href="group__usbd__cdcFunctions__ncm__api.html#ga0a24001aff5d9af6e8b040dc0cde6445" title="Process the next NDP in the received NTB.">USBD_CDC_NCM_NTB_OUT_ProcessNDP</a>(USB_CDC_NUM);</div>
<div class="line">      <span class="keywordflow">if</span> (status != (int32_t)<a class="code hl_enumvalue" href="rl__usb_8h.html#ga8196235c97e113f17993c7b4baff5f8facfe6cb72ed8e7b8e95a38cbf95418dbf" title="Function completed with no error.">usbOK</a>) { <span class="keywordflow">break</span>; }</div>
<div class="line">      <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        size = <a class="code hl_function" href="group__usbd__cdcFunctions__ncm__api.html#ga07e08df67e7fbc5a81f8ae9efabfc486" title="Get size of a datagram from the active NDP of the received NTB.">USBD_CDC_NCM_NTB_OUT_GetDatagramSize</a>(USB_CDC_NUM);</div>
<div class="line">        <span class="keywordflow">if</span> (size == 0U) { <span class="keywordflow">break</span>; }</div>
<div class="line">        <span class="keywordflow">if</span> ((size &lt; 14U) || (size &gt; NCM_State.max_datagram_size)) {</div>
<div class="line">          (void)<a class="code hl_function" href="group__usbd__cdcFunctions__ncm__api.html#ga74f401a77a548941e2c5ec998f4bf7f5" title="Read a datagram from the active NDP of the received NTB.">USBD_CDC_NCM_NTB_OUT_ReadDatagram</a>(USB_CDC_NUM, NULL, 0U);</div>
<div class="line">          <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        len = <a class="code hl_function" href="group__usbd__cdcFunctions__ncm__api.html#ga74f401a77a548941e2c5ec998f4bf7f5" title="Read a datagram from the active NDP of the received NTB.">USBD_CDC_NCM_NTB_OUT_ReadDatagram</a>(USB_CDC_NUM, FrameOUT, size);</div>
<div class="line">        <span class="keywordflow">if</span> (len &gt; 0) {</div>
<div class="line">          <span class="keywordflow">do</span> {</div>
<div class="line">            status = EthMac-&gt;SendFrame(FrameOUT, (uint32_t)(len), 0U);</div>
<div class="line">          } <span class="keywordflow">while</span> (status == ARM_DRIVER_ERROR_BUSY);</div>
<div class="line"><span class="preprocessor">          #if ((USBD_CDC%Instance%_NCM_BM_ETHERNET_STATISTICS &amp; 0x00000001) != 0)</span></div>
<div class="line">            NCM_State.eth_statistics[0]++;</div>
<div class="line"><span class="preprocessor">          #endif</span></div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">    (void)<a class="code hl_function" href="group__usbd__cdcFunctions__ncm__api.html#ga7ce93a9770eb6360bdd9d9c79be4f1b6" title="Flush the received NTB and release memory for reception of a new NTB.">USBD_CDC_NCM_NTB_OUT_Release</a>(USB_CDC_NUM);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">// RTE_CMSIS_RTOS2</span></div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
      <script type="text/javascript">
        <!--
        writeFooter.call(this);
        //-->
      </script> 
    </li>
  </ul>
</div>
</body>
</html>
