<!-- HTML header for doxygen 1.9.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>USB Component: MSC: Mass Storage Class</title>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="tabs.js"></script>
<script type="text/javascript" src="footer.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="URL_keys.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<script type="text/javascript" src="darkmode_toggle.js"></script>
<link href="extra_stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="extra_navtree.css" rel="stylesheet" type="text/css"/>
<link href="extra_search.css" rel="stylesheet" type="text/css"/>
<link href="extra_tabs.css" rel="stylesheet" type="text/css"/>
<link href="version.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../version.js"></script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 55px;">
  <td id="projectlogo" style="padding: 1.5em;"><img alt="Logo" src="armkeil_white_h.png"/></td>
  <td style="padding-left: 1em; padding-bottom: 1em;padding-top: 1em;">
   <div id="projectname">USB Component
   &#160;<span id="projectnumber"><script type="text/javascript">
     <!--
     writeHeader.call(this);
     writeVersionDropdown.call(this, "USB Component");
     //-->
    </script>
   </span>
   </div>
   <div id="projectbrief">MDK Middleware for USB Device and Host Communication</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
  <!--END !PROJECT_NAME-->
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<div id="CMSISnav" class="tabs1">
  <ul class="tablist">
    <script type="text/javascript">
      writeComponentTabs.call(this);
    </script>
  </ul>
</div>
<script type="text/javascript">
  writeSubComponentTabs.call(this);
</script>
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('group__usbd__mscFunctions.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="summary">
<a href="#groups">Content</a>  </div>
  <div class="headertitle"><div class="title">MSC: Mass Storage Class<div class="ingroups"><a class="el" href="group__usbd.html">USB Device</a> &raquo; <a class="el" href="group__usbd__DevClassFunctions.html">Device Class</a></div></div></div>
</div><!--header-->
<div class="contents">

<p>Implement application specific behavior of a Mass Storage Class (MSC) USB Device.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="groups" name="groups"></a>
Content</h2></td></tr>
<tr class="memitem:group__usbd__mscFunctions__api"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__usbd__mscFunctions__api.html">User API</a></td></tr>
<tr class="memdesc:group__usbd__mscFunctions__api"><td class="mdescLeft">&#160;</td><td class="mdescRight">User API reference of the Mass Storage Class. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:group__usbd__mscFunctions__conf"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__usbd__mscFunctions__conf.html">Configuration</a></td></tr>
<tr class="memdesc:group__usbd__mscFunctions__conf"><td class="mdescLeft">&#160;</td><td class="mdescRight">Configuration of the USB Device MSC Class. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Description</h2>
<p>Implement application specific behavior of a Mass Storage Class (MSC) USB Device. </p>
<p>The MSC class in the USB Component is used for data storage.</p>
<p>Refer to:</p><ul>
<li><a class="el" href="USB_Classes.html#MSC">MSC: Mass Storage Class</a> for an overview of the MSC class.</li>
<li><a class="el" href="usbd_example_msc.html">USB Device Mass Storage</a> for example projects that use the MSC class on USB Device.</li>
<li><a class="el" href="usbh_example_msc.html">USB Host Mass Storage</a> for example projects that use the MSC class on USB Host.</li>
</ul>
<p>The USB Component allows multiple instances of the MSC class. Each MSC class instance has a separate files and interface functions:</p><ul>
<li>A configuration file <a class="el" href="group__usbd__mscFunctions__conf.html">USBD_Config_MSC_n.h</a>.</li>
<li>An application-specific user source code file, which can be implemented with the  <script>link_ext('uv4_ca_sourcefiles');</script> <b>USBD_User_MSC_<em>n</em>.c</b>.</li>
<li>Functions that start with the prefix <b>USBD_MSCn_</b> are available for each instance of a MSC class. <br  />
</li>
</ul>
<p>This documentation uses <em>n</em> as a placeholder for the instance number <em>0</em> - <em>3</em>. Most applications only require one instance of a MSC class. For the first MSC class instance the instance number is 0:</p><ul>
<li><b>USBD_Config_MSC_0.h</b></li>
<li><b>USBD_User_MSC_0.c</b></li>
<li>The function prefix is <b>USBD_MSC0_</b></li>
</ul>
<p><b>Software</b> <b>Structure</b> </p>
<p>The handling for the MSC class endpoint events is implemented in <b>USBD_MSCn_Thread</b> which is started by <a class="el" href="group__usbd__coreFunctions__api.html#ga65ba44a47e3fa46a15f70bab9917c8ca">USBD_Initialize</a>. Each instance of a MSC class runs an instance of <b>USBD_MSCn_Thread</b> which calls the data functions <a class="el" href="group__usbd__mscFunctions__api.html#ga59e44d763427732071b46f7ac408efbf">USBD_MSCn_Read</a> and <a class="el" href="group__usbd__mscFunctions__api.html#ga06735f888bd06c9b6d4af2c7a0a6dbed">USBD_MSCn_Write</a>.</p>
<div class="mscgraph">
<img src="msc_inline_mscgraph_6.png" alt="msc_inline_mscgraph_6" border="0" usemap="#msc_inline_mscgraph_6.map"/>
<map name="msc_inline_mscgraph_6.map" id="msc_inline_mscgraph_6.map"><area href="group__usbd__coreFunctions__api.html#ga65ba44a47e3fa46a15f70bab9917c8ca" shape="rect" coords="31,91,120,104" alt=""/>
<area href="group__usbd__coreFunctions__api.html#gad97153303fc0a6f51c1c20ac050b238f" shape="rect" coords="40,142,111,155" alt=""/>
<area href="group__usbd__mscFunctions__api.html#ga06735f888bd06c9b6d4af2c7a0a6dbed" shape="rect" coords="31,244,120,257" alt=""/>
<area href="group__usbd__mscFunctions__api.html#ga59e44d763427732071b46f7ac408efbf" shape="rect" coords="34,295,117,308" alt=""/>
<area href="group__usbd__coreFunctions__api.html#ga9440f139618900f2011034e70cd7a528" shape="rect" coords="31,346,120,359" alt=""/>
<area href="group__usbd__coreFunctions__api.html#gabefe6dae72a49806a96b981c286d0aeb" shape="rect" coords="25,397,126,410" alt=""/>
</map>
</div>
<h2><a class="anchor" id="autotoc_md31"></a>
Implementation</h2>
<p>To <a class="el" href="usbd_create_app.html">create an USB Device</a> with a MSC class:</p><ul>
<li>Set the required number for USB:Device:MSC class instances during the <a class="el" href="usbd_create_app.html#RTE_Software_Component_Selection">RTE Component Selection</a>.</li>
<li>Set the parameters in the configuration file <a class="el" href="group__usbd__mscFunctions__conf.html">USBD_Config_MSC_n.h</a>.</li>
<li>Implement the application specific behavior using a <a class="el" href="group__usbd__mscFunctions.html#UCT_USBD_User_MSC">template</a>.</li>
</ul>
<p><b>Media</b> <b>Ownership</b> </p>
<p>Sometimes, it is required to implement the ownership control over attached media and changing the ownership between USB and File System. This is required if you have a device that connects to a PC as a USB MSC device while the storage media also needs to be accessible to a user application. Using the two functions <a class="el" href="group__usbd__mscFunctions__api.html#gaa4980d1e78856e15cd45345a8ede31fb">USBD_MSCn_SetMediaOwnerUSB</a> and <a class="el" href="group__usbd__mscFunctions__api.html#gaf123b5ca1fd48de139d22432b2f5440e">USBD_MSCn_SetMediaOwnerFS</a> you can change the owner of the media to either the USB (the host PC) or the File System (the user application). The user code template <a class="el" href="group__usbd__mscFunctions.html#USBD_MSC_UCT">USBD_MSC.c</a> provides means to manage the ownership.</p>
<p>The following picture shows the connection of the device to the PC and the user application running on the device:</p>
<div class="image">
<img src="usbd_msc_media_access.png" alt=""/>
<div class="caption">
USB MSC Device connected to a PC with a user application accessing the attached storage medium</div></div>
<p>In the file <a class="el" href="group__usbd__mscFunctions.html#USBD_MSC_UCT">USBD_MSC.c</a> the variable <code>usbd_msc0_media_own</code> is used to set the ownership of the media device to the application or the File System. In the file <a class="el" href="group__usbd__mscFunctions.html#USBD_User_MSC_UCT">USBD_User_MSC.c</a> the variable is used to initialize it at the beginning of the application (in the <b>USBD_MSCn_Initialize</b> function) and to check the ownership of the media (in the <b>USBD_MSCn_CheckMedia</b> function). The application then only makes use of the two functions <b>USBD_MSCn_SetMediaOwnerUSB</b> and <b>USBD_MSCn_SetMediaOwnerFS</b> as explained in this <a class="el" href="group__usbd__mscFunctions.html#USBD_User_MSC_Application">code example</a>.</p>
<p><a class="anchor" id="UCT_USBD_User_MSC"></a><b>User</b> <b>Code</b> <b>Templates</b> <br  />
 There are three user code templates available that help to add support for a MSC device:</p><ol type="1">
<li><a class="el" href="group__usbd__mscFunctions.html#USBD_User_MSC_UCT">USBD_User_MSC.c</a> contains all the callback functions that need to be implemented by the user.</li>
<li><a class="el" href="group__usbd__mscFunctions.html#USBD_MSC_UCT">USBD_MSC.c</a> is a code template for the application specific functionality of a USB Device MSC instance and implements ownership control for attached media devices.</li>
<li><a class="el" href="group__usbd__mscFunctions.html#USBD_User_MSC_LUN">USBD_User_MSC_LUN.c</a> is a code template that includes the required callback functions to implement multiple logical units (LUNs).</li>
</ol>
<p><a class="anchor" id="USBD_User_MSC_UCT"></a><b>User</b> <b>Code</b> <b>Template</b> <b>USBD_User_MSC.c</b> </p>
<p>The following source code can be used to implement the application specific behavior of a USB MSC Device.</p>
<div class="fragment"><div class="line"><span class="comment">/*------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * MDK Middleware - Component ::USB:Device:MSC</span></div>
<div class="line"><span class="comment"> * Copyright (c) 2004-2020 Arm Limited (or its affiliates). All rights reserved.</span></div>
<div class="line"><span class="comment"> *------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * Name:    USBD_User_MSC_%Instance%.c</span></div>
<div class="line"><span class="comment"> * Purpose: USB Device Mass Storage Device class (MSC) User module</span></div>
<div class="line"><span class="comment"> * Rev.:    V6.3.4</span></div>
<div class="line"><span class="comment"> *----------------------------------------------------------------------------*/</span><span class="comment"></span></div>
<div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment"> * \addtogroup usbd_mscFunctions</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"> <span class="comment"></span></div>
<div class="line"><span class="comment">//! [code_USBD_User_MSC]</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdbool.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="rl__usb_8h.html">rl_usb.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// If the USE_FILE_SYSTEM value is 1 then File System is used and media can</span></div>
<div class="line"><span class="comment">// be accessed from application code or can be accessed by USB Mass Storage</span></div>
<div class="line"><span class="comment">// requests, default media in that case is one selected as default in File</span></div>
<div class="line"><span class="comment">// System Configuration file.</span></div>
<div class="line"><span class="comment">// If the USE_FILE_SYSTEM value is 0 then File System is not used and media</span></div>
<div class="line"><span class="comment">// can only be accessed by USB Mass Storage requests, default media in that</span></div>
<div class="line"><span class="comment">// case is RAM memory containing dummy disk image.</span></div>
<div class="line"><span class="preprocessor">#define USE_FILE_SYSTEM   1             </span><span class="comment">// 1 = File System is used, 0 = File System is not used</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Definition MEDIA_DRIVE is used to define Drive to be used for media</span></div>
<div class="line"><span class="comment">// Available options are:</span></div>
<div class="line"><span class="comment">//   &quot;R:&quot; or &quot;R0:&quot; if media is RAM</span></div>
<div class="line"><span class="comment">//   &quot;M:&quot; or &quot;M0:&quot; if media is Memory Card 0</span></div>
<div class="line"><span class="comment">//           &quot;M1:&quot; if media is Memory Card 1</span></div>
<div class="line"><span class="comment">//   &quot;N:&quot; or &quot;N0:&quot; if media is NAND Flash 0</span></div>
<div class="line"><span class="comment">//           &quot;N1:&quot; if media is NAND Flash 1</span></div>
<div class="line"><span class="preprocessor">#define MEDIA_DRIVE     &quot;M0:&quot;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if (USE_FILE_SYSTEM == 1)              </span><span class="comment">// If File System is used</span></div>
<div class="line"><span class="preprocessor">#include &quot;rl_fs.h&quot;</span></div>
<div class="line"><span class="preprocessor">#define  MEDIA_OWN_USB     (1U     )    </span><span class="comment">// Media owned by USB (bit mask)</span></div>
<div class="line"><span class="preprocessor">#define  MEDIA_OWN_CHG     (1U &lt;&lt; 1)    </span><span class="comment">// Media ownership change requested (bit mask)</span></div>
<div class="line"><span class="keyword">extern</span> </div>
<div class="line"><span class="keyword">volatile</span> uint8_t  usbd_msc%Instance%_media_own;</div>
<div class="line"><span class="keyword">volatile</span> uint8_t  usbd_msc%Instance%_media_own;  <span class="comment">// USB MSC%Instance% media ownership</span></div>
<div class="line"><span class="keyword">static</span>   int32_t  drv_id;               <span class="comment">// FAT drive id</span></div>
<div class="line"><span class="keyword">static</span>   <span class="keywordtype">bool</span>     media_ok;             <span class="comment">// Media is initialized and ok</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="keyword">static</span>   uint32_t memory   [8192/4];    <span class="comment">// Memory in RAM for dummy disk image</span></div>
<div class="line"><span class="keyword">static</span>   uint32_t block_buf[ 512/4];    <span class="comment">// Buffer for block read/write to media</span></div>
<div class="line"><span class="keyword">extern</span></div>
<div class="line"><span class="keyword">const</span>    uint8_t  memory_disk_image[4096];  <span class="comment">// Dummy Memory Disk Image</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called during USBD_Initialize to initialize the USB MSC class instance.</span></div>
<div class="line"><span class="keywordtype">void</span> USBD_MSC%Instance%_Initialize (<span class="keywordtype">void</span>) {</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if (USE_FILE_SYSTEM == 1)              </span><span class="comment">// If File System is used</span></div>
<div class="line">  uint32_t param_status;</div>
<div class="line"> </div>
<div class="line">  usbd_msc%Instance%_media_own = MEDIA_OWN_USB;  <span class="comment">// Initially media is owned by USB</span></div>
<div class="line">  media_ok            = <span class="keyword">false</span>;          <span class="comment">// Current media status (not initialized = not ok)</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (finit (MEDIA_DRIVE) != fsOK) {    <span class="comment">// Initialize File System</span></div>
<div class="line">    <span class="keywordflow">return</span>;                             <span class="comment">// Exit if failed</span></div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  drv_id = fs_ioc_get_id (MEDIA_DRIVE); <span class="comment">// Get ID of media drive</span></div>
<div class="line">  <span class="keywordflow">if</span> (drv_id &lt; 0)           { <span class="keywordflow">return</span>; } <span class="comment">// If ID is invalid exit</span></div>
<div class="line"> </div>
<div class="line">  param_status = 0U;                    <span class="comment">// Parameter for function call is 0</span></div>
<div class="line">                                        <span class="comment">// Initialize media</span></div>
<div class="line">  <span class="keywordflow">if</span> (fs_ioc_device_ctrl (drv_id, fsDevCtrlCodeControlMedia, &amp;param_status) != fsOK) {</div>
<div class="line">    <span class="keywordflow">return</span>;                             <span class="comment">// Exit if failed</span></div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (fs_ioc_lock (drv_id)) {           <span class="comment">// Lock media for USB usage</span></div>
<div class="line">    <span class="keywordflow">return</span>;                             <span class="comment">// Exit if failed</span></div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  media_ok = <span class="keyword">true</span>;                      <span class="comment">// Media was initialized and is ok</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">                                        <span class="comment">// Copy the dummy image from code to RAM</span></div>
<div class="line">  memcpy (memory, memory_disk_image, <span class="keyword">sizeof</span>(memory_disk_image));</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// \brief Called during USBD_Uninitialize to de-initialize the USB MSC class instance.</span></div>
<div class="line"><span class="keywordtype">void</span> USBD_MSC%Instance%_Uninitialize (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for de-initialization</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Get cache information.</span></div>
<div class="line"><span class="comment">// \param[out]    buffer               cache buffer address.</span></div>
<div class="line"><span class="comment">// \param[out]    size                 cache buffer size.</span></div>
<div class="line"><span class="comment">// \return        true                 operation succeeded.</span></div>
<div class="line"><span class="comment">// \return        false                operation failed.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_MSC%Instance%_GetCacheInfo (uint32_t *buffer, uint32_t *size) {</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if (USE_FILE_SYSTEM == 1)              </span><span class="comment">// If File System is used</span></div>
<div class="line">  fsIOC_Cache cache_info;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Get cache settings of File System</span></div>
<div class="line">  <span class="keywordflow">if</span> (fs_ioc_get_cache(drv_id, &amp;cache_info) != fsOK) {</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;                       <span class="comment">// Exit if failed</span></div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Use File Systems cache for MSC</span></div>
<div class="line">  *buffer = (uint32_t)cache_info.buffer;<span class="comment">// Cache buffer from File System</span></div>
<div class="line">  *size   = cache_info.size;            <span class="comment">// Cache size</span></div>
<div class="line">#<span class="keywordflow">else</span></div>
<div class="line">  *buffer = (uint32_t)block_buf;        <span class="comment">// Local buffer for data</span></div>
<div class="line">  *size   = <span class="keyword">sizeof</span>(block_buf);          <span class="comment">// Size of local buffer</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Get media capacity.</span></div>
<div class="line"><span class="comment">// \param[out]    block_count          total number of blocks on media.</span></div>
<div class="line"><span class="comment">// \param[out]    block_size           media block size.</span></div>
<div class="line"><span class="comment">// \return        true                 operation succeeded.</span></div>
<div class="line"><span class="comment">// \return        false                operation failed.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_MSC%Instance%_GetMediaCapacity (uint32_t *block_count, uint32_t *block_size) {</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if (USE_FILE_SYSTEM == 1)              </span><span class="comment">// If File System is used</span></div>
<div class="line">  fsMediaInfo media_info;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Read media information of actual media</span></div>
<div class="line">  <span class="keywordflow">if</span> (fs_ioc_read_info(drv_id, &amp;media_info) != fsOK) {</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;                       <span class="comment">// Exit if failed</span></div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  *block_count = media_info.block_cnt;  <span class="comment">// Total number of blocks on media</span></div>
<div class="line">  *block_size  = media_info.read_blen;  <span class="comment">// Block size of blocks on media</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  *block_count = <span class="keyword">sizeof</span>(memory)/512U;   <span class="comment">// Total number of blocks on media</span></div>
<div class="line">  *block_size  = 512U;                  <span class="comment">// Block size of blocks on media</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Read data from media.</span></div>
<div class="line"><span class="comment">// \param[in]     lba                  logical address of first block to read.</span></div>
<div class="line"><span class="comment">// \param[in]     cnt                  number of contiguous blocks to read from media.</span></div>
<div class="line"><span class="comment">// \param[out]    buf                  data buffer for data read from media.</span></div>
<div class="line"><span class="comment">// \return        true                 read succeeded.</span></div>
<div class="line"><span class="comment">// \return        false                read failed.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_MSC%Instance%_Read (uint32_t lba, uint32_t cnt, uint8_t *buf) {</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if (USE_FILE_SYSTEM == 1)              </span><span class="comment">// If File System is used</span></div>
<div class="line">                                        <span class="comment">// Read data directly from media</span></div>
<div class="line">  <span class="keywordflow">if</span> (fs_ioc_read_sector (drv_id, lba, buf, cnt) != fsOK) {</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">  }</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">                                        <span class="comment">// Read data from dummy image in RAM</span></div>
<div class="line">  memcpy (buf, &amp;memory[lba * (512U/4U)], cnt * 512U);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Write data to media.</span></div>
<div class="line"><span class="comment">// \param[in]     lba                  logical address of first block to write.</span></div>
<div class="line"><span class="comment">// \param[in]     cnt                  number of contiguous blocks to write to media.</span></div>
<div class="line"><span class="comment">// \param[out]    buf                  data buffer containing data to write to media.</span></div>
<div class="line"><span class="comment">// \return        true                 write succeeded.</span></div>
<div class="line"><span class="comment">// \return        false                write failed.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_MSC%Instance%_Write (uint32_t lba, uint32_t cnt, <span class="keyword">const</span> uint8_t *buf) {</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if (USE_FILE_SYSTEM == 1)              </span><span class="comment">// If File System is used</span></div>
<div class="line">                                        <span class="comment">// Write data directly to media</span></div>
<div class="line">  <span class="keywordflow">if</span> (fs_ioc_write_sector (drv_id, lba, buf, cnt) != fsOK) {</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">  }</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">                                        <span class="comment">// Write data to image in RAM</span></div>
<div class="line">  memcpy (&amp;memory[lba * (512U/4U)], buf, cnt * 512U);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Check media presence and write protect status.</span></div>
<div class="line"><span class="comment">//        (if media is not owned by USB it returns that media is not ready)</span></div>
<div class="line"><span class="comment">// \return                             media presence and write protected status</span></div>
<div class="line"><span class="comment">//                bit 1:               write protect bit</span></div>
<div class="line"><span class="comment">//                 - value 1:            media is write protected</span></div>
<div class="line"><span class="comment">//                 - value 0:            media is not write protected</span></div>
<div class="line"><span class="comment">//                bit 0:               media presence bit</span></div>
<div class="line"><span class="comment">//                 - value 1:            media is present</span></div>
<div class="line"><span class="comment">//                 - value 0:            media is not present</span></div>
<div class="line">uint32_t USBD_MSC%Instance%_CheckMedia (<span class="keywordtype">void</span>) {</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if (USE_FILE_SYSTEM == 1)              </span><span class="comment">// If File System is used</span></div>
<div class="line">       uint32_t param_status;</div>
<div class="line">       uint8_t  media_state;            <span class="comment">// Bit 0. media ready, Bit 1. media write protect</span></div>
<div class="line"><span class="keyword">static</span> uint8_t  media_ready_ex = 0U;    <span class="comment">// Previous media ready state</span></div>
<div class="line">       uint8_t  own;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Get current media status</span></div>
<div class="line">  media_state = 0U;</div>
<div class="line">  <span class="keywordflow">switch</span> (fs_ioc_device_ctrl (drv_id, fsDevCtrlCodeCheckMedia, &amp;param_status)) {</div>
<div class="line">    <span class="keywordflow">case</span> fsOK:</div>
<div class="line">      <span class="keywordflow">if</span> (param_status &amp; FS_MEDIA_NOCHKMEDIA) {</div>
<div class="line">        <span class="comment">// If check media not available on hardware layer</span></div>
<div class="line">        media_state  =  <a class="code hl_define" href="rl__usb_8h.html#a482c47f8c79666788aa9102db241a251" title="USB Device MSC Check Media bit masks.">USBD_MSC_MEDIA_READY</a>;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">if</span> (param_status &amp; FS_MEDIA_INSERTED) {</div>
<div class="line">        media_state  =  <a class="code hl_define" href="rl__usb_8h.html#a482c47f8c79666788aa9102db241a251" title="USB Device MSC Check Media bit masks.">USBD_MSC_MEDIA_READY</a>;</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">if</span> (param_status &amp; FS_MEDIA_PROTECTED) {</div>
<div class="line">        media_state |=  <a class="code hl_define" href="rl__usb_8h.html#aacab5c197e8fc0c05a01ad59096326cb" title="Media Write Protected.">USBD_MSC_MEDIA_PROTECTED</a>;</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> fsError:</div>
<div class="line">    <span class="keywordflow">case</span> fsUnsupported:</div>
<div class="line">    <span class="keywordflow">case</span> fsAccessDenied:</div>
<div class="line">    <span class="keywordflow">case</span> fsInvalidParameter:</div>
<div class="line">    <span class="keywordflow">case</span> fsInvalidDrive:</div>
<div class="line">    <span class="keywordflow">case</span> fsInvalidPath:</div>
<div class="line">    <span class="keywordflow">case</span> fsUninitializedDrive:</div>
<div class="line">    <span class="keywordflow">case</span> fsDriverError:</div>
<div class="line">    <span class="keywordflow">case</span> fsMediaError:</div>
<div class="line">    <span class="keywordflow">case</span> fsNoMedia:</div>
<div class="line">    <span class="keywordflow">case</span> fsNoFileSystem:</div>
<div class="line">    <span class="keywordflow">case</span> fsNoFreeSpace:</div>
<div class="line">    <span class="keywordflow">case</span> fsFileNotFound:</div>
<div class="line">    <span class="keywordflow">case</span> fsDirNotEmpty:</div>
<div class="line">    <span class="keywordflow">case</span> fsTooManyOpenFiles:</div>
<div class="line">    <span class="keywordflow">case</span> fsAlreadyExists:</div>
<div class="line">    <span class="keywordflow">case</span> fsNotDirectory:</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Store current owner so no new request can interfere</span></div>
<div class="line">  own = usbd_msc%Instance%_media_own;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// De-initialize media according to previous owner</span></div>
<div class="line">  <span class="keywordflow">if</span> (own &amp; MEDIA_OWN_CHG) {                    <span class="comment">// If owner change requested</span></div>
<div class="line">    <span class="keywordflow">if</span> (own &amp; MEDIA_OWN_USB) {                  <span class="comment">// If new requested owner is USB (previous owner was File System)</span></div>
<div class="line">      (void)funmount (MEDIA_DRIVE);             <span class="comment">// De-initialize media and dismount Drive</span></div>
<div class="line">    } <span class="keywordflow">else</span> {                                    <span class="comment">// If new requested owner is File System (previous owner was USB)</span></div>
<div class="line">      (void)fs_ioc_unlock (drv_id);             <span class="comment">// Un-lock media</span></div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Initialize media according to current owner</span></div>
<div class="line">  <span class="keywordflow">if</span> ((own &amp; MEDIA_OWN_CHG)        ||           <span class="comment">// If owner change requested or</span></div>
<div class="line">      (media_state ^ media_ready_ex)) {         <span class="comment">// if media ready state has changed (disconnect(SD remove)/connect(SD insert))</span></div>
<div class="line">    <span class="keywordflow">if</span> (media_state &amp; <a class="code hl_define" href="rl__usb_8h.html#a482c47f8c79666788aa9102db241a251" title="USB Device MSC Check Media bit masks.">USBD_MSC_MEDIA_READY</a>) {   <span class="comment">// If media is ready</span></div>
<div class="line">      <span class="keywordflow">if</span> (own &amp; MEDIA_OWN_USB){                 <span class="comment">// If current owner is USB</span></div>
<div class="line">        media_ok     = <span class="keyword">false</span>;                   <span class="comment">// Invalidate current media status (not initialized = not ok)</span></div>
<div class="line">        param_status = 0U;                      <span class="comment">// Parameter for function call is 0</span></div>
<div class="line">        <span class="keywordflow">if</span> (fs_ioc_device_ctrl (drv_id, fsDevCtrlCodeControlMedia, &amp;param_status) == fsOK) {</div>
<div class="line">                                                <span class="comment">// Initialization of media has succeeded</span></div>
<div class="line">          <span class="keywordflow">if</span> (fs_ioc_lock (drv_id) == fsOK) {   <span class="comment">// If lock media for USB usage has succeeded</span></div>
<div class="line">            media_ok = <span class="keyword">true</span>;                    <span class="comment">// Media was initialized and is ok</span></div>
<div class="line">          }</div>
<div class="line">        }</div>
<div class="line">      } <span class="keywordflow">else</span> {                                  <span class="comment">// If current owner is File System</span></div>
<div class="line">        <span class="keywordflow">if</span> (fmount (MEDIA_DRIVE) == fsOK) {     <span class="comment">// Initialize media and Mount Drive for File System usage</span></div>
<div class="line">          media_ok = <span class="keyword">true</span>;                      <span class="comment">// Media was initialized and is ok</span></div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (own &amp; MEDIA_OWN_CHG) {</div>
<div class="line">      usbd_msc%Instance%_media_own &amp;= ~MEDIA_OWN_CHG;    <span class="comment">// Clear request to change media owner if it was handled</span></div>
<div class="line">    }</div>
<div class="line">    media_ready_ex = media_state &amp; <a class="code hl_define" href="rl__usb_8h.html#a482c47f8c79666788aa9102db241a251" title="USB Device MSC Check Media bit masks.">USBD_MSC_MEDIA_READY</a>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// If media is not ok or owned by File System return that it is not ready for USB</span></div>
<div class="line">  <span class="keywordflow">if</span> ((!media_ok) || (!(usbd_msc%Instance%_media_own &amp; MEDIA_OWN_USB))) {</div>
<div class="line">    <span class="keywordflow">return</span> 0U;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> media_state;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  <span class="keywordflow">return</span> <a class="code hl_define" href="rl__usb_8h.html#a482c47f8c79666788aa9102db241a251" title="USB Device MSC Check Media bit masks.">USBD_MSC_MEDIA_READY</a>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">}<span class="comment"></span></div>
<div class="line"><span class="comment">//! [code_USBD_User_MSC]</span></div>
</div><!-- fragment --><p><a class="anchor" id="USBD_MSC_UCT"></a><b>User</b> <b>Code</b> <b>Template</b> <b>USBD_MSC_n.c</b> </p>
<p>The following source code can be used to implement ownership control for attached media devices.</p>
<div class="fragment"><div class="line"><span class="comment">/*------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * MDK Middleware - Component ::USB:Device:MSC</span></div>
<div class="line"><span class="comment"> * Copyright (c) 2004-2024 Arm Limited (or its affiliates). All rights reserved.</span></div>
<div class="line"><span class="comment"> *------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * Name:    USBD_MSC_%Instance%.c</span></div>
<div class="line"><span class="comment"> * Purpose: Functions for media ownership control between USB and File System</span></div>
<div class="line"><span class="comment"> * Rev.:    V6.3.7</span></div>
<div class="line"><span class="comment"> *----------------------------------------------------------------------------*/</span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * USBD_MSC_%Instance%.c is a code template for the application specific functionality of</span></div>
<div class="line"><span class="comment"> * the USB Device MSC class %Instance% instance. It implements the ownership control over</span></div>
<div class="line"><span class="comment"> * media and changing the owner of media between USB and File System.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * USBD_MSC_%Instance%.h is the related header file.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * To select USB as owner of media you can call function:</span></div>
<div class="line"><span class="comment"> *   USBD_MSC%Instance%_SetMediaOwnerUSB ()</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * To select File System as owner of media you can call function:</span></div>
<div class="line"><span class="comment"> *   USBD_MSC%Instance%_SetMediaOwnerFS  ()</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="rl__usb_8h.html">rl_usb.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;USBD_MSC_%Instance%.h&quot;</span>                 <span class="comment">// Media ownership control for USB Device</span></div>
<div class="line"><span class="preprocessor">#include &quot;USBD_Config_MSC_%Instance%.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifndef  RTE_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor">#error   This user template requires CMSIS-RTOS2!</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">extern</span> <span class="keyword">volatile</span> uint8_t usbd_msc%Instance%_media_own;    <span class="comment">// USB MSC%Instance% media ownership</span></div>
<div class="line"> </div>
<div class="line"> <span class="comment"></span></div>
<div class="line"><span class="comment">//! [usbd_msc_setmediaownerusb]</span></div>
<div class="line"><span class="comment">/// \brief Set USB as media owner</span></div>
<div class="line"><span class="comment">/// \return     execution status</span></div>
<div class="line"><span class="comment">///               - USBD_MSC_OK           = Media ownership changed successfully</span></div>
<div class="line"><span class="comment">///               - USBD_MSC_ERROR        = Media ownership change has failed (due timeout)</span></div>
<div class="line"><span class="comment"></span>int32_t USBD_MSC%Instance%_SetMediaOwnerUSB (<span class="keywordtype">void</span>) {</div>
<div class="line">  uint32_t timeout_cnt;</div>
<div class="line"> </div>
<div class="line">  timeout_cnt = 300U;                   <span class="comment">// 3 second timeout (300 * 10 ms)</span></div>
<div class="line">  usbd_msc%Instance%_media_own = USBD_MSC%Instance%_MEDIA_OWN_CHG | USBD_MSC%Instance%_MEDIA_OWN_USB;</div>
<div class="line">  <span class="keywordflow">while</span> (usbd_msc%Instance%_media_own &amp; USBD_MSC%Instance%_MEDIA_OWN_CHG) {</div>
<div class="line">    (void)osDelay(10);</div>
<div class="line">    <span class="keywordflow">if</span> ((--timeout_cnt) == 0) { <span class="keywordflow">return</span> USBD_MSC%Instance%_ERROR; }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> USBD_MSC%Instance%_OK;</div>
<div class="line">}<span class="comment"></span></div>
<div class="line"><span class="comment">//! [usbd_msc_setmediaownerusb]</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"> <span class="comment"></span></div>
<div class="line"><span class="comment">//! [usbd_msc_setmediaownerfs]</span></div>
<div class="line"><span class="comment">/// \brief Set File System as media owner</span></div>
<div class="line"><span class="comment">/// \return     execution status</span></div>
<div class="line"><span class="comment">///               - USBD_MSC_OK           = Media ownership changed successfully</span></div>
<div class="line"><span class="comment">///               - USBD_MSC_ERROR        = Media ownership change has failed (due timeout)</span></div>
<div class="line"><span class="comment"></span>int32_t USBD_MSC%Instance%_SetMediaOwnerFS (<span class="keywordtype">void</span>) {</div>
<div class="line">  uint32_t timeout_cnt;</div>
<div class="line"> </div>
<div class="line">  timeout_cnt = 300U;                   <span class="comment">// 3 second timeout (300 * 10 ms)</span></div>
<div class="line">  usbd_msc%Instance%_media_own = USBD_MSC%Instance%_MEDIA_OWN_CHG;</div>
<div class="line">  <span class="keywordflow">while</span> (usbd_msc%Instance%_media_own &amp; USBD_MSC%Instance%_MEDIA_OWN_CHG) {</div>
<div class="line">    <span class="keywordflow">if</span>(!<a class="code hl_function" href="group__usbd__coreFunctions__api.html#gabcbbc7a70c6050fbaec107968a581487" title="Retrieve USB Device configuration status.">USBD_Configured</a>(USBD_MSC%Instance%_DEV)) {</div>
<div class="line">      <span class="comment">/* USB device not configured, so call CheckMedia to do ownership handling */</span></div>
<div class="line">      (void)USBD_MSC%Instance%_CheckMedia();</div>
<div class="line">    }</div>
<div class="line">    (void)osDelay(10);</div>
<div class="line">    <span class="keywordflow">if</span> ((--timeout_cnt) == 0) { <span class="keywordflow">return</span> USBD_MSC%Instance%_ERROR; }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> USBD_MSC%Instance%_OK;</div>
<div class="line">}<span class="comment"></span></div>
<div class="line"><span class="comment">//! [usbd_msc_setmediaownerfs]</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">// RTE_CMSIS_RTOS2</span></div>
</div><!-- fragment --><p><a class="anchor" id="USBD_User_MSC_Application"></a><b>Code</b> <b>Example</b> </p>
<p>This code snippet shows how to use the two functions in a user application: </p><div class="fragment"><div class="line">:</div>
<div class="line"><span class="keywordflow">switch</span> (DeviceState) {</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">case</span> DEV_IDLE:</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">case</span> DEV_START_DOING_SOMETHING:</div>
<div class="line">    <span class="comment">// hide logical unit</span></div>
<div class="line">    USBD_MSC0_SetMediaOwnerFS();  </div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Application has now access to the media</span></div>
<div class="line">    <span class="comment">// and can do something here (e.g. fopen, fread, fwrite, fclose, ...)</span></div>
<div class="line">    DeviceState = DEV_DO_IT;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">case</span> DEV_STOP_DOING_SOMETHING:</div>
<div class="line">    <span class="comment">// show logical unit</span></div>
<div class="line">    USBD_MSC0_SetMediaOwnerUSB();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Media is now under control of the USB Host</span></div>
<div class="line">    <span class="comment">// and cannot be accessed by the application</span></div>
<div class="line">    DeviceState = DEV_IDLE;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">}</div>
<div class="line">:</div>
</div><!-- fragment --><p><a class="anchor" id="USBD_User_MSC_LUN"></a><b>User</b> <b>Code</b> <b>Template</b> <b>USBD_User_MSC_LUN.c</b> </p>
<p>The following source code can be used to implement multiple logical units (LUNs) in a USB device.</p>
<div class="fragment"><div class="line"><span class="comment">/*------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * MDK Middleware - Component ::USB:Device:MSC</span></div>
<div class="line"><span class="comment"> * Copyright (c) 2004-2020 Arm Limited (or its affiliates). All rights reserved.</span></div>
<div class="line"><span class="comment"> *------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * Name:    USBD_User_MSC_LUN_%Instance%.c</span></div>
<div class="line"><span class="comment"> * Purpose: USB Device Mass Storage Device class (MSC) with 2 Logical</span></div>
<div class="line"><span class="comment"> *          Units User module</span></div>
<div class="line"><span class="comment"> * Rev.:    V1.1.1</span></div>
<div class="line"><span class="comment"> *----------------------------------------------------------------------------*/</span><span class="comment"></span></div>
<div class="line"><span class="comment">/**</span></div>
<div class="line"><span class="comment"> * \addtogroup usbd_mscFunctions</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"> <span class="comment"></span></div>
<div class="line"><span class="comment">//! [code_USBD_User_MSC_LUN]</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdbool.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="rl__usb_8h.html">rl_usb.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span>   uint32_t memory   [2][8192/4];         <span class="comment">// Memory in RAM for dummy disk image</span></div>
<div class="line"><span class="keyword">static</span>   uint32_t block_buf[    512/4];         <span class="comment">// Buffer for block read/write to media</span></div>
<div class="line"><span class="keyword">extern</span></div>
<div class="line"><span class="keyword">const</span>    uint8_t  memory_disk_image[4096];      <span class="comment">// Dummy Memory Disk Image</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called during USBD_Initialize to initialize all Logical Units of the USB MSC class instance.</span></div>
<div class="line"><span class="keywordtype">void</span> USBD_MSC%Instance%_Initialize (<span class="keywordtype">void</span>) {</div>
<div class="line"> </div>
<div class="line">                                        <span class="comment">// Copy the dummy image from code to RAM</span></div>
<div class="line">  memcpy (&amp;memory[0][0], memory_disk_image, <span class="keyword">sizeof</span>(memory_disk_image));</div>
<div class="line">  memcpy (&amp;memory[1][0], memory_disk_image, <span class="keyword">sizeof</span>(memory_disk_image));</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called during USBD_Uninitialize to de-initialize all Logical Units of the USB MSC class instance.</span></div>
<div class="line"><span class="keywordtype">void</span> USBD_MSC%Instance%_Uninitialize (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for de-initialization</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Get cache information.</span></div>
<div class="line"><span class="comment">// \param[out]    buffer               cache buffer address.</span></div>
<div class="line"><span class="comment">// \param[out]    size                 cache buffer size.</span></div>
<div class="line"><span class="comment">// \return        true                 operation succeeded.</span></div>
<div class="line"><span class="comment">// \return        false                operation failed.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_MSC%Instance%_GetCacheInfo (uint32_t *buffer, uint32_t *size) {</div>
<div class="line"> </div>
<div class="line">  *buffer = (uint32_t)block_buf;        <span class="comment">// Local buffer for data</span></div>
<div class="line">  *size   = <span class="keyword">sizeof</span>(block_buf);          <span class="comment">// Size of local buffer</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Get maximum number of logical units.</span></div>
<div class="line"><span class="comment">// \return                             number of logical units that device contains</span></div>
<div class="line"><span class="comment">//                                       - value &gt; 0 and &lt;= 4 : maximum number of logical units</span></div>
<div class="line"><span class="comment">//                                       - value 0 :            use setting from configuration file</span></div>
<div class="line">uint8_t USBD_MSC%Instance%_GetMaxLUN (<span class="keywordtype">void</span>) {</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 2U;                            <span class="comment">// Device contains 2 logical units</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Get media capacity of a logical unit.</span></div>
<div class="line"><span class="comment">// \param[in]     lun                  logical unit number.</span></div>
<div class="line"><span class="comment">// \param[out]    block_count          total number of blocks on media.</span></div>
<div class="line"><span class="comment">// \param[out]    block_size           media block size.</span></div>
<div class="line"><span class="comment">// \return        true                 operation succeeded.</span></div>
<div class="line"><span class="comment">// \return        false                operation failed.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_MSC%Instance%_LUN_GetMediaCapacity (uint8_t lun, uint32_t *block_count, uint32_t *block_size) {</div>
<div class="line"> </div>
<div class="line">  (void)lun;</div>
<div class="line"> </div>
<div class="line">  *block_count =(<span class="keyword">sizeof</span>(memory)/2)/512; <span class="comment">// Total number of blocks on media</span></div>
<div class="line">  *block_size  = 512U;                  <span class="comment">// Block size of blocks on media</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Read data from media of a logical unit.</span></div>
<div class="line"><span class="comment">// \param[in]     lun                  logical unit number.</span></div>
<div class="line"><span class="comment">// \param[in]     lba                  logical address of first block to read.</span></div>
<div class="line"><span class="comment">// \param[in]     cnt                  number of contiguous blocks to read from media.</span></div>
<div class="line"><span class="comment">// \param[out]    buf                  data buffer for data read from media.</span></div>
<div class="line"><span class="comment">// \return        true                 read succeeded.</span></div>
<div class="line"><span class="comment">// \return        false                read failed.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_MSC%Instance%_LUN_Read (uint8_t lun, uint32_t lba, uint32_t cnt, uint8_t *buf) {</div>
<div class="line"> </div>
<div class="line">                                        <span class="comment">// Read data from dummy image in RAM</span></div>
<div class="line">  memcpy (buf, &amp;memory[lun][lba * (512U/4U)], cnt * 512U);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Write data to media of a logical unit.</span></div>
<div class="line"><span class="comment">// \param[in]     lun                  logical unit number.</span></div>
<div class="line"><span class="comment">// \param[in]     lba                  logical address of first block to write.</span></div>
<div class="line"><span class="comment">// \param[in]     cnt                  number of contiguous blocks to write to media.</span></div>
<div class="line"><span class="comment">// \param[out]    buf                  data buffer containing data to write to media.</span></div>
<div class="line"><span class="comment">// \return        true                 write succeeded.</span></div>
<div class="line"><span class="comment">// \return        false                write failed.</span></div>
<div class="line"><span class="keywordtype">bool</span> USBD_MSC%Instance%_LUN_Write (uint8_t lun, uint32_t lba, uint32_t cnt, <span class="keyword">const</span> uint8_t *buf) {</div>
<div class="line"> </div>
<div class="line">                                        <span class="comment">// Write data to image in RAM</span></div>
<div class="line">  memcpy (&amp;memory[lun][lba * (512U/4U)], buf, cnt * 512U);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Check media presence and write protect status of a logical unit.</span></div>
<div class="line"><span class="comment">//        (if media is not owned by USB it returns that media is not ready)</span></div>
<div class="line"><span class="comment">// \param[in]     lun                  logical unit number.</span></div>
<div class="line"><span class="comment">// \return                             media presence and write protected status</span></div>
<div class="line"><span class="comment">//                bit 1:               write protect bit</span></div>
<div class="line"><span class="comment">//                 - value 1:            media is write protected</span></div>
<div class="line"><span class="comment">//                 - value 0:            media is not write protected</span></div>
<div class="line"><span class="comment">//                bit 0:               media presence bit</span></div>
<div class="line"><span class="comment">//                 - value 1:            media is present</span></div>
<div class="line"><span class="comment">//                 - value 0:            media is not present</span></div>
<div class="line">uint32_t USBD_MSC%Instance%_LUN_CheckMedia (uint8_t lun) {</div>
<div class="line"> </div>
<div class="line">  (void)lun;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <a class="code hl_define" href="rl__usb_8h.html#a482c47f8c79666788aa9102db241a251" title="USB Device MSC Check Media bit masks.">USBD_MSC_MEDIA_READY</a>;</div>
<div class="line">}<span class="comment"></span></div>
<div class="line"><span class="comment">//! [code_USBD_User_MSC_LUN]</span></div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
      <script type="text/javascript">
        <!--
        writeFooter.call(this);
        //-->
      </script> 
    </li>
  </ul>
</div>
</body>
</html>
